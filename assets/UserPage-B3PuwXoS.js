import{Q as pe}from"./QImg-CYPg6mZF.js";import{V as H,r as x,m as X,X as T,Y as I,ad as ve,Z as b,$ as s,a0 as le,a9 as W,aa as se,_,a6 as B,ab as oe,aq as ie,ac as ge,a7 as ye,Q as K,ar as P,f as Z,B as j,q as D,M as be,h as Y,n as re,ai as we,as as he,w as N,u as _e,at as ee,au as xe,W as Ve,a1 as R,a4 as z,C as A,av as Se,a5 as ke}from"./index-D6UKDq1U.js";import{Q as Ae}from"./QBtnToggle-DzsF_VeV.js";import{Q as Ce,a as Me,b as je}from"./QItem-xxmC7eH8.js";import{Q as ue}from"./QSelect-DOkdh-LA.js";import{u as de,g as Ie}from"./use-quasar-Dx51jOUa.js";import{Q as Oe}from"./QForm-CeqMOs3g.js";import{C as Qe}from"./ClosePopup-OaVwdFQ-.js";import{u as ce}from"./addressesStore-hYtXly-h.js";import{u as Pe}from"./usersStore-DQqQMpQL.js";import{V as S,s as ze,i as te,t as $,c as ae}from"./vue-yandex-maps-CPNpDjf4.js";import{u as $e}from"./usePermissionVisibility.hook-C_9QU5PD.js";import"./QMenu-BBBj3sTs.js";import"./rtl-DFPa-2ov.js";import"./format-CJebrXOQ.js";const Ue={class:"row q-pl-sm flex-center justify-between"},Ye={class:"text-grey-6"},qe=H({__name:"AddAddressModal",props:{newAddress:{}},setup(e){const a=[[55.97,37.12],[56.02,37.33]],o=e,t=de(),i=ce(),h=x(!0),v=x(),c=x({address_line:"",area_id:null,comment:"",is_default:!1}),w=x([]),V=x(!1),g=x("Начните вводить адрес...");X(async()=>{try{c.value=o.newAddress??{address_line:"",area_id:null,comment:"",is_default:!1},t.loading.show();const p=await i.fetchDeliveryZones();p&&(i.deliveryZones=p)}catch(p){console.error(p)}finally{t.loading.hide()}});async function C(){if(c.value)try{await(c.value?.id?i.updateAddress:i.createAddress)(c.value),v.value?.hide()}catch(p){console.error(p)}}async function m(p,r){if(!p){g.value="Начните вводить адрес...",r(()=>{w.value=[]});return}const y=window.ymaps;if(!y){t.notify({message:"Сервис карт недоступен.",type:"negative"});return}V.value=!0;try{const u=(await y.geocode(p,{boundedBy:a,results:5,strictBounds:!0})).geoObjects.toArray().map(l=>({coords:l.geometry.getCoordinates(),displayName:l.properties.get("text")}));r(()=>{w.value=u,g.value=u.length?"Выберите адрес из списка":"Адрес не найден"})}catch(M){console.error("Ошибка геокодирования:",M)}finally{V.value=!1}}return(p,r)=>(I(),T(ve,{ref_key:"dialogRef",ref:v,modelValue:h.value,"onUpdate:modelValue":r[4]||(r[4]=y=>h.value=y),persistent:""},{default:b(()=>[s(le,{class:""},{default:b(()=>[s(Oe,{greedy:"",onSubmit:r[3]||(r[3]=y=>C())},{default:b(()=>[c.value?(I(),T(se,{key:0},{default:b(()=>[r[5]||(r[5]=_("div",{class:"text-h6"},"Создание нового адреса доставки",-1)),s(ue,{modelValue:c.value.address_line,"onUpdate:modelValue":r[0]||(r[0]=y=>c.value.address_line=y),class:"q-mb-sm",clearable:"",outlined:"",behavior:"menu","use-input":"","emit-value":"","map-options":"",options:w.value,"option-label":"displayName","option-value":"displayName",label:"Адрес доставки",onFilter:m},{"no-option":b(()=>[_("div",Ue,[_("div",Ye,B(g.value),1)])]),_:1},8,["modelValue","options"]),s(oe,{modelValue:c.value.comment,"onUpdate:modelValue":r[1]||(r[1]=y=>c.value.comment=y),label:"Комментарий",outlined:"",type:"textarea",rows:"3"},null,8,["modelValue"]),s(ie,{modelValue:c.value.is_default,"onUpdate:modelValue":r[2]||(r[2]=y=>c.value.is_default=y),label:"Активный аддрес"},null,8,["modelValue"])]),_:1})):W("",!0),s(ge,{align:"right"},{default:b(()=>[ye(s(K,{color:"red",flat:"",label:"Отмена"},null,512),[[Qe]]),s(K,{color:"primary",flat:"",label:"Сохранить",type:"submit"})]),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue"]))}}),G=e=>e instanceof Date,Ne=e=>Object.keys(e).length===0,F=e=>e!=null&&typeof e=="object",ne=(e,...a)=>Object.prototype.hasOwnProperty.call(e,...a),E=e=>F(e)&&Ne(e),Be=()=>Object.create(null),me=(e,a)=>{if(e===a)return{};if(!F(e)||!F(a))return a;const o=Object.keys(e).reduce((t,i)=>(ne(a,i)||(t[i]=void 0),t),Be());return G(e)||G(a)?e.valueOf()==a.valueOf()?{}:a:Object.keys(a).reduce((t,i)=>{if(!ne(e,i))return t[i]=a[i],t;const h=me(e[i],a[i]);return E(h)&&!G(h)&&(E(e[i])||!E(a[i]))||(t[i]=h),t},o)};function Te(){re()||$({text:"injectMap must be only called on runtime.",isInternal:!0});const e=we("map");return(!e||!he(e))&&$({text:"Was not able to inject valid map in injectMap.",isInternal:!0}),e}async function Le({map:e,timeoutCallback:a,waitDuration:o}={}){!e&&!re()&&$({text:"onMapInit must be only called on runtime.",isInternal:!0}),typeof window>"u"&&$({text:"waitTillMapInit cannot be called on SSR.",isInternal:!0});const t=e||Te();if(!t.value)return new Promise((i,h)=>{let v;o=typeof o<"u"?o:S.settings.value.mapsRenderWaitDuration,o!==!1&&(v=setTimeout(()=>{a?.(v,!0),h(new S.YandexMapException("Was not able to wait for map initialization in waitTillMapInit. You can change this behavior by using mapsRenderWaitDuration."))},typeof o=="number"?o:5e3),a?.(v,!1));let c;c=j(t,()=>{t.value&&(c?.(),v&&(clearTimeout(v),a?.(v,!0)),i())},{immediate:!0})})}const De=H({name:"YandexMap",props:{modelValue:{type:Object,default:null},value:{type:Object,default:null},tag:{type:String,default:"div"},width:{type:String,default:"100%"},height:{type:String,default:"100%"},zIndex:{type:Number,default:0},settings:{type:Object,required:!0},readonlySettings:{type:Boolean,default:!1},realSettingsLocation:{type:Boolean,default:!1},layers:{type:Array,default:(()=>[])},cursorGrab:{type:Boolean,default:!1}},emits:{input(e){return!e||typeof ymaps3>"u"||e instanceof ymaps3.YMap},"update:modelValue"(e){return!e||typeof ymaps3>"u"||e instanceof ymaps3.YMap}},slots:Object,setup(e,{slots:a,emit:o}){const t=P(null),i=P(null),h=P([]),v=P(null),c=P(null),w=P(!1),V=x(0);N("map",t),N("layers",h),N("projection",v),N("needsToHold",V),o("input",null),o("update:modelValue",null);const g=Z(()=>({...e.settings,projection:void 0})),C=async()=>{e.settings.location||$({text:"You must specify location in YandexMap settings"}),t.value&&t.value.destroy();const u=c.value;if(!u)return;const l=g.value;v.value&&(l.projection=v.value),t.value=new ymaps3.YMap(u,l,[...h.value,...e.layers]),o("input",t.value),o("update:modelValue",t.value)};let m,p,r=null;async function y(){await Le({map:t,timeoutCallback:(u,l)=>{l?r=null:r=u}}).catch(()=>{}),t.value&&(e.cursorGrab?(m=new ymaps3.YMapListener({onActionStart:u=>{u.type==="drag"&&e.cursorGrab&&i.value?.classList.add("__ymap--grabbing")},onActionEnd:u=>{u.type==="drag"&&i.value?.classList.remove("__ymap--grabbing")}}),t.value.addChild(m)):m&&t.value.removeChild(m))}let M=!1;return j(S.loadStatus,async u=>{if(u==="pending"){M=!0,w.value=!1;return}u!=="loaded"&&!M||(w.value=!0,await D(),V.value&&await new Promise(l=>j(V,()=>{V.value||l()},{immediate:!0})),await C())}),X(async()=>{const u=()=>{p?.();let l=ae(g);p=j(g,O=>{if(!t.value)return;const k=ae(O);e.realSettingsLocation&&k.location&&("center"in k.location&&"center"in l.location?l.location.center=t.value.center:"bounds"in k.location&&"bounds"in l.location&&(l.location.bounds=t.value.bounds),"zoom"in k.location&&"zoom"in l.location&&(l.location.zoom=t.value.zoom));const q=Object.keys(me(l,k));if(q.length===0)return;const U={...k};for(const Q in U)q.includes(Q)||delete U[Q];l=k,t.value?.update(U)},{deep:!0})};if(e.readonlySettings||u(),j(()=>e.readonlySettings,l=>{l?u():p?.()}),j(()=>e.cursorGrab,y,{immediate:!0}),await ze(),!S.isLoaded.value){if(S.settings.value.initializeOn==="onComponentMount")try{await te()}catch(l){console.error("An error occured while initializing Yandex Map with onComponentMount setting"),console.error(l);return}else(S.loadStatus.value==="loading"||S.settings.value.initializeOn==="onPluginInit")&&(S.settings.value.initializeOn==="onPluginInit"&&S.loadStatus.value!=="loading"&&await D(),await te());S.isLoaded.value||$({text:"You have set up <yandex-map> component without initializing Yandex maps. Please check initializeOn setting or call initYmaps manually before registering this component."})}w.value=!0,await D(),V.value&&await new Promise(l=>j(V,()=>{V.value||l()},{immediate:!0})),await C()}),be(()=>{r&&clearTimeout(r),t.value&&t.value.destroy(),t.value=null,o("input",t.value),o("update:modelValue",t.value)}),()=>{const u={class:["__ymap",{"__ymap--grab":e.cursorGrab}],ref:i,style:{width:e.width,height:e.height,"z-index":e.zIndex.toString()}},l=Y("div",{class:"__ymap_container",ref:c}),O={class:"__ymap_slots",style:{display:"none"}};return w.value?Y(e.tag,u,[l,Y("div",O,a.default?.({}))]):Y(e.tag,u,[l,Y("div",O)])}}}),Re={class:"q-pa-sm"},Ge={class:"justify-center row q-mb-md"},Ee={class:"text-h5 justify-between q-mb-sm row"},We={class:"items-center"},Ze={class:"items-center"},Fe={key:0,class:"row items-center q-mb-sm text-h6"},He={style:{height:"40px"},class:"col-10 content-center"},Xe={key:1,class:"row items-center q-mb-sm"},Je={class:"row items-center q-mb-sm"},pt=H({__name:"UserPage",setup(e){const a=de(),o=ce(),t=Pe(),i=_e(),h=Z(()=>ee.isActive),{isManagerWithoutIsUser:v}=$e(),c=xe({dark:"dark",light:"light"}),w=x(!1),V=Z(()=>h.value?c.dark:c.light),g=x(!1),C=x("dark"),m=x({addres:null,full_name:"",mail:"",phone:""}),p=x(),r=x(null);X(()=>{m.value=i.user,Q()});function y(f){f.is_default=!0,m.value.addres=f,O(f)}function M(){r.value=null,g.value=!g.value}async function u(f){try{a.loading.show(),await o.deleteAddress(f.id)&&Q()}catch(n){console.error(n)}finally{a.loading.hide()}}function l(f){r.value=f,g.value=!g.value}async function O(f){try{a.loading.show(),await o.updateAddress(f)&&Q()}catch(n){console.error(n)}finally{a.loading.hide()}}const k=()=>{ee.toggle(),window.localStorage.setItem("theme",V.value)};function q(){a.dialog({cancel:!0,message:"Вы уверенны что хотите изменить номер?",persistent:!0,title:"Смена номера телефона"}).onOk(()=>{U()})}async function U(){m.value.phone=p.value;try{a.loading.show(),await t.updateMyPhone(m.value.phone)}catch(f){console.error(f)}finally{a.loading.hide()}}async function Q(){try{a.loading.show();const f=await o.fetchAddresses();if(f){o.addresses=f;const n=f.find(L=>L.is_default===!0);n&&(o.addressId=n.id)}}catch(f){console.error(f)}finally{a.loading.hide()}}async function fe(){try{a.loading.show(),await t.updateUserMode(m.value.id)}catch(f){console.error(f)}finally{a.loading.hide()}}return(f,n)=>{const L=Ve("q-item-action");return I(),R("div",null,[n[11]||(n[11]=_("h6",{class:"text-center q-mb-md"},"Личный кабинет",-1)),_("div",Re,[s(le,{class:"my-card full-height",flat:"",bordered:""},{default:b(()=>[s(se,null,{default:b(()=>[_("div",Ge,[s(pe,{class:"radius-100",height:"120px",width:"120px",src:m.value?.main_image_url?m.value.main_image_url:z(Ie)("/card-shop.jpg")},null,8,["src"])]),_("div",Ee,[_("div",null,B(m.value.full_name),1),_("div",null,[s(Ae,{modelValue:C.value,"onUpdate:modelValue":n[0]||(n[0]=d=>C.value=d),size:"sm","no-caps":"",unelevated:"",dense:"","toggle-color":"grey-9",color:"white","text-color":"grey-9",options:[{value:"dark",slot:"dark",title:"Dark mode"},{value:"light",slot:"light",title:"Light mode"}],onClick:n[1]||(n[1]=d=>k())},{dark:b(()=>[_("div",We,[s(A,{name:"nightlight"})])]),light:b(()=>[_("div",Ze,[s(A,{name:"light_mode"})])]),_:1},8,["modelValue"])])]),!w.value&&m.value?.phone?(I(),R("div",Fe,[_("div",He,B(m.value.phone),1),s(A,{name:"edit",size:"30px",color:"green",class:"col-2",onClick:n[2]||(n[2]=d=>w.value=!w.value)})])):(I(),R("div",Xe,[s(A,{name:"close",size:"30px",color:"red",class:"col-1",onClick:n[3]||(n[3]=d=>w.value=!w.value)}),s(oe,{modelValue:p.value,"onUpdate:modelValue":n[4]||(n[4]=d=>p.value=d),class:"col-9",dense:"",outlined:"",label:"Телефон",mask:"+# (###) ###-##-##",type:"tel"},null,8,["modelValue"]),s(A,{name:"save",size:"30px",color:"green",class:"col-2",onClick:n[5]||(n[5]=d=>q())})])),_("div",Je,[s(ue,{modelValue:z(o).addressId,"onUpdate:modelValue":n[6]||(n[6]=d=>z(o).addressId=d),options:z(o).addresses,class:"col-10",dense:"",outlined:"",label:"Адрес","emit-value":"","map-options":"","option-label":"address_line","option-value":"id"},{option:b(d=>[s(Ce,Se(d.itemProps,{class:"justify-between flex"}),{default:b(()=>[s(Me,{onClick:J=>y(d.opt)},{default:b(()=>[s(je,null,{default:b(()=>[ke(B(d.opt?.address_line),1)]),_:2},1024)]),_:2},1032,["onClick"]),s(L,null,{default:b(()=>[s(A,{class:"q-mr-sm",color:"red",name:"delete",size:"26px",onClick:J=>u(d.opt)},null,8,["onClick"]),s(A,{color:"green",name:"edit",size:"26px",onClick:J=>l(d.opt)},null,8,["onClick"])]),_:2},1024)]),_:2},1040)]),_:1},8,["modelValue","options"]),s(A,{name:"add",size:"34px",color:"green",class:"col-2",onClick:n[7]||(n[7]=d=>M())})])]),_:1})]),_:1}),s(z(De)),z(v)?(I(),T(ie,{key:0,modelValue:m.value.is_user,"onUpdate:modelValue":n[8]||(n[8]=d=>m.value.is_user=d),color:"green",label:m.value.is_user?"Пользователь":"Администратор",onClick:n[9]||(n[9]=d=>fe())},null,8,["modelValue","label"])):W("",!0)]),g.value?(I(),T(qe,{key:0,modelValue:g.value,"onUpdate:modelValue":n[10]||(n[10]=d=>g.value=d),newAddress:r.value},null,8,["modelValue","newAddress"])):W("",!0)])}}});export{pt as default};
