import{Q as E,a as G}from"./QUploader-Dh4MaUNy.js";import{d as J,ab as T,aa as H,u as K,r as V,c as W,o as X,ad as d,ae as r,ai as n,f as l,aj as q,ak as s,al as m,a9 as x,af as k,ag as c,aB as v,U as h,av as P,ah as Y,aG as C}from"./index-Djkm3zme.js";import{Q as U}from"./QSelect-DNHoqS9p.js";import{Q as Z}from"./QForm-zIXkxfsE.js";import{C as D}from"./ClosePopup-DqIBm_1M.js";import{u as ee}from"./use-quasar-CcK_rPTO.js";import{u as ae}from"./productsStore-B4sAVTUw.js";import{P as Q}from"./ProductImgCarusel-CzJfKaXJ.js";import{u as te}from"./usePermissionVisibility.hook-j3cw2fap.js";import{u as oe}from"./categoriesStore-BLEC_anc.js";import{u as le}from"./unitsStore-Tba4zOVa.js";import{e as se}from"./orderStore-Bq7H28pc.js";import{f as ie,r as f}from"./useUtils-DqW0zkjO.js";import{_ as re}from"./_plugin-vue_export-helper-DlAUqK2U.js";import"./format-CJebrXOQ.js";import"./QItem-Cjcxivxx.js";import"./QMenu-CkZWb_Gl.js";import"./rtl-DFPa-2ov.js";const ne={class:"q-pa-md product"},ue={key:0},de={class:"text-h6 q-mb-md"},me={class:"text-center upload-title"},pe={class:"row justify-end"},ce={key:1},ve={class:"q-mb-sm"},fe={key:0,class:"q-my-md"},ge={key:1,class:"text-grey old-price"},ye={key:2,class:"q-pa-md bg-light-gray radius-16"},_e={class:"row justify-end"},be={key:1,class:"row"},Ve={class:"bg-green q-pa-xs radius-100"},qe={class:"q-mx-sm self-center"},xe={class:"bg-green q-pa-xs radius-100"},ke=J({__name:"ProductPage",emits:["refresh-data","add-product"],setup(Se,{emit:F}){const u=ee(),R=F,S=T(),B=H(),g=ae(),I=K(),$=oe(),y=se(),z=le(),_=V(),{isManager:j}=te(W(()=>I.user)),e=V({id:null,name:"",price:null,category_id:null,unit_id:null,qty:null,description:"",images:"",origin_country:"",unit:null}),p=V([]),i=new FormData;X(()=>{b()});function A(o){const a=p.value.findIndex(t=>t.id===o);p.value.splice(a,1),y.basketData.splice(a,1)}function w(o){try{u.loading.show(),p.value.push(structuredClone(C(o))),y.basketData.push(structuredClone(C(o))),window.localStorage.setItem("basket",JSON.stringify(y.basketData))}catch(a){console.error(a)}finally{u.loading.hide()}}async function N(){try{let o=null;e.value?.id?o=g.updateProduct(e.value):(O(),o=await g.createProduct(i)),o&&(e.value.id=o.id,u.notify({message:"Успешно сохранено",color:"primary"}),R("refresh-data"),B.back())}catch(o){console.error(o)}}function O(){e?.value?.id&&i.append("id",e.value.id.toString()),e.value?.name&&i.append("name",e.value.name),e.value?.price&&i.append("price",e.value.price.toString()),e.value?.category_id&&i.append("category_id",e.value.category_id.toString()),e.value?.unit_id&&i.append("unit_id",e.value.unit_id.toString()),e.value?.qty&&i.append("qty",e.value.qty.toString()),e.value?.description&&i.append("description",e.value.description),e.value?.origin_country&&i.append("origin_country",e.value.origin_country)}function L(o){const a=new FileReader;a.readAsDataURL(o[0]),a.onload=()=>{},i.append("images",o[0]),e.value?.id&&M(o[0])}async function M(o){const a=new FormData;a.append("file",o),a.append("is_primary","true");try{await g.uploadFile(e.value.id,a)&&(b(),u.notify({message:"Картинка успешно добавлена",color:"primary"}))}catch(t){console.error(t)}finally{_.value&&_.value.reset()}}async function b(){if(S?.params?.id)try{u.loading.show();const o=await g.fetchProductsById(+S.params.id);o&&(e.value=o)}catch(o){console.error(o)}finally{u.loading.hide()}}return(o,a)=>(r(),d("div",ne,[n(j)?(r(),d("div",ue,[l(Z,{greedy:"",onSubmit:a[9]||(a[9]=t=>N())},{default:q(()=>[s("div",de,m(e.value.id?"Редактирование товара":"Добавление товара"),1),l(E,{ref_key:"uploaderRef",ref:_,color:"primary",flat:"","max-file-size":"15728640",onAdded:L,onRejected:a[0]||(a[0]=t=>n(ie)(n(u)))},{header:q(()=>[...a[13]||(a[13]=[])]),list:q(()=>[l(G),s("div",me,[l(x,{class:"q-mr-sm",name:"note_add",size:"24px"}),a[14]||(a[14]=s("span",null,"Загрузить картинку",-1))])]),_:1},512),s("div",null,[e.value?.images?.length?(r(),k(Q,{key:0,onRefreshData:a[1]||(a[1]=t=>b()),images:e.value.images},null,8,["images"])):c("",!0)]),l(v,{rules:[n(f)],modelValue:e.value.name,"onUpdate:modelValue":a[2]||(a[2]=t=>e.value.name=t),class:"q-mb-xs",outlined:"",label:"Наименование товара *"},null,8,["rules","modelValue"]),l(v,{rules:[n(f)],modelValue:e.value.price,"onUpdate:modelValue":a[3]||(a[3]=t=>e.value.price=t),class:"q-mb-xs",outlined:"",label:"Стоимость товара *"},null,8,["rules","modelValue"]),l(v,{rules:[n(f)],modelValue:e.value.qty,"onUpdate:modelValue":a[4]||(a[4]=t=>e.value.qty=t),class:"q-mb-xs",outlined:"",label:"Количество *"},null,8,["rules","modelValue"]),l(v,{modelValue:e.value.origin_country,"onUpdate:modelValue":a[5]||(a[5]=t=>e.value.origin_country=t),class:"q-mb-xs",outlined:"",label:"Страна происхождения"},null,8,["modelValue"]),l(U,{rules:[n(f)],modelValue:e.value.category_id,"onUpdate:modelValue":a[6]||(a[6]=t=>e.value.category_id=t),options:n($).categories,class:"q-mb-xs",outlined:"",label:"Категория *","emit-value":"","map-options":"","option-label":"name","option-value":"id"},null,8,["rules","modelValue","options"]),l(U,{rules:[n(f)],modelValue:e.value.unit_id,"onUpdate:modelValue":a[7]||(a[7]=t=>e.value.unit_id=t),options:n(z).units,outlined:"",label:"Единица измерения *","emit-value":"","map-options":"","option-label":"name","option-value":"id"},null,8,["rules","modelValue","options"]),l(v,{class:"q-mt-sm q-mb-sm",modelValue:e.value.description,"onUpdate:modelValue":a[8]||(a[8]=t=>e.value.description=t),outlined:"",type:"textarea",rows:"2",label:"Описание"},null,8,["modelValue"]),s("div",pe,[h(l(P,{color:"green",label:"Подтвердить",type:"submit"},null,512),[[D]])])]),_:1})])):(r(),d("div",ce,[e.value?.images?.length?(r(),k(Q,{key:0,images:e.value.images},null,8,["images"])):c("",!0),s("div",ve,[e.value?.name?(r(),d("h6",fe,m(e.value.name),1)):c("",!0),e.value?.old_price?(r(),d("div",ge,m(e.value.old_price)+" ₽",1)):c("",!0),s("div",{class:Y(["text-bold text-18 q-mb-md",e.value?.old_price?"text-red":""])},m(e.value.price)+" ₽/ "+m(e.value.unit_name),3),e.value.description?(r(),d("div",ye,m(e.value.description),1)):c("",!0)]),s("div",_e,[p.value?.length?(r(),d("div",be,[s("div",Ve,[l(x,{name:"remove",color:"white",size:"30px",onClick:a[11]||(a[11]=t=>A(e.value.id))})]),s("span",qe,m(p.value?.length),1),s("div",xe,[l(x,{name:"add",color:"white",size:"30px",onClick:a[12]||(a[12]=t=>w(e.value))})])])):h((r(),k(P,{key:0,color:"green",label:"Добавить в корзину",onClick:a[10]||(a[10]=t=>w(e.value))},null,512)),[[D]])])]))]))}}),Me=re(ke,[["__scopeId","data-v-505dd4f9"]]);export{Me as default};
