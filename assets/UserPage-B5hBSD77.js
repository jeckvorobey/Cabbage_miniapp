import{Q as W}from"./QImg-CHpEyEiK.js";import{d as z,r as c,o as j,aj as D,ae as y,aF as J,af as n,f as s,aI as L,as as E,aG as O,aq as i,am as S,av as R,aP as K,aH as X,W as Y,ah as P,u as ee,c as B,aE as M,aw as se,ar as te,ad as I,ak as C,a6 as f,aD as ae,al as le}from"./index-BPf8tPax.js";import{Q as oe}from"./QBtnToggle-BvmM5DjN.js";import{Q as ne,a as de,b as re}from"./QItem-BKq4pLQj.js";import{Q as T}from"./QSelect-B4dvupOC.js";import{u as F}from"./use-quasar-yb71fDYP.js";import{Q as ie}from"./QForm-JhLumikp.js";import{C as ue}from"./ClosePopup-BRjy_Mtu.js";import{u as Z}from"./addressesStore-CUyCEtd4.js";import{g as me}from"./useUtils-B4VB24R6.js";import{u as ce}from"./usersStore-gxCm2mYK.js";import"./QBtnGroup-BajZSoDN.js";import"./QMenu-Dmlvh8jF.js";import"./rtl-DFPa-2ov.js";import"./format-CJebrXOQ.js";const pe={class:"row q-pl-sm flex-center justify-between"},ve={class:"text-grey-6"},fe=z({__name:"AddAddressModal",props:{newAddress:{}},setup(U){const m=[[55.97,37.12],[56.02,37.33]],p=U,_=F(),g=Z(),V=c(!0),w=c(),l=c({address_line:"",area_id:null,comment:"",is_default:!1}),k=c([]),v=c(!1),h=c("Начните вводить адрес...");j(async()=>{try{l.value=p.newAddress??{address_line:"",area_id:null,comment:"",is_default:!1},_.loading.show();const d=await g.fetchDeliveryZones();d&&(g.deliveryZones=d)}catch(d){console.error(d)}finally{_.loading.hide()}});async function u(){if(l.value)try{await(l.value?.id?g.updateAddress:g.createAddress)(l.value),w.value?.hide()}catch(d){console.error(d)}}async function b(d,o){if(!d){h.value="Начните вводить адрес...",o(()=>{k.value=[]});return}const r=window.ymaps;if(!r){_.notify({message:"Сервис карт недоступен.",type:"negative"});return}v.value=!0;try{const x=(await r.geocode(d,{boundedBy:m,results:5,strictBounds:!0})).geoObjects.toArray().map(Q=>({coords:Q.geometry.getCoordinates(),displayName:Q.properties.get("text")}));o(()=>{k.value=x,h.value=x.length?"Выберите адрес из списка":"Адрес не найден"})}catch(A){console.error("Ошибка геокодирования:",A)}finally{v.value=!1}}return(d,o)=>(y(),D(J,{ref_key:"dialogRef",ref:w,modelValue:V.value,"onUpdate:modelValue":o[4]||(o[4]=r=>V.value=r),persistent:""},{default:n(()=>[s(L,{class:""},{default:n(()=>[s(ie,{greedy:"",onSubmit:o[3]||(o[3]=r=>u())},{default:n(()=>[l.value?(y(),D(O,{key:0},{default:n(()=>[o[5]||(o[5]=i("div",{class:"text-h6"},"Создание нового адреса доставки",-1)),s(T,{modelValue:l.value.address_line,"onUpdate:modelValue":o[0]||(o[0]=r=>l.value.address_line=r),class:"q-mb-sm",clearable:"",outlined:"","use-input":"","emit-value":"","map-options":"",options:k.value,"option-label":"displayName","option-value":"displayName",label:"Адрес доставки",onFilter:b},{"no-option":n(()=>[i("div",pe,[i("div",ve,S(h.value),1)])]),_:1},8,["modelValue","options"]),s(R,{modelValue:l.value.comment,"onUpdate:modelValue":o[1]||(o[1]=r=>l.value.comment=r),label:"Комментарий",outlined:"",type:"textarea",rows:"3"},null,8,["modelValue"]),s(K,{modelValue:l.value.is_default,"onUpdate:modelValue":o[2]||(o[2]=r=>l.value.is_default=r),label:"Активный аддрес"},null,8,["modelValue"])]),_:1})):E("",!0),s(X,{align:"right"},{default:n(()=>[Y(s(P,{color:"red",flat:"",label:"Отмена"},null,512),[[ue]]),s(P,{color:"primary",flat:"",label:"Сохранить",type:"submit"})]),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue"]))}}),ge={class:"q-pa-sm"},he={class:"justify-center row q-mb-md"},ye={class:"text-h5 justify-between q-mb-sm row"},_e={class:"items-center"},we={class:"items-center"},ke={key:0,class:"row items-center q-mb-sm text-h6"},be={style:{height:"40px"},class:"col-10 content-center"},Ve={key:1,class:"row items-center q-mb-sm"},Ae={class:"row items-center q-mb-sm"},Le=z({__name:"UserPage",setup(U){const m=F(),p=Z(),_=ce(),g=ee(),V=B(()=>M.isActive),w=se({dark:"dark",light:"light"}),l=c(!1),k=B(()=>V.value?w.dark:w.light),v=c(!1),h=c("dark"),u=c({addres:null,full_name:"",mail:"",phone:""}),b=c(null);j(()=>{u.value=g.user,$()});function d(t){t.is_default=!0,u.value.addres=t,x(t)}function o(){b.value=null,v.value=!v.value}async function r(t){try{m.loading.show(),await p.deleteAddress(t.id)&&$()}catch(e){console.error(e)}finally{m.loading.hide()}}function A(t){b.value=t,v.value=!v.value}async function x(t){try{m.loading.show(),await p.updateAddress(t)&&$()}catch(e){console.error(e)}finally{m.loading.hide()}}const Q=()=>{M.toggle(),window.localStorage.setItem("theme",k.value)};function G(){m.dialog({cancel:!0,message:"Вы уверенны что хотите изменить номер?",persistent:!0,title:"Смена номера телефона"}).onOk(()=>{H()})}async function H(){try{m.loading.show(),await _.updateMyPhone(u.value.phone)}catch(t){console.error(t)}finally{m.loading.hide()}}async function $(){try{m.loading.show();const t=await p.fetchAddresses();if(t){p.addresses=t;const e=t.find(q=>q.is_default===!0);e&&(p.addressId=e.id)}}catch(t){console.error(t)}finally{m.loading.hide()}}return(t,e)=>{const q=te("q-item-action");return y(),I("div",null,[e[9]||(e[9]=i("h6",{class:"text-center q-mb-md"},"Личный кабинет",-1)),i("div",ge,[s(L,{class:"my-card full-height",flat:"",bordered:""},{default:n(()=>[s(O,null,{default:n(()=>[i("div",he,[s(W,{class:"radius-100",height:"120px",width:"120px",src:u.value?.main_image_url?u.value.main_image_url:C(me)("/card-shop.jpg")},null,8,["src"])]),i("div",ye,[i("div",null,S(u.value.full_name),1),i("div",null,[s(oe,{modelValue:h.value,"onUpdate:modelValue":e[0]||(e[0]=a=>h.value=a),size:"sm","no-caps":"",unelevated:"",dense:"","toggle-color":"grey-9",color:"white","text-color":"grey-9",options:[{value:"dark",slot:"dark",title:"Dark mode"},{value:"light",slot:"light",title:"Light mode"}],onClick:e[1]||(e[1]=a=>Q())},{dark:n(()=>[i("div",_e,[s(f,{name:"nightlight"})])]),light:n(()=>[i("div",we,[s(f,{name:"light_mode"})])]),_:1},8,["modelValue"])])]),!l.value&&u.value?.phone?(y(),I("div",ke,[i("div",be,S(u.value.phone),1),s(f,{name:"edit",size:"30px",color:"green",class:"col-2",onClick:e[2]||(e[2]=a=>l.value=!l.value)})])):(y(),I("div",Ve,[s(f,{name:"close",size:"30px",color:"red",class:"col-1",onClick:e[3]||(e[3]=a=>l.value=!l.value)}),s(R,{modelValue:u.value.phone,"onUpdate:modelValue":e[4]||(e[4]=a=>u.value.phone=a),class:"col-9",dense:"",outlined:"",label:"Телефон",mask:"+# (###) ###-##-##",type:"tel"},null,8,["modelValue"]),s(f,{name:"save",size:"30px",color:"green",class:"col-2",onClick:e[5]||(e[5]=a=>G())})])),i("div",Ae,[s(T,{modelValue:C(p).addressId,"onUpdate:modelValue":e[6]||(e[6]=a=>C(p).addressId=a),options:C(p).addresses,class:"col-10",dense:"",outlined:"",label:"Адрес","emit-value":"","map-options":"","option-label":"address_line","option-value":"id"},{option:n(a=>[s(ne,ae(a.itemProps,{class:"justify-between flex"}),{default:n(()=>[s(de,{onClick:N=>d(a.opt)},{default:n(()=>[s(re,null,{default:n(()=>[le(S(a.opt?.address_line),1)]),_:2},1024)]),_:2},1032,["onClick"]),s(q,null,{default:n(()=>[s(f,{class:"q-mr-sm",color:"red",name:"delete",size:"26px",onClick:N=>r(a.opt)},null,8,["onClick"]),s(f,{color:"green",name:"edit",size:"26px",onClick:N=>A(a.opt)},null,8,["onClick"])]),_:2},1024)]),_:2},1040)]),_:1},8,["modelValue","options"]),s(f,{name:"add",size:"34px",color:"green",class:"col-2",onClick:e[7]||(e[7]=a=>o())})])]),_:1})]),_:1})]),v.value?(y(),D(fe,{key:0,modelValue:v.value,"onUpdate:modelValue":e[8]||(e[8]=a=>v.value=a),newAddress:b.value},null,8,["modelValue","newAddress"])):E("",!0)])}}});export{Le as default};
