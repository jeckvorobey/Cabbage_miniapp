import{Q as pe}from"./QImg-BUL6Hm6k.js";import{V as H,r as _,m as X,X as T,Y as Q,ad as ve,Z as y,$ as o,a0 as le,a9 as W,aa as se,_ as w,a6 as B,ab as oe,aq as ie,ac as ge,a7 as ye,Q as K,ar as P,f as Z,B as O,q as R,M as be,h as Y,n as re,ai as he,as as we,w as N,u as _e,at as ee,au as xe,W as Ve,a1 as D,a4 as z,C as j,av as Se,a5 as ke}from"./index-CzvVlkJm.js";import{Q as Ae}from"./QBtnToggle-dF7O59gv.js";import{Q as Ce,a as Me,b as je}from"./QItem-COm4KtQe.js";import{Q as ue}from"./QSelect-fyib9V47.js";import{u as de,g as Ie}from"./use-quasar-DyxdFqbr.js";import{Q as Oe}from"./QForm-3OWiQFa8.js";import{C as Qe}from"./ClosePopup-Bw8GIkKR.js";import{u as ce}from"./addressesStore-Cy7hjc_H.js";import{u as Pe}from"./usersStore-BO68_DrQ.js";import{V as k,s as ze,i as te,t as $,c as ae}from"./vue-yandex-maps-B9HQb5P0.js";import{u as $e}from"./usePermissionVisibility.hook-B48mZyp7.js";import"./QMenu-Cn-XbHXO.js";import"./rtl-DFPa-2ov.js";import"./format-CJebrXOQ.js";const Ue={class:"row q-pl-sm flex-center justify-between"},Ye={class:"text-grey-6"},qe=H({__name:"AddAddressModal",props:{newAddress:{}},emits:["refresh"],setup(e,{emit:n}){const i=[[55.97,37.12],[56.02,37.33]],t=e,d=n,b=de(),p=ce(),V=_(!0),h=_(),c=_({address_line:"",area_id:null,comment:"",is_default:!1}),v=_([]),M=_(!1),r=_("Начните вводить адрес...");X(async()=>{try{c.value=t.newAddress??{address_line:"",area_id:null,comment:"",is_default:!1},b.loading.show();const g=await p.fetchDeliveryZones();g&&(p.deliveryZones=g)}catch(g){console.error(g)}finally{d("refresh"),b.loading.hide()}});async function A(){if(c.value)try{await(c.value?.id?p.updateAddress:p.createAddress)(c.value),h.value?.hide()}catch(g){console.error(g)}}async function S(g,m){if(!g){r.value="Начните вводить адрес...",m(()=>{v.value=[]});return}const l=window.ymaps;if(!l){b.notify({message:"Сервис карт недоступен.",type:"negative"});return}M.value=!0;try{const C=(await l.geocode(g,{boundedBy:i,results:5,strictBounds:!0})).geoObjects.toArray().map(x=>({coords:x.geometry.getCoordinates(),displayName:x.properties.get("text")}));m(()=>{v.value=C,r.value=C.length?"Выберите адрес из списка":"Адрес не найден"})}catch(s){console.error("Ошибка геокодирования:",s)}finally{M.value=!1}}return(g,m)=>(Q(),T(ve,{ref_key:"dialogRef",ref:h,modelValue:V.value,"onUpdate:modelValue":m[4]||(m[4]=l=>V.value=l),persistent:""},{default:y(()=>[o(le,{class:""},{default:y(()=>[o(Oe,{greedy:"",onSubmit:m[3]||(m[3]=l=>A())},{default:y(()=>[c.value?(Q(),T(se,{key:0},{default:y(()=>[m[5]||(m[5]=w("div",{class:"text-h6"},"Создание нового адреса доставки",-1)),o(ue,{modelValue:c.value.address_line,"onUpdate:modelValue":m[0]||(m[0]=l=>c.value.address_line=l),class:"q-mb-sm",clearable:"",outlined:"",behavior:"menu","use-input":"","emit-value":"","map-options":"",options:v.value,"option-label":"displayName","option-value":"displayName",label:"Адрес доставки",onFilter:S},{"no-option":y(()=>[w("div",Ue,[w("div",Ye,B(r.value),1)])]),_:1},8,["modelValue","options"]),o(oe,{modelValue:c.value.comment,"onUpdate:modelValue":m[1]||(m[1]=l=>c.value.comment=l),label:"Комментарий",outlined:"",type:"textarea",rows:"3"},null,8,["modelValue"]),o(ie,{modelValue:c.value.is_default,"onUpdate:modelValue":m[2]||(m[2]=l=>c.value.is_default=l),label:"Активный аддрес"},null,8,["modelValue"])]),_:1})):W("",!0),o(ge,{align:"right"},{default:y(()=>[ye(o(K,{color:"red",flat:"",label:"Отмена"},null,512),[[Qe]]),o(K,{color:"primary",flat:"",label:"Сохранить",type:"submit"})]),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue"]))}}),G=e=>e instanceof Date,Ne=e=>Object.keys(e).length===0,F=e=>e!=null&&typeof e=="object",ne=(e,...n)=>Object.prototype.hasOwnProperty.call(e,...n),E=e=>F(e)&&Ne(e),Be=()=>Object.create(null),me=(e,n)=>{if(e===n)return{};if(!F(e)||!F(n))return n;const i=Object.keys(e).reduce((t,d)=>(ne(n,d)||(t[d]=void 0),t),Be());return G(e)||G(n)?e.valueOf()==n.valueOf()?{}:n:Object.keys(n).reduce((t,d)=>{if(!ne(e,d))return t[d]=n[d],t;const b=me(e[d],n[d]);return E(b)&&!G(b)&&(E(e[d])||!E(n[d]))||(t[d]=b),t},i)};function Te(){re()||$({text:"injectMap must be only called on runtime.",isInternal:!0});const e=he("map");return(!e||!we(e))&&$({text:"Was not able to inject valid map in injectMap.",isInternal:!0}),e}async function Le({map:e,timeoutCallback:n,waitDuration:i}={}){!e&&!re()&&$({text:"onMapInit must be only called on runtime.",isInternal:!0}),typeof window>"u"&&$({text:"waitTillMapInit cannot be called on SSR.",isInternal:!0});const t=e||Te();if(!t.value)return new Promise((d,b)=>{let p;i=typeof i<"u"?i:k.settings.value.mapsRenderWaitDuration,i!==!1&&(p=setTimeout(()=>{n?.(p,!0),b(new k.YandexMapException("Was not able to wait for map initialization in waitTillMapInit. You can change this behavior by using mapsRenderWaitDuration."))},typeof i=="number"?i:5e3),n?.(p,!1));let V;V=O(t,()=>{t.value&&(V?.(),p&&(clearTimeout(p),n?.(p,!0)),d())},{immediate:!0})})}const Re=H({name:"YandexMap",props:{modelValue:{type:Object,default:null},value:{type:Object,default:null},tag:{type:String,default:"div"},width:{type:String,default:"100%"},height:{type:String,default:"100%"},zIndex:{type:Number,default:0},settings:{type:Object,required:!0},readonlySettings:{type:Boolean,default:!1},realSettingsLocation:{type:Boolean,default:!1},layers:{type:Array,default:(()=>[])},cursorGrab:{type:Boolean,default:!1}},emits:{input(e){return!e||typeof ymaps3>"u"||e instanceof ymaps3.YMap},"update:modelValue"(e){return!e||typeof ymaps3>"u"||e instanceof ymaps3.YMap}},slots:Object,setup(e,{slots:n,emit:i}){const t=P(null),d=P(null),b=P([]),p=P(null),V=P(null),h=P(!1),c=_(0);N("map",t),N("layers",b),N("projection",p),N("needsToHold",c),i("input",null),i("update:modelValue",null);const v=Z(()=>({...e.settings,projection:void 0})),M=async()=>{e.settings.location||$({text:"You must specify location in YandexMap settings"}),t.value&&t.value.destroy();const l=V.value;if(!l)return;const s=v.value;p.value&&(s.projection=p.value),t.value=new ymaps3.YMap(l,s,[...b.value,...e.layers]),i("input",t.value),i("update:modelValue",t.value)};let r,A,S=null;async function g(){await Le({map:t,timeoutCallback:(l,s)=>{s?S=null:S=l}}).catch(()=>{}),t.value&&(e.cursorGrab?(r=new ymaps3.YMapListener({onActionStart:l=>{l.type==="drag"&&e.cursorGrab&&d.value?.classList.add("__ymap--grabbing")},onActionEnd:l=>{l.type==="drag"&&d.value?.classList.remove("__ymap--grabbing")}}),t.value.addChild(r)):r&&t.value.removeChild(r))}let m=!1;return O(k.loadStatus,async l=>{if(l==="pending"){m=!0,h.value=!1;return}l!=="loaded"&&!m||(h.value=!0,await R(),c.value&&await new Promise(s=>O(c,()=>{c.value||s()},{immediate:!0})),await M())}),X(async()=>{const l=()=>{A?.();let s=ae(v);A=O(v,C=>{if(!t.value)return;const x=ae(C);e.realSettingsLocation&&x.location&&("center"in x.location&&"center"in s.location?s.location.center=t.value.center:"bounds"in x.location&&"bounds"in s.location&&(s.location.bounds=t.value.bounds),"zoom"in x.location&&"zoom"in s.location&&(s.location.zoom=t.value.zoom));const q=Object.keys(me(s,x));if(q.length===0)return;const U={...x};for(const I in U)q.includes(I)||delete U[I];s=x,t.value?.update(U)},{deep:!0})};if(e.readonlySettings||l(),O(()=>e.readonlySettings,s=>{s?l():A?.()}),O(()=>e.cursorGrab,g,{immediate:!0}),await ze(),!k.isLoaded.value){if(k.settings.value.initializeOn==="onComponentMount")try{await te()}catch(s){console.error("An error occured while initializing Yandex Map with onComponentMount setting"),console.error(s);return}else(k.loadStatus.value==="loading"||k.settings.value.initializeOn==="onPluginInit")&&(k.settings.value.initializeOn==="onPluginInit"&&k.loadStatus.value!=="loading"&&await R(),await te());k.isLoaded.value||$({text:"You have set up <yandex-map> component without initializing Yandex maps. Please check initializeOn setting or call initYmaps manually before registering this component."})}h.value=!0,await R(),c.value&&await new Promise(s=>O(c,()=>{c.value||s()},{immediate:!0})),await M()}),be(()=>{S&&clearTimeout(S),t.value&&t.value.destroy(),t.value=null,i("input",t.value),i("update:modelValue",t.value)}),()=>{const l={class:["__ymap",{"__ymap--grab":e.cursorGrab}],ref:d,style:{width:e.width,height:e.height,"z-index":e.zIndex.toString()}},s=Y("div",{class:"__ymap_container",ref:V}),C={class:"__ymap_slots",style:{display:"none"}};return h.value?Y(e.tag,l,[s,Y("div",C,n.default?.({}))]):Y(e.tag,l,[s,Y("div",C)])}}}),De={class:"q-pa-sm"},Ge={class:"justify-center row q-mb-md"},Ee={class:"text-h5 justify-between q-mb-sm row"},We={class:"items-center"},Ze={class:"items-center"},Fe={key:0,class:"row items-center q-mb-sm text-h6"},He={style:{height:"40px"},class:"col-10 content-center"},Xe={key:1,class:"row items-center q-mb-sm"},Je={class:"row items-center q-mb-sm"},pt=H({__name:"UserPage",setup(e){const n=de(),i=ce(),t=Pe(),d=_e(),b=Z(()=>ee.isActive),{isManagerWithoutIsUser:p}=$e(),V=xe({dark:"dark",light:"light"}),h=_(!1),c=Z(()=>b.value?V.dark:V.light),v=_(!1),M=_("dark"),r=_({addres:null,full_name:"",mail:"",phone:""}),A=_(),S=_(null);X(()=>{r.value=d.user,I()});function g(f){f.is_default=!0,r.value.addres=f,C(f)}function m(){S.value=null,v.value=!v.value}async function l(f){try{n.loading.show(),await i.deleteAddress(f.id)&&I()}catch(a){console.error(a)}finally{n.loading.hide()}}function s(f){S.value=f,v.value=!v.value}async function C(f){try{n.loading.show(),await i.updateAddress(f)&&I()}catch(a){console.error(a)}finally{n.loading.hide()}}const x=()=>{ee.toggle(),window.localStorage.setItem("theme",c.value)};function q(){n.dialog({cancel:!0,message:"Вы уверенны что хотите изменить номер?",persistent:!0,title:"Смена номера телефона"}).onOk(()=>{U()})}async function U(){r.value.phone=A.value;try{n.loading.show(),await t.updateMyPhone(r.value.phone)}catch(f){console.error(f)}finally{n.loading.hide()}}async function I(){try{n.loading.show();const f=await i.fetchAddresses();if(f){i.addresses=f;const a=f.find(L=>L.is_default===!0);a&&(i.addressId=a.id)}}catch(f){console.error(f)}finally{n.loading.hide()}}async function fe(){try{n.loading.show(),await t.updateUserMode(r.value.id)}catch(f){console.error(f)}finally{n.loading.hide()}}return(f,a)=>{const L=Ve("q-item-action");return Q(),D("div",null,[a[12]||(a[12]=w("h6",{class:"text-center q-mb-md"},"Личный кабинет",-1)),w("div",De,[o(le,{class:"my-card full-height",flat:"",bordered:""},{default:y(()=>[o(se,null,{default:y(()=>[w("div",Ge,[o(pe,{class:"radius-100",height:"120px",width:"120px",src:r.value?.main_image_url?r.value.main_image_url:z(Ie)("/card-shop.jpg")},null,8,["src"])]),w("div",Ee,[w("div",null,B(r.value.full_name),1),w("div",null,[o(Ae,{modelValue:M.value,"onUpdate:modelValue":a[0]||(a[0]=u=>M.value=u),size:"sm","no-caps":"",unelevated:"",dense:"","toggle-color":"grey-9",color:"white","text-color":"grey-9",options:[{value:"dark",slot:"dark",title:"Dark mode"},{value:"light",slot:"light",title:"Light mode"}],onClick:a[1]||(a[1]=u=>x())},{dark:y(()=>[w("div",We,[o(j,{name:"nightlight"})])]),light:y(()=>[w("div",Ze,[o(j,{name:"light_mode"})])]),_:1},8,["modelValue"])])]),!h.value&&r.value?.phone?(Q(),D("div",Fe,[w("div",He,B(r.value.phone),1),o(j,{name:"edit",size:"30px",color:"green",class:"col-2",onClick:a[2]||(a[2]=u=>h.value=!h.value)})])):(Q(),D("div",Xe,[o(j,{name:"close",size:"30px",color:"red",class:"col-1",onClick:a[3]||(a[3]=u=>h.value=!h.value)}),o(oe,{modelValue:A.value,"onUpdate:modelValue":a[4]||(a[4]=u=>A.value=u),class:"col-9",dense:"",outlined:"",label:"Телефон",mask:"+# (###) ###-##-##",type:"tel"},null,8,["modelValue"]),o(j,{name:"save",size:"30px",color:"green",class:"col-2",onClick:a[5]||(a[5]=u=>q())})])),w("div",Je,[o(ue,{modelValue:z(i).addressId,"onUpdate:modelValue":a[6]||(a[6]=u=>z(i).addressId=u),options:z(i).addresses,class:"col-10",dense:"",outlined:"",label:"Адрес","emit-value":"","map-options":"","option-label":"address_line","option-value":"id"},{option:y(u=>[o(Ce,Se(u.itemProps,{class:"justify-between flex"}),{default:y(()=>[o(Me,{onClick:J=>g(u.opt)},{default:y(()=>[o(je,null,{default:y(()=>[ke(B(u.opt?.address_line),1)]),_:2},1024)]),_:2},1032,["onClick"]),o(L,null,{default:y(()=>[o(j,{class:"q-mr-sm",color:"red",name:"delete",size:"26px",onClick:J=>l(u.opt)},null,8,["onClick"]),o(j,{color:"green",name:"edit",size:"26px",onClick:J=>s(u.opt)},null,8,["onClick"])]),_:2},1024)]),_:2},1040)]),_:1},8,["modelValue","options"]),o(j,{name:"add",size:"34px",color:"green",class:"col-2",onClick:a[7]||(a[7]=u=>m())})])]),_:1})]),_:1}),o(z(Re)),z(p)?(Q(),T(ie,{key:0,modelValue:r.value.is_user,"onUpdate:modelValue":a[8]||(a[8]=u=>r.value.is_user=u),color:"green",label:r.value.is_user?"Пользователь":"Администратор",onClick:a[9]||(a[9]=u=>fe())},null,8,["modelValue","label"])):W("",!0)]),v.value?(Q(),T(qe,{key:0,modelValue:v.value,"onUpdate:modelValue":a[10]||(a[10]=u=>v.value=u),newAddress:S.value,onRefresh:a[11]||(a[11]=u=>I())},null,8,["modelValue","newAddress"])):W("",!0)])}}});export{pt as default};
