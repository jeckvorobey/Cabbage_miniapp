import{Q as me}from"./QImg-Bp8DIQoM.js";import{V as Z,r as _,m as F,X as G,Y as z,ae as fe,Z as w,$ as o,a0 as ae,ab as ne,aa as le,_ as h,a6 as B,ac as oe,aq as se,ad as pe,a7 as ve,Q as X,ar as Q,f as E,B as M,q as T,M as ge,h as Y,n as ie,aj as ye,as as we,w as U,u as be,at as J,au as he,W as _e,a1 as L,a4 as q,C as j,av as xe,a5 as Ve}from"./index-COHfszfx.js";import{Q as Se}from"./QBtnToggle-CacF76ms.js";import{Q as Ae,a as ke,b as je}from"./QItem-Bz3LRM8G.js";import{Q as re}from"./QSelect-B9L6Mx9l.js";import{u as ue,g as Ce}from"./use-quasar-iKa1UzAY.js";import{Q as Me}from"./QForm-zhdSb5Iw.js";import{C as Ie}from"./ClosePopup-DJl-xB7p.js";import{u as de}from"./addressesStore-D1knXVVh.js";import{u as Oe}from"./usersStore-OENT6Iev.js";import{V as A,s as Qe,i as K,t as P,c as ee}from"./vue-yandex-maps-XMuhbuKp.js";import"./QMenu-DA5PJ-SG.js";import"./rtl-DFPa-2ov.js";import"./format-CJebrXOQ.js";const ze={class:"row q-pl-sm flex-center justify-between"},Pe={class:"text-grey-6"},$e=Z({__name:"AddAddressModal",props:{newAddress:{}},setup(e){const a=[[55.97,37.12],[56.02,37.33]],s=e,t=ue(),i=de(),b=_(!0),g=_(),r=_({address_line:"",area_id:null,comment:"",is_default:!1}),x=_([]),f=_(!1),V=_("Начните вводить адрес...");F(async()=>{try{r.value=s.newAddress??{address_line:"",area_id:null,comment:"",is_default:!1},t.loading.show();const v=await i.fetchDeliveryZones();v&&(i.deliveryZones=v)}catch(v){console.error(v)}finally{t.loading.hide()}});async function p(){if(r.value)try{await(r.value?.id?i.updateAddress:i.createAddress)(r.value),g.value?.hide()}catch(v){console.error(v)}}async function S(v,d){if(!v){V.value="Начните вводить адрес...",d(()=>{x.value=[]});return}const y=window.ymaps;if(!y){t.notify({message:"Сервис карт недоступен.",type:"negative"});return}f.value=!0;try{const c=(await y.geocode(v,{boundedBy:a,results:5,strictBounds:!0})).geoObjects.toArray().map(l=>({coords:l.geometry.getCoordinates(),displayName:l.properties.get("text")}));d(()=>{x.value=c,V.value=c.length?"Выберите адрес из списка":"Адрес не найден"})}catch(C){console.error("Ошибка геокодирования:",C)}finally{f.value=!1}}return(v,d)=>(z(),G(fe,{ref_key:"dialogRef",ref:g,modelValue:b.value,"onUpdate:modelValue":d[4]||(d[4]=y=>b.value=y),persistent:""},{default:w(()=>[o(ae,{class:""},{default:w(()=>[o(Me,{greedy:"",onSubmit:d[3]||(d[3]=y=>p())},{default:w(()=>[r.value?(z(),G(le,{key:0},{default:w(()=>[d[5]||(d[5]=h("div",{class:"text-h6"},"Создание нового адреса доставки",-1)),o(re,{modelValue:r.value.address_line,"onUpdate:modelValue":d[0]||(d[0]=y=>r.value.address_line=y),class:"q-mb-sm",clearable:"",outlined:"",behavior:"menu","use-input":"","emit-value":"","map-options":"",options:x.value,"option-label":"displayName","option-value":"displayName",label:"Адрес доставки",onFilter:S},{"no-option":w(()=>[h("div",ze,[h("div",Pe,B(V.value),1)])]),_:1},8,["modelValue","options"]),o(oe,{modelValue:r.value.comment,"onUpdate:modelValue":d[1]||(d[1]=y=>r.value.comment=y),label:"Комментарий",outlined:"",type:"textarea",rows:"3"},null,8,["modelValue"]),o(se,{modelValue:r.value.is_default,"onUpdate:modelValue":d[2]||(d[2]=y=>r.value.is_default=y),label:"Активный аддрес"},null,8,["modelValue"])]),_:1})):ne("",!0),o(pe,{align:"right"},{default:w(()=>[ve(o(X,{color:"red",flat:"",label:"Отмена"},null,512),[[Ie]]),o(X,{color:"primary",flat:"",label:"Сохранить",type:"submit"})]),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue"]))}}),D=e=>e instanceof Date,Ye=e=>Object.keys(e).length===0,W=e=>e!=null&&typeof e=="object",te=(e,...a)=>Object.prototype.hasOwnProperty.call(e,...a),R=e=>W(e)&&Ye(e),qe=()=>Object.create(null),ce=(e,a)=>{if(e===a)return{};if(!W(e)||!W(a))return a;const s=Object.keys(e).reduce((t,i)=>(te(a,i)||(t[i]=void 0),t),qe());return D(e)||D(a)?e.valueOf()==a.valueOf()?{}:a:Object.keys(a).reduce((t,i)=>{if(!te(e,i))return t[i]=a[i],t;const b=ce(e[i],a[i]);return R(b)&&!D(b)&&(R(e[i])||!R(a[i]))||(t[i]=b),t},s)};function Ue(){ie()||P({text:"injectMap must be only called on runtime.",isInternal:!0});const e=ye("map");return(!e||!we(e))&&P({text:"Was not able to inject valid map in injectMap.",isInternal:!0}),e}async function Be({map:e,timeoutCallback:a,waitDuration:s}={}){!e&&!ie()&&P({text:"onMapInit must be only called on runtime.",isInternal:!0}),typeof window>"u"&&P({text:"waitTillMapInit cannot be called on SSR.",isInternal:!0});const t=e||Ue();if(!t.value)return new Promise((i,b)=>{let g;s=typeof s<"u"?s:A.settings.value.mapsRenderWaitDuration,s!==!1&&(g=setTimeout(()=>{a?.(g,!0),b(new A.YandexMapException("Was not able to wait for map initialization in waitTillMapInit. You can change this behavior by using mapsRenderWaitDuration."))},typeof s=="number"?s:5e3),a?.(g,!1));let r;r=M(t,()=>{t.value&&(r?.(),g&&(clearTimeout(g),a?.(g,!0)),i())},{immediate:!0})})}const Ne=Z({name:"YandexMap",props:{modelValue:{type:Object,default:null},value:{type:Object,default:null},tag:{type:String,default:"div"},width:{type:String,default:"100%"},height:{type:String,default:"100%"},zIndex:{type:Number,default:0},settings:{type:Object,required:!0},readonlySettings:{type:Boolean,default:!1},realSettingsLocation:{type:Boolean,default:!1},layers:{type:Array,default:(()=>[])},cursorGrab:{type:Boolean,default:!1}},emits:{input(e){return!e||typeof ymaps3>"u"||e instanceof ymaps3.YMap},"update:modelValue"(e){return!e||typeof ymaps3>"u"||e instanceof ymaps3.YMap}},slots:Object,setup(e,{slots:a,emit:s}){const t=Q(null),i=Q(null),b=Q([]),g=Q(null),r=Q(null),x=Q(!1),f=_(0);U("map",t),U("layers",b),U("projection",g),U("needsToHold",f),s("input",null),s("update:modelValue",null);const V=E(()=>({...e.settings,projection:void 0})),p=async()=>{e.settings.location||P({text:"You must specify location in YandexMap settings"}),t.value&&t.value.destroy();const c=r.value;if(!c)return;const l=V.value;g.value&&(l.projection=g.value),t.value=new ymaps3.YMap(c,l,[...b.value,...e.layers]),s("input",t.value),s("update:modelValue",t.value)};let S,v,d=null;async function y(){await Be({map:t,timeoutCallback:(c,l)=>{l?d=null:d=c}}).catch(()=>{}),t.value&&(e.cursorGrab?(S=new ymaps3.YMapListener({onActionStart:c=>{c.type==="drag"&&e.cursorGrab&&i.value?.classList.add("__ymap--grabbing")},onActionEnd:c=>{c.type==="drag"&&i.value?.classList.remove("__ymap--grabbing")}}),t.value.addChild(S)):S&&t.value.removeChild(S))}let C=!1;return M(A.loadStatus,async c=>{if(c==="pending"){C=!0,x.value=!1;return}c!=="loaded"&&!C||(x.value=!0,await T(),f.value&&await new Promise(l=>M(f,()=>{f.value||l()},{immediate:!0})),await p())}),F(async()=>{const c=()=>{v?.();let l=ee(V);v=M(V,I=>{if(!t.value)return;const k=ee(I);e.realSettingsLocation&&k.location&&("center"in k.location&&"center"in l.location?l.location.center=t.value.center:"bounds"in k.location&&"bounds"in l.location&&(l.location.bounds=t.value.bounds),"zoom"in k.location&&"zoom"in l.location&&(l.location.zoom=t.value.zoom));const O=Object.keys(ce(l,k));if(O.length===0)return;const $={...k};for(const u in $)O.includes(u)||delete $[u];l=k,t.value?.update($)},{deep:!0})};if(e.readonlySettings||c(),M(()=>e.readonlySettings,l=>{l?c():v?.()}),M(()=>e.cursorGrab,y,{immediate:!0}),await Qe(),!A.isLoaded.value){if(A.settings.value.initializeOn==="onComponentMount")try{await K()}catch(l){console.error("An error occured while initializing Yandex Map with onComponentMount setting"),console.error(l);return}else(A.loadStatus.value==="loading"||A.settings.value.initializeOn==="onPluginInit")&&(A.settings.value.initializeOn==="onPluginInit"&&A.loadStatus.value!=="loading"&&await T(),await K());A.isLoaded.value||P({text:"You have set up <yandex-map> component without initializing Yandex maps. Please check initializeOn setting or call initYmaps manually before registering this component."})}x.value=!0,await T(),f.value&&await new Promise(l=>M(f,()=>{f.value||l()},{immediate:!0})),await p()}),ge(()=>{d&&clearTimeout(d),t.value&&t.value.destroy(),t.value=null,s("input",t.value),s("update:modelValue",t.value)}),()=>{const c={class:["__ymap",{"__ymap--grab":e.cursorGrab}],ref:i,style:{width:e.width,height:e.height,"z-index":e.zIndex.toString()}},l=Y("div",{class:"__ymap_container",ref:r}),I={class:"__ymap_slots",style:{display:"none"}};return x.value?Y(e.tag,c,[l,Y("div",I,a.default?.({}))]):Y(e.tag,c,[l,Y("div",I)])}}}),Te={class:"q-pa-sm"},Le={class:"justify-center row q-mb-md"},De={class:"text-h5 justify-between q-mb-sm row"},Re={class:"items-center"},Ge={class:"items-center"},Ee={key:0,class:"row items-center q-mb-sm text-h6"},We={style:{height:"40px"},class:"col-10 content-center"},Ze={key:1,class:"row items-center q-mb-sm"},Fe={class:"row items-center q-mb-sm"},dt=Z({__name:"UserPage",setup(e){const a=ue(),s=de(),t=Oe(),i=be(),b=E(()=>J.isActive),g=he({dark:"dark",light:"light"}),r=_(!1),x=E(()=>b.value?g.dark:g.light),f=_(!1),V=_("dark"),p=_({addres:null,full_name:"",mail:"",phone:""}),S=_(null);F(()=>{p.value=i.user,O()});function v(u){u.is_default=!0,p.value.addres=u,c(u)}function d(){S.value=null,f.value=!f.value}async function y(u){try{a.loading.show(),await s.deleteAddress(u.id)&&O()}catch(n){console.error(n)}finally{a.loading.hide()}}function C(u){S.value=u,f.value=!f.value}async function c(u){try{a.loading.show(),await s.updateAddress(u)&&O()}catch(n){console.error(n)}finally{a.loading.hide()}}const l=()=>{J.toggle(),window.localStorage.setItem("theme",x.value)};function I(){a.dialog({cancel:!0,message:"Вы уверенны что хотите изменить номер?",persistent:!0,title:"Смена номера телефона"}).onOk(()=>{k()})}async function k(){try{a.loading.show(),await t.updateMyPhone(p.value.phone)}catch(u){console.error(u)}finally{a.loading.hide()}}async function O(){try{a.loading.show();const u=await s.fetchAddresses();if(u){s.addresses=u;const n=u.find(N=>N.is_default===!0);n&&(s.addressId=n.id)}}catch(u){console.error(u)}finally{a.loading.hide()}}async function $(){try{a.loading.show(),await t.updateUserMode(p.value.id)}catch(u){console.error(u)}finally{a.loading.hide()}}return(u,n)=>{const N=_e("q-item-action");return z(),L("div",null,[n[11]||(n[11]=h("h6",{class:"text-center q-mb-md"},"Личный кабинет",-1)),h("div",Te,[o(ae,{class:"my-card full-height",flat:"",bordered:""},{default:w(()=>[o(le,null,{default:w(()=>[h("div",Le,[o(me,{class:"radius-100",height:"120px",width:"120px",src:p.value?.main_image_url?p.value.main_image_url:q(Ce)("/card-shop.jpg")},null,8,["src"])]),h("div",De,[h("div",null,B(p.value.full_name),1),h("div",null,[o(Se,{modelValue:V.value,"onUpdate:modelValue":n[0]||(n[0]=m=>V.value=m),size:"sm","no-caps":"",unelevated:"",dense:"","toggle-color":"grey-9",color:"white","text-color":"grey-9",options:[{value:"dark",slot:"dark",title:"Dark mode"},{value:"light",slot:"light",title:"Light mode"}],onClick:n[1]||(n[1]=m=>l())},{dark:w(()=>[h("div",Re,[o(j,{name:"nightlight"})])]),light:w(()=>[h("div",Ge,[o(j,{name:"light_mode"})])]),_:1},8,["modelValue"])])]),!r.value&&p.value?.phone?(z(),L("div",Ee,[h("div",We,B(p.value.phone),1),o(j,{name:"edit",size:"30px",color:"green",class:"col-2",onClick:n[2]||(n[2]=m=>r.value=!r.value)})])):(z(),L("div",Ze,[o(j,{name:"close",size:"30px",color:"red",class:"col-1",onClick:n[3]||(n[3]=m=>r.value=!r.value)}),o(oe,{modelValue:p.value.phone,"onUpdate:modelValue":n[4]||(n[4]=m=>p.value.phone=m),class:"col-9",dense:"",outlined:"",label:"Телефон",mask:"+# (###) ###-##-##",type:"tel"},null,8,["modelValue"]),o(j,{name:"save",size:"30px",color:"green",class:"col-2",onClick:n[5]||(n[5]=m=>I())})])),h("div",Fe,[o(re,{modelValue:q(s).addressId,"onUpdate:modelValue":n[6]||(n[6]=m=>q(s).addressId=m),options:q(s).addresses,class:"col-10",dense:"",outlined:"",label:"Адрес","emit-value":"","map-options":"","option-label":"address_line","option-value":"id"},{option:w(m=>[o(Ae,xe(m.itemProps,{class:"justify-between flex"}),{default:w(()=>[o(ke,{onClick:H=>v(m.opt)},{default:w(()=>[o(je,null,{default:w(()=>[Ve(B(m.opt?.address_line),1)]),_:2},1024)]),_:2},1032,["onClick"]),o(N,null,{default:w(()=>[o(j,{class:"q-mr-sm",color:"red",name:"delete",size:"26px",onClick:H=>y(m.opt)},null,8,["onClick"]),o(j,{color:"green",name:"edit",size:"26px",onClick:H=>C(m.opt)},null,8,["onClick"])]),_:2},1024)]),_:2},1040)]),_:1},8,["modelValue","options"]),o(j,{name:"add",size:"34px",color:"green",class:"col-2",onClick:n[7]||(n[7]=m=>d())})])]),_:1})]),_:1}),o(q(Ne)),o(se,{modelValue:p.value.is_user,"onUpdate:modelValue":n[8]||(n[8]=m=>p.value.is_user=m),color:"green",label:"Администратор/Пользователь",onClick:n[9]||(n[9]=m=>$())},null,8,["modelValue"])]),f.value?(z(),G($e,{key:0,modelValue:f.value,"onUpdate:modelValue":n[10]||(n[10]=m=>f.value=m),newAddress:S.value},null,8,["modelValue","newAddress"])):ne("",!0)])}}});export{dt as default};
