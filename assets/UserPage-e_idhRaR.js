import{Q as fe}from"./QImg-Clq32-oe.js";import{V as H,r as V,m as X,X as T,Y as O,ad as pe,Z as b,$ as s,a0 as le,a9 as W,aa as se,_,a6 as N,ab as oe,aq as ie,ac as ve,a7 as ge,Q as K,ar as z,f as Z,B as I,q as D,M as ye,h as U,n as re,ai as be,as as he,w as B,u as we,at as ee,au as _e,W as xe,a1 as R,a4 as P,C as A,av as Ve,a5 as Se}from"./index-DY0FHP_n.js";import{Q as ke}from"./QBtnToggle-BaFq2nWY.js";import{Q as Ae,a as Ce,b as Me}from"./QItem-6kQlYFWe.js";import{Q as ue}from"./QSelect-CxCFFpVh.js";import{u as de,g as je}from"./use-quasar-BgZcdgVc.js";import{Q as Ie}from"./QForm-Dqcm7FvW.js";import{C as Oe}from"./ClosePopup-BrFJpfjb.js";import{u as ce}from"./addressesStore-BirrRkxH.js";import{u as Qe}from"./usersStore-DqnGTczz.js";import{V as S,s as ze,i as te,t as $,c as ae}from"./vue-yandex-maps-B9q-nGFT.js";import{u as Pe}from"./usePermissionVisibility.hook-CRgiY9bp.js";import"./QMenu-B8Fd7nqb.js";import"./rtl-DFPa-2ov.js";import"./format-CJebrXOQ.js";const $e={class:"row q-pl-sm flex-center justify-between"},Ue={class:"text-grey-6"},Ye=H({__name:"AddAddressModal",props:{newAddress:{}},setup(e){const a=[[55.97,37.12],[56.02,37.33]],o=e,t=de(),i=ce(),w=V(!0),v=V(),m=V({address_line:"",area_id:null,comment:"",is_default:!1}),h=V([]),x=V(!1),g=V("Начните вводить адрес...");X(async()=>{try{m.value=o.newAddress??{address_line:"",area_id:null,comment:"",is_default:!1},t.loading.show();const p=await i.fetchDeliveryZones();p&&(i.deliveryZones=p)}catch(p){console.error(p)}finally{t.loading.hide()}});async function C(){if(m.value)try{await(m.value?.id?i.updateAddress:i.createAddress)(m.value),v.value?.hide()}catch(p){console.error(p)}}async function d(p,r){if(!p){g.value="Начните вводить адрес...",r(()=>{h.value=[]});return}const y=window.ymaps;if(!y){t.notify({message:"Сервис карт недоступен.",type:"negative"});return}x.value=!0;try{const u=(await y.geocode(p,{boundedBy:a,results:5,strictBounds:!0})).geoObjects.toArray().map(l=>({coords:l.geometry.getCoordinates(),displayName:l.properties.get("text")}));r(()=>{h.value=u,g.value=u.length?"Выберите адрес из списка":"Адрес не найден"})}catch(M){console.error("Ошибка геокодирования:",M)}finally{x.value=!1}}return(p,r)=>(O(),T(pe,{ref_key:"dialogRef",ref:v,modelValue:w.value,"onUpdate:modelValue":r[4]||(r[4]=y=>w.value=y),persistent:""},{default:b(()=>[s(le,{class:""},{default:b(()=>[s(Ie,{greedy:"",onSubmit:r[3]||(r[3]=y=>C())},{default:b(()=>[m.value?(O(),T(se,{key:0},{default:b(()=>[r[5]||(r[5]=_("div",{class:"text-h6"},"Создание нового адреса доставки",-1)),s(ue,{modelValue:m.value.address_line,"onUpdate:modelValue":r[0]||(r[0]=y=>m.value.address_line=y),class:"q-mb-sm",clearable:"",outlined:"",behavior:"menu","use-input":"","emit-value":"","map-options":"",options:h.value,"option-label":"displayName","option-value":"displayName",label:"Адрес доставки",onFilter:d},{"no-option":b(()=>[_("div",$e,[_("div",Ue,N(g.value),1)])]),_:1},8,["modelValue","options"]),s(oe,{modelValue:m.value.comment,"onUpdate:modelValue":r[1]||(r[1]=y=>m.value.comment=y),label:"Комментарий",outlined:"",type:"textarea",rows:"3"},null,8,["modelValue"]),s(ie,{modelValue:m.value.is_default,"onUpdate:modelValue":r[2]||(r[2]=y=>m.value.is_default=y),label:"Активный аддрес"},null,8,["modelValue"])]),_:1})):W("",!0),s(ve,{align:"right"},{default:b(()=>[ge(s(K,{color:"red",flat:"",label:"Отмена"},null,512),[[Oe]]),s(K,{color:"primary",flat:"",label:"Сохранить",type:"submit"})]),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue"]))}}),G=e=>e instanceof Date,qe=e=>Object.keys(e).length===0,F=e=>e!=null&&typeof e=="object",ne=(e,...a)=>Object.prototype.hasOwnProperty.call(e,...a),E=e=>F(e)&&qe(e),Be=()=>Object.create(null),me=(e,a)=>{if(e===a)return{};if(!F(e)||!F(a))return a;const o=Object.keys(e).reduce((t,i)=>(ne(a,i)||(t[i]=void 0),t),Be());return G(e)||G(a)?e.valueOf()==a.valueOf()?{}:a:Object.keys(a).reduce((t,i)=>{if(!ne(e,i))return t[i]=a[i],t;const w=me(e[i],a[i]);return E(w)&&!G(w)&&(E(e[i])||!E(a[i]))||(t[i]=w),t},o)};function Ne(){re()||$({text:"injectMap must be only called on runtime.",isInternal:!0});const e=be("map");return(!e||!he(e))&&$({text:"Was not able to inject valid map in injectMap.",isInternal:!0}),e}async function Te({map:e,timeoutCallback:a,waitDuration:o}={}){!e&&!re()&&$({text:"onMapInit must be only called on runtime.",isInternal:!0}),typeof window>"u"&&$({text:"waitTillMapInit cannot be called on SSR.",isInternal:!0});const t=e||Ne();if(!t.value)return new Promise((i,w)=>{let v;o=typeof o<"u"?o:S.settings.value.mapsRenderWaitDuration,o!==!1&&(v=setTimeout(()=>{a?.(v,!0),w(new S.YandexMapException("Was not able to wait for map initialization in waitTillMapInit. You can change this behavior by using mapsRenderWaitDuration."))},typeof o=="number"?o:5e3),a?.(v,!1));let m;m=I(t,()=>{t.value&&(m?.(),v&&(clearTimeout(v),a?.(v,!0)),i())},{immediate:!0})})}const Le=H({name:"YandexMap",props:{modelValue:{type:Object,default:null},value:{type:Object,default:null},tag:{type:String,default:"div"},width:{type:String,default:"100%"},height:{type:String,default:"100%"},zIndex:{type:Number,default:0},settings:{type:Object,required:!0},readonlySettings:{type:Boolean,default:!1},realSettingsLocation:{type:Boolean,default:!1},layers:{type:Array,default:(()=>[])},cursorGrab:{type:Boolean,default:!1}},emits:{input(e){return!e||typeof ymaps3>"u"||e instanceof ymaps3.YMap},"update:modelValue"(e){return!e||typeof ymaps3>"u"||e instanceof ymaps3.YMap}},slots:Object,setup(e,{slots:a,emit:o}){const t=z(null),i=z(null),w=z([]),v=z(null),m=z(null),h=z(!1),x=V(0);B("map",t),B("layers",w),B("projection",v),B("needsToHold",x),o("input",null),o("update:modelValue",null);const g=Z(()=>({...e.settings,projection:void 0})),C=async()=>{e.settings.location||$({text:"You must specify location in YandexMap settings"}),t.value&&t.value.destroy();const u=m.value;if(!u)return;const l=g.value;v.value&&(l.projection=v.value),t.value=new ymaps3.YMap(u,l,[...w.value,...e.layers]),o("input",t.value),o("update:modelValue",t.value)};let d,p,r=null;async function y(){await Te({map:t,timeoutCallback:(u,l)=>{l?r=null:r=u}}).catch(()=>{}),t.value&&(e.cursorGrab?(d=new ymaps3.YMapListener({onActionStart:u=>{u.type==="drag"&&e.cursorGrab&&i.value?.classList.add("__ymap--grabbing")},onActionEnd:u=>{u.type==="drag"&&i.value?.classList.remove("__ymap--grabbing")}}),t.value.addChild(d)):d&&t.value.removeChild(d))}let M=!1;return I(S.loadStatus,async u=>{if(u==="pending"){M=!0,h.value=!1;return}u!=="loaded"&&!M||(h.value=!0,await D(),x.value&&await new Promise(l=>I(x,()=>{x.value||l()},{immediate:!0})),await C())}),X(async()=>{const u=()=>{p?.();let l=ae(g);p=I(g,Q=>{if(!t.value)return;const k=ae(Q);e.realSettingsLocation&&k.location&&("center"in k.location&&"center"in l.location?l.location.center=t.value.center:"bounds"in k.location&&"bounds"in l.location&&(l.location.bounds=t.value.bounds),"zoom"in k.location&&"zoom"in l.location&&(l.location.zoom=t.value.zoom));const Y=Object.keys(me(l,k));if(Y.length===0)return;const j={...k};for(const q in j)Y.includes(q)||delete j[q];l=k,t.value?.update(j)},{deep:!0})};if(e.readonlySettings||u(),I(()=>e.readonlySettings,l=>{l?u():p?.()}),I(()=>e.cursorGrab,y,{immediate:!0}),await ze(),!S.isLoaded.value){if(S.settings.value.initializeOn==="onComponentMount")try{await te()}catch(l){console.error("An error occured while initializing Yandex Map with onComponentMount setting"),console.error(l);return}else(S.loadStatus.value==="loading"||S.settings.value.initializeOn==="onPluginInit")&&(S.settings.value.initializeOn==="onPluginInit"&&S.loadStatus.value!=="loading"&&await D(),await te());S.isLoaded.value||$({text:"You have set up <yandex-map> component without initializing Yandex maps. Please check initializeOn setting or call initYmaps manually before registering this component."})}h.value=!0,await D(),x.value&&await new Promise(l=>I(x,()=>{x.value||l()},{immediate:!0})),await C()}),ye(()=>{r&&clearTimeout(r),t.value&&t.value.destroy(),t.value=null,o("input",t.value),o("update:modelValue",t.value)}),()=>{const u={class:["__ymap",{"__ymap--grab":e.cursorGrab}],ref:i,style:{width:e.width,height:e.height,"z-index":e.zIndex.toString()}},l=U("div",{class:"__ymap_container",ref:m}),Q={class:"__ymap_slots",style:{display:"none"}};return h.value?U(e.tag,u,[l,U("div",Q,a.default?.({}))]):U(e.tag,u,[l,U("div",Q)])}}}),De={class:"q-pa-sm"},Re={class:"justify-center row q-mb-md"},Ge={class:"text-h5 justify-between q-mb-sm row"},Ee={class:"items-center"},We={class:"items-center"},Ze={key:0,class:"row items-center q-mb-sm text-h6"},Fe={style:{height:"40px"},class:"col-10 content-center"},He={key:1,class:"row items-center q-mb-sm"},Xe={class:"row items-center q-mb-sm"},ft=H({__name:"UserPage",setup(e){const a=de(),o=ce(),t=Qe(),i=we(),w=Z(()=>ee.isActive),{isManagerWithoutIsUser:v}=Pe(),m=_e({dark:"dark",light:"light"}),h=V(!1),x=Z(()=>w.value?m.dark:m.light),g=V(!1),C=V("dark"),d=V({addres:null,full_name:"",mail:"",phone:""}),p=V(null);X(()=>{d.value=i.user,j()});function r(f){f.is_default=!0,d.value.addres=f,l(f)}function y(){p.value=null,g.value=!g.value}async function M(f){try{a.loading.show(),await o.deleteAddress(f.id)&&j()}catch(n){console.error(n)}finally{a.loading.hide()}}function u(f){p.value=f,g.value=!g.value}async function l(f){try{a.loading.show(),await o.updateAddress(f)&&j()}catch(n){console.error(n)}finally{a.loading.hide()}}const Q=()=>{ee.toggle(),window.localStorage.setItem("theme",x.value)};function k(){a.dialog({cancel:!0,message:"Вы уверенны что хотите изменить номер?",persistent:!0,title:"Смена номера телефона"}).onOk(()=>{Y()})}async function Y(){try{a.loading.show(),await t.updateMyPhone(d.value.phone)}catch(f){console.error(f)}finally{a.loading.hide()}}async function j(){try{a.loading.show();const f=await o.fetchAddresses();if(f){o.addresses=f;const n=f.find(L=>L.is_default===!0);n&&(o.addressId=n.id)}}catch(f){console.error(f)}finally{a.loading.hide()}}async function q(){try{a.loading.show(),await t.updateUserMode(d.value.id)}catch(f){console.error(f)}finally{a.loading.hide()}}return(f,n)=>{const L=xe("q-item-action");return O(),R("div",null,[n[11]||(n[11]=_("h6",{class:"text-center q-mb-md"},"Личный кабинет",-1)),_("div",De,[s(le,{class:"my-card full-height",flat:"",bordered:""},{default:b(()=>[s(se,null,{default:b(()=>[_("div",Re,[s(fe,{class:"radius-100",height:"120px",width:"120px",src:d.value?.main_image_url?d.value.main_image_url:P(je)("/card-shop.jpg")},null,8,["src"])]),_("div",Ge,[_("div",null,N(d.value.full_name),1),_("div",null,[s(ke,{modelValue:C.value,"onUpdate:modelValue":n[0]||(n[0]=c=>C.value=c),size:"sm","no-caps":"",unelevated:"",dense:"","toggle-color":"grey-9",color:"white","text-color":"grey-9",options:[{value:"dark",slot:"dark",title:"Dark mode"},{value:"light",slot:"light",title:"Light mode"}],onClick:n[1]||(n[1]=c=>Q())},{dark:b(()=>[_("div",Ee,[s(A,{name:"nightlight"})])]),light:b(()=>[_("div",We,[s(A,{name:"light_mode"})])]),_:1},8,["modelValue"])])]),!h.value&&d.value?.phone?(O(),R("div",Ze,[_("div",Fe,N(d.value.phone),1),s(A,{name:"edit",size:"30px",color:"green",class:"col-2",onClick:n[2]||(n[2]=c=>h.value=!h.value)})])):(O(),R("div",He,[s(A,{name:"close",size:"30px",color:"red",class:"col-1",onClick:n[3]||(n[3]=c=>h.value=!h.value)}),s(oe,{modelValue:d.value.phone,"onUpdate:modelValue":n[4]||(n[4]=c=>d.value.phone=c),class:"col-9",dense:"",outlined:"",label:"Телефон",mask:"+# (###) ###-##-##",type:"tel"},null,8,["modelValue"]),s(A,{name:"save",size:"30px",color:"green",class:"col-2",onClick:n[5]||(n[5]=c=>k())})])),_("div",Xe,[s(ue,{modelValue:P(o).addressId,"onUpdate:modelValue":n[6]||(n[6]=c=>P(o).addressId=c),options:P(o).addresses,class:"col-10",dense:"",outlined:"",label:"Адрес","emit-value":"","map-options":"","option-label":"address_line","option-value":"id"},{option:b(c=>[s(Ae,Ve(c.itemProps,{class:"justify-between flex"}),{default:b(()=>[s(Ce,{onClick:J=>r(c.opt)},{default:b(()=>[s(Me,null,{default:b(()=>[Se(N(c.opt?.address_line),1)]),_:2},1024)]),_:2},1032,["onClick"]),s(L,null,{default:b(()=>[s(A,{class:"q-mr-sm",color:"red",name:"delete",size:"26px",onClick:J=>M(c.opt)},null,8,["onClick"]),s(A,{color:"green",name:"edit",size:"26px",onClick:J=>u(c.opt)},null,8,["onClick"])]),_:2},1024)]),_:2},1040)]),_:1},8,["modelValue","options"]),s(A,{name:"add",size:"34px",color:"green",class:"col-2",onClick:n[7]||(n[7]=c=>y())})])]),_:1})]),_:1}),s(P(Le)),P(v)?(O(),T(ie,{key:0,modelValue:d.value.is_user,"onUpdate:modelValue":n[8]||(n[8]=c=>d.value.is_user=c),color:"green",label:d.value.is_user?"Пользователь":"Администратор",onClick:n[9]||(n[9]=c=>q())},null,8,["modelValue","label"])):W("",!0)]),g.value?(O(),T(Ye,{key:0,modelValue:g.value,"onUpdate:modelValue":n[10]||(n[10]=c=>g.value=c),newAddress:p.value},null,8,["modelValue","newAddress"])):W("",!0)])}}});export{ft as default};
