import{Q as fe}from"./QImg-C-1lO48_.js";import{V as H,r as V,m as X,X as T,Y as O,ae as pe,Z as b,$ as o,a0 as le,ab as W,aa as oe,_,a6 as N,ac as se,aq as ie,ad as ve,a7 as ge,Q as K,ar as z,f as Z,B as I,q as D,M as ye,h as Y,n as re,aj as be,as as we,w as B,u as he,at as ee,au as _e,W as xe,a1 as R,a4 as P,C as k,av as Ve,a5 as Se}from"./index-D4HhW3th.js";import{Q as Ae}from"./QBtnToggle-Fr10hQjN.js";import{Q as ke,a as je,b as Ce}from"./QItem-AuelcHUJ.js";import{Q as ue}from"./QSelect-D_Ek5XrQ.js";import{u as de,g as Me}from"./use-quasar-BLgf3lq5.js";import{Q as Ie}from"./QForm-CKIAc_hG.js";import{C as Oe}from"./ClosePopup-C36dxpb-.js";import{u as ce}from"./addressesStore-BND6EN3x.js";import{u as Qe}from"./usersStore-BeNgKH1Q.js";import{V as S,s as ze,i as te,t as $,c as ae}from"./vue-yandex-maps-PA5S1kjW.js";import{u as Pe}from"./usePermissionVisibility.hook-o1db_mp2.js";import"./QMenu-ZBAD-PW0.js";import"./rtl-DFPa-2ov.js";import"./format-CJebrXOQ.js";const $e={class:"row q-pl-sm flex-center justify-between"},Ye={class:"text-grey-6"},qe=H({__name:"AddAddressModal",props:{newAddress:{}},setup(e){const a=[[55.97,37.12],[56.02,37.33]],s=e,t=de(),i=ce(),h=V(!0),v=V(),c=V({address_line:"",area_id:null,comment:"",is_default:!1}),w=V([]),x=V(!1),g=V("Начните вводить адрес...");X(async()=>{try{c.value=s.newAddress??{address_line:"",area_id:null,comment:"",is_default:!1},t.loading.show();const p=await i.fetchDeliveryZones();p&&(i.deliveryZones=p)}catch(p){console.error(p)}finally{t.loading.hide()}});async function j(){if(c.value)try{await(c.value?.id?i.updateAddress:i.createAddress)(c.value),v.value?.hide()}catch(p){console.error(p)}}async function m(p,r){if(!p){g.value="Начните вводить адрес...",r(()=>{w.value=[]});return}const y=window.ymaps;if(!y){t.notify({message:"Сервис карт недоступен.",type:"negative"});return}x.value=!0;try{const u=(await y.geocode(p,{boundedBy:a,results:5,strictBounds:!0})).geoObjects.toArray().map(l=>({coords:l.geometry.getCoordinates(),displayName:l.properties.get("text")}));r(()=>{w.value=u,g.value=u.length?"Выберите адрес из списка":"Адрес не найден"})}catch(C){console.error("Ошибка геокодирования:",C)}finally{x.value=!1}}return(p,r)=>(O(),T(pe,{ref_key:"dialogRef",ref:v,modelValue:h.value,"onUpdate:modelValue":r[4]||(r[4]=y=>h.value=y),persistent:""},{default:b(()=>[o(le,{class:""},{default:b(()=>[o(Ie,{greedy:"",onSubmit:r[3]||(r[3]=y=>j())},{default:b(()=>[c.value?(O(),T(oe,{key:0},{default:b(()=>[r[5]||(r[5]=_("div",{class:"text-h6"},"Создание нового адреса доставки",-1)),o(ue,{modelValue:c.value.address_line,"onUpdate:modelValue":r[0]||(r[0]=y=>c.value.address_line=y),class:"q-mb-sm",clearable:"",outlined:"",behavior:"menu","use-input":"","emit-value":"","map-options":"",options:w.value,"option-label":"displayName","option-value":"displayName",label:"Адрес доставки",onFilter:m},{"no-option":b(()=>[_("div",$e,[_("div",Ye,N(g.value),1)])]),_:1},8,["modelValue","options"]),o(se,{modelValue:c.value.comment,"onUpdate:modelValue":r[1]||(r[1]=y=>c.value.comment=y),label:"Комментарий",outlined:"",type:"textarea",rows:"3"},null,8,["modelValue"]),o(ie,{modelValue:c.value.is_default,"onUpdate:modelValue":r[2]||(r[2]=y=>c.value.is_default=y),label:"Активный аддрес"},null,8,["modelValue"])]),_:1})):W("",!0),o(ve,{align:"right"},{default:b(()=>[ge(o(K,{color:"red",flat:"",label:"Отмена"},null,512),[[Oe]]),o(K,{color:"primary",flat:"",label:"Сохранить",type:"submit"})]),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue"]))}}),G=e=>e instanceof Date,Ue=e=>Object.keys(e).length===0,F=e=>e!=null&&typeof e=="object",ne=(e,...a)=>Object.prototype.hasOwnProperty.call(e,...a),E=e=>F(e)&&Ue(e),Be=()=>Object.create(null),me=(e,a)=>{if(e===a)return{};if(!F(e)||!F(a))return a;const s=Object.keys(e).reduce((t,i)=>(ne(a,i)||(t[i]=void 0),t),Be());return G(e)||G(a)?e.valueOf()==a.valueOf()?{}:a:Object.keys(a).reduce((t,i)=>{if(!ne(e,i))return t[i]=a[i],t;const h=me(e[i],a[i]);return E(h)&&!G(h)&&(E(e[i])||!E(a[i]))||(t[i]=h),t},s)};function Ne(){re()||$({text:"injectMap must be only called on runtime.",isInternal:!0});const e=be("map");return(!e||!we(e))&&$({text:"Was not able to inject valid map in injectMap.",isInternal:!0}),e}async function Te({map:e,timeoutCallback:a,waitDuration:s}={}){!e&&!re()&&$({text:"onMapInit must be only called on runtime.",isInternal:!0}),typeof window>"u"&&$({text:"waitTillMapInit cannot be called on SSR.",isInternal:!0});const t=e||Ne();if(!t.value)return new Promise((i,h)=>{let v;s=typeof s<"u"?s:S.settings.value.mapsRenderWaitDuration,s!==!1&&(v=setTimeout(()=>{a?.(v,!0),h(new S.YandexMapException("Was not able to wait for map initialization in waitTillMapInit. You can change this behavior by using mapsRenderWaitDuration."))},typeof s=="number"?s:5e3),a?.(v,!1));let c;c=I(t,()=>{t.value&&(c?.(),v&&(clearTimeout(v),a?.(v,!0)),i())},{immediate:!0})})}const Le=H({name:"YandexMap",props:{modelValue:{type:Object,default:null},value:{type:Object,default:null},tag:{type:String,default:"div"},width:{type:String,default:"100%"},height:{type:String,default:"100%"},zIndex:{type:Number,default:0},settings:{type:Object,required:!0},readonlySettings:{type:Boolean,default:!1},realSettingsLocation:{type:Boolean,default:!1},layers:{type:Array,default:(()=>[])},cursorGrab:{type:Boolean,default:!1}},emits:{input(e){return!e||typeof ymaps3>"u"||e instanceof ymaps3.YMap},"update:modelValue"(e){return!e||typeof ymaps3>"u"||e instanceof ymaps3.YMap}},slots:Object,setup(e,{slots:a,emit:s}){const t=z(null),i=z(null),h=z([]),v=z(null),c=z(null),w=z(!1),x=V(0);B("map",t),B("layers",h),B("projection",v),B("needsToHold",x),s("input",null),s("update:modelValue",null);const g=Z(()=>({...e.settings,projection:void 0})),j=async()=>{e.settings.location||$({text:"You must specify location in YandexMap settings"}),t.value&&t.value.destroy();const u=c.value;if(!u)return;const l=g.value;v.value&&(l.projection=v.value),t.value=new ymaps3.YMap(u,l,[...h.value,...e.layers]),s("input",t.value),s("update:modelValue",t.value)};let m,p,r=null;async function y(){await Te({map:t,timeoutCallback:(u,l)=>{l?r=null:r=u}}).catch(()=>{}),t.value&&(e.cursorGrab?(m=new ymaps3.YMapListener({onActionStart:u=>{u.type==="drag"&&e.cursorGrab&&i.value?.classList.add("__ymap--grabbing")},onActionEnd:u=>{u.type==="drag"&&i.value?.classList.remove("__ymap--grabbing")}}),t.value.addChild(m)):m&&t.value.removeChild(m))}let C=!1;return I(S.loadStatus,async u=>{if(u==="pending"){C=!0,w.value=!1;return}u!=="loaded"&&!C||(w.value=!0,await D(),x.value&&await new Promise(l=>I(x,()=>{x.value||l()},{immediate:!0})),await j())}),X(async()=>{const u=()=>{p?.();let l=ae(g);p=I(g,Q=>{if(!t.value)return;const A=ae(Q);e.realSettingsLocation&&A.location&&("center"in A.location&&"center"in l.location?l.location.center=t.value.center:"bounds"in A.location&&"bounds"in l.location&&(l.location.bounds=t.value.bounds),"zoom"in A.location&&"zoom"in l.location&&(l.location.zoom=t.value.zoom));const q=Object.keys(me(l,A));if(q.length===0)return;const M={...A};for(const U in M)q.includes(U)||delete M[U];l=A,t.value?.update(M)},{deep:!0})};if(e.readonlySettings||u(),I(()=>e.readonlySettings,l=>{l?u():p?.()}),I(()=>e.cursorGrab,y,{immediate:!0}),await ze(),!S.isLoaded.value){if(S.settings.value.initializeOn==="onComponentMount")try{await te()}catch(l){console.error("An error occured while initializing Yandex Map with onComponentMount setting"),console.error(l);return}else(S.loadStatus.value==="loading"||S.settings.value.initializeOn==="onPluginInit")&&(S.settings.value.initializeOn==="onPluginInit"&&S.loadStatus.value!=="loading"&&await D(),await te());S.isLoaded.value||$({text:"You have set up <yandex-map> component without initializing Yandex maps. Please check initializeOn setting or call initYmaps manually before registering this component."})}w.value=!0,await D(),x.value&&await new Promise(l=>I(x,()=>{x.value||l()},{immediate:!0})),await j()}),ye(()=>{r&&clearTimeout(r),t.value&&t.value.destroy(),t.value=null,s("input",t.value),s("update:modelValue",t.value)}),()=>{const u={class:["__ymap",{"__ymap--grab":e.cursorGrab}],ref:i,style:{width:e.width,height:e.height,"z-index":e.zIndex.toString()}},l=Y("div",{class:"__ymap_container",ref:c}),Q={class:"__ymap_slots",style:{display:"none"}};return w.value?Y(e.tag,u,[l,Y("div",Q,a.default?.({}))]):Y(e.tag,u,[l,Y("div",Q)])}}}),De={class:"q-pa-sm"},Re={class:"justify-center row q-mb-md"},Ge={class:"text-h5 justify-between q-mb-sm row"},Ee={class:"items-center"},We={class:"items-center"},Ze={key:0,class:"row items-center q-mb-sm text-h6"},Fe={style:{height:"40px"},class:"col-10 content-center"},He={key:1,class:"row items-center q-mb-sm"},Xe={class:"row items-center q-mb-sm"},ft=H({__name:"UserPage",setup(e){const a=de(),s=ce(),t=Qe(),i=he(),h=Z(()=>ee.isActive),{isAdmin:v}=Pe(),c=_e({dark:"dark",light:"light"}),w=V(!1),x=Z(()=>h.value?c.dark:c.light),g=V(!1),j=V("dark"),m=V({addres:null,full_name:"",mail:"",phone:""}),p=V(null);X(()=>{m.value=i.user,M()});function r(f){f.is_default=!0,m.value.addres=f,l(f)}function y(){p.value=null,g.value=!g.value}async function C(f){try{a.loading.show(),await s.deleteAddress(f.id)&&M()}catch(n){console.error(n)}finally{a.loading.hide()}}function u(f){p.value=f,g.value=!g.value}async function l(f){try{a.loading.show(),await s.updateAddress(f)&&M()}catch(n){console.error(n)}finally{a.loading.hide()}}const Q=()=>{ee.toggle(),window.localStorage.setItem("theme",x.value)};function A(){a.dialog({cancel:!0,message:"Вы уверенны что хотите изменить номер?",persistent:!0,title:"Смена номера телефона"}).onOk(()=>{q()})}async function q(){try{a.loading.show(),await t.updateMyPhone(m.value.phone)}catch(f){console.error(f)}finally{a.loading.hide()}}async function M(){try{a.loading.show();const f=await s.fetchAddresses();if(f){s.addresses=f;const n=f.find(L=>L.is_default===!0);n&&(s.addressId=n.id)}}catch(f){console.error(f)}finally{a.loading.hide()}}async function U(){try{a.loading.show(),await t.updateUserMode(m.value.id)}catch(f){console.error(f)}finally{a.loading.hide()}}return(f,n)=>{const L=xe("q-item-action");return O(),R("div",null,[n[11]||(n[11]=_("h6",{class:"text-center q-mb-md"},"Личный кабинет",-1)),_("div",De,[o(le,{class:"my-card full-height",flat:"",bordered:""},{default:b(()=>[o(oe,null,{default:b(()=>[_("div",Re,[o(fe,{class:"radius-100",height:"120px",width:"120px",src:m.value?.main_image_url?m.value.main_image_url:P(Me)("/card-shop.jpg")},null,8,["src"])]),_("div",Ge,[_("div",null,N(m.value.full_name),1),_("div",null,[o(Ae,{modelValue:j.value,"onUpdate:modelValue":n[0]||(n[0]=d=>j.value=d),size:"sm","no-caps":"",unelevated:"",dense:"","toggle-color":"grey-9",color:"white","text-color":"grey-9",options:[{value:"dark",slot:"dark",title:"Dark mode"},{value:"light",slot:"light",title:"Light mode"}],onClick:n[1]||(n[1]=d=>Q())},{dark:b(()=>[_("div",Ee,[o(k,{name:"nightlight"})])]),light:b(()=>[_("div",We,[o(k,{name:"light_mode"})])]),_:1},8,["modelValue"])])]),!w.value&&m.value?.phone?(O(),R("div",Ze,[_("div",Fe,N(m.value.phone),1),o(k,{name:"edit",size:"30px",color:"green",class:"col-2",onClick:n[2]||(n[2]=d=>w.value=!w.value)})])):(O(),R("div",He,[o(k,{name:"close",size:"30px",color:"red",class:"col-1",onClick:n[3]||(n[3]=d=>w.value=!w.value)}),o(se,{modelValue:m.value.phone,"onUpdate:modelValue":n[4]||(n[4]=d=>m.value.phone=d),class:"col-9",dense:"",outlined:"",label:"Телефон",mask:"+# (###) ###-##-##",type:"tel"},null,8,["modelValue"]),o(k,{name:"save",size:"30px",color:"green",class:"col-2",onClick:n[5]||(n[5]=d=>A())})])),_("div",Xe,[o(ue,{modelValue:P(s).addressId,"onUpdate:modelValue":n[6]||(n[6]=d=>P(s).addressId=d),options:P(s).addresses,class:"col-10",dense:"",outlined:"",label:"Адрес","emit-value":"","map-options":"","option-label":"address_line","option-value":"id"},{option:b(d=>[o(ke,Ve(d.itemProps,{class:"justify-between flex"}),{default:b(()=>[o(je,{onClick:J=>r(d.opt)},{default:b(()=>[o(Ce,null,{default:b(()=>[Se(N(d.opt?.address_line),1)]),_:2},1024)]),_:2},1032,["onClick"]),o(L,null,{default:b(()=>[o(k,{class:"q-mr-sm",color:"red",name:"delete",size:"26px",onClick:J=>C(d.opt)},null,8,["onClick"]),o(k,{color:"green",name:"edit",size:"26px",onClick:J=>u(d.opt)},null,8,["onClick"])]),_:2},1024)]),_:2},1040)]),_:1},8,["modelValue","options"]),o(k,{name:"add",size:"34px",color:"green",class:"col-2",onClick:n[7]||(n[7]=d=>y())})])]),_:1})]),_:1}),o(P(Le)),P(v)?(O(),T(ie,{key:0,modelValue:m.value.is_user,"onUpdate:modelValue":n[8]||(n[8]=d=>m.value.is_user=d),color:"green",label:"Администратор/Пользователь",onClick:n[9]||(n[9]=d=>U())},null,8,["modelValue"])):W("",!0)]),g.value?(O(),T(qe,{key:0,modelValue:g.value,"onUpdate:modelValue":n[10]||(n[10]=d=>g.value=d),newAddress:p.value},null,8,["modelValue","newAddress"])):W("",!0)])}}});export{ft as default};
