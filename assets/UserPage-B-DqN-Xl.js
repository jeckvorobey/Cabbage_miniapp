import{Q as de}from"./QImg-CgyxTEM2.js";import{V as W,r as _,m as Z,X as R,Y as z,ae as ce,Z as h,$ as s,a0 as te,ab as ae,aa as ne,_ as w,a6 as B,ac as le,aq as me,ad as fe,a7 as pe,Q as H,ar as Q,f as G,B as M,q as T,M as ve,h as Y,n as se,aj as ge,as as ye,w as q,u as he,at as X,au as be,W as we,a1 as L,a4 as $,C as k,av as _e,a5 as xe}from"./index-ula_D6zT.js";import{Q as Ve}from"./QBtnToggle-CG4Tekvs.js";import{Q as Se,a as Ae,b as je}from"./QItem-DE8Y4V2E.js";import{Q as oe}from"./QSelect-jfy70dOh.js";import{u as ie,g as ke}from"./use-quasar-B0WPwIj_.js";import{Q as Ce}from"./QForm-BLiKdwl8.js";import{C as Me}from"./ClosePopup-Cz3AmKRW.js";import{u as re}from"./addressesStore-CsJI7ORi.js";import{u as Ie}from"./usersStore-MnPL2p6M.js";import{V as A,s as Oe,i as J,t as P,c as K}from"./vue-yandex-maps-BEAujBSv.js";import"./QMenu-CZm32MVl.js";import"./rtl-DFPa-2ov.js";import"./format-CJebrXOQ.js";const Qe={class:"row q-pl-sm flex-center justify-between"},ze={class:"text-grey-6"},Pe=W({__name:"AddAddressModal",props:{newAddress:{}},setup(e){const n=[[55.97,37.12],[56.02,37.33]],o=e,t=ie(),i=re(),b=_(!0),v=_(),r=_({address_line:"",area_id:null,comment:"",is_default:!1}),x=_([]),m=_(!1),V=_("Начните вводить адрес...");Z(async()=>{try{r.value=o.newAddress??{address_line:"",area_id:null,comment:"",is_default:!1},t.loading.show();const p=await i.fetchDeliveryZones();p&&(i.deliveryZones=p)}catch(p){console.error(p)}finally{t.loading.hide()}});async function g(){if(r.value)try{await(r.value?.id?i.updateAddress:i.createAddress)(r.value),v.value?.hide()}catch(p){console.error(p)}}async function S(p,u){if(!p){V.value="Начните вводить адрес...",u(()=>{x.value=[]});return}const y=window.ymaps;if(!y){t.notify({message:"Сервис карт недоступен.",type:"negative"});return}m.value=!0;try{const d=(await y.geocode(p,{boundedBy:n,results:5,strictBounds:!0})).geoObjects.toArray().map(l=>({coords:l.geometry.getCoordinates(),displayName:l.properties.get("text")}));u(()=>{x.value=d,V.value=d.length?"Выберите адрес из списка":"Адрес не найден"})}catch(C){console.error("Ошибка геокодирования:",C)}finally{m.value=!1}}return(p,u)=>(z(),R(ce,{ref_key:"dialogRef",ref:v,modelValue:b.value,"onUpdate:modelValue":u[4]||(u[4]=y=>b.value=y),persistent:""},{default:h(()=>[s(te,{class:""},{default:h(()=>[s(Ce,{greedy:"",onSubmit:u[3]||(u[3]=y=>g())},{default:h(()=>[r.value?(z(),R(ne,{key:0},{default:h(()=>[u[5]||(u[5]=w("div",{class:"text-h6"},"Создание нового адреса доставки",-1)),s(oe,{modelValue:r.value.address_line,"onUpdate:modelValue":u[0]||(u[0]=y=>r.value.address_line=y),class:"q-mb-sm",clearable:"",outlined:"",behavior:"menu","use-input":"","emit-value":"","map-options":"",options:x.value,"option-label":"displayName","option-value":"displayName",label:"Адрес доставки",onFilter:S},{"no-option":h(()=>[w("div",Qe,[w("div",ze,B(V.value),1)])]),_:1},8,["modelValue","options"]),s(le,{modelValue:r.value.comment,"onUpdate:modelValue":u[1]||(u[1]=y=>r.value.comment=y),label:"Комментарий",outlined:"",type:"textarea",rows:"3"},null,8,["modelValue"]),s(me,{modelValue:r.value.is_default,"onUpdate:modelValue":u[2]||(u[2]=y=>r.value.is_default=y),label:"Активный аддрес"},null,8,["modelValue"])]),_:1})):ae("",!0),s(fe,{align:"right"},{default:h(()=>[pe(s(H,{color:"red",flat:"",label:"Отмена"},null,512),[[Me]]),s(H,{color:"primary",flat:"",label:"Сохранить",type:"submit"})]),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue"]))}}),U=e=>e instanceof Date,Ye=e=>Object.keys(e).length===0,E=e=>e!=null&&typeof e=="object",ee=(e,...n)=>Object.prototype.hasOwnProperty.call(e,...n),D=e=>E(e)&&Ye(e),$e=()=>Object.create(null),ue=(e,n)=>{if(e===n)return{};if(!E(e)||!E(n))return n;const o=Object.keys(e).reduce((t,i)=>(ee(n,i)||(t[i]=void 0),t),$e());return U(e)||U(n)?e.valueOf()==n.valueOf()?{}:n:Object.keys(n).reduce((t,i)=>{if(!ee(e,i))return t[i]=n[i],t;const b=ue(e[i],n[i]);return D(b)&&!U(b)&&(D(e[i])||!D(n[i]))||(t[i]=b),t},o)};function qe(){se()||P({text:"injectMap must be only called on runtime.",isInternal:!0});const e=ge("map");return(!e||!ye(e))&&P({text:"Was not able to inject valid map in injectMap.",isInternal:!0}),e}async function Be({map:e,timeoutCallback:n,waitDuration:o}={}){!e&&!se()&&P({text:"onMapInit must be only called on runtime.",isInternal:!0}),typeof window>"u"&&P({text:"waitTillMapInit cannot be called on SSR.",isInternal:!0});const t=e||qe();if(!t.value)return new Promise((i,b)=>{let v;o=typeof o<"u"?o:A.settings.value.mapsRenderWaitDuration,o!==!1&&(v=setTimeout(()=>{n?.(v,!0),b(new A.YandexMapException("Was not able to wait for map initialization in waitTillMapInit. You can change this behavior by using mapsRenderWaitDuration."))},typeof o=="number"?o:5e3),n?.(v,!1));let r;r=M(t,()=>{t.value&&(r?.(),v&&(clearTimeout(v),n?.(v,!0)),i())},{immediate:!0})})}const Ne=W({name:"YandexMap",props:{modelValue:{type:Object,default:null},value:{type:Object,default:null},tag:{type:String,default:"div"},width:{type:String,default:"100%"},height:{type:String,default:"100%"},zIndex:{type:Number,default:0},settings:{type:Object,required:!0},readonlySettings:{type:Boolean,default:!1},realSettingsLocation:{type:Boolean,default:!1},layers:{type:Array,default:(()=>[])},cursorGrab:{type:Boolean,default:!1}},emits:{input(e){return!e||typeof ymaps3>"u"||e instanceof ymaps3.YMap},"update:modelValue"(e){return!e||typeof ymaps3>"u"||e instanceof ymaps3.YMap}},slots:Object,setup(e,{slots:n,emit:o}){const t=Q(null),i=Q(null),b=Q([]),v=Q(null),r=Q(null),x=Q(!1),m=_(0);q("map",t),q("layers",b),q("projection",v),q("needsToHold",m),o("input",null),o("update:modelValue",null);const V=G(()=>({...e.settings,projection:void 0})),g=async()=>{e.settings.location||P({text:"You must specify location in YandexMap settings"}),t.value&&t.value.destroy();const d=r.value;if(!d)return;const l=V.value;v.value&&(l.projection=v.value),t.value=new ymaps3.YMap(d,l,[...b.value,...e.layers]),o("input",t.value),o("update:modelValue",t.value)};let S,p,u=null;async function y(){await Be({map:t,timeoutCallback:(d,l)=>{l?u=null:u=d}}).catch(()=>{}),t.value&&(e.cursorGrab?(S=new ymaps3.YMapListener({onActionStart:d=>{d.type==="drag"&&e.cursorGrab&&i.value?.classList.add("__ymap--grabbing")},onActionEnd:d=>{d.type==="drag"&&i.value?.classList.remove("__ymap--grabbing")}}),t.value.addChild(S)):S&&t.value.removeChild(S))}let C=!1;return M(A.loadStatus,async d=>{if(d==="pending"){C=!0,x.value=!1;return}d!=="loaded"&&!C||(x.value=!0,await T(),m.value&&await new Promise(l=>M(m,()=>{m.value||l()},{immediate:!0})),await g())}),Z(async()=>{const d=()=>{p?.();let l=K(V);p=M(V,I=>{if(!t.value)return;const j=K(I);e.realSettingsLocation&&j.location&&("center"in j.location&&"center"in l.location?l.location.center=t.value.center:"bounds"in j.location&&"bounds"in l.location&&(l.location.bounds=t.value.bounds),"zoom"in j.location&&"zoom"in l.location&&(l.location.zoom=t.value.zoom));const O=Object.keys(ue(l,j));if(O.length===0)return;const c={...j};for(const a in c)O.includes(a)||delete c[a];l=j,t.value?.update(c)},{deep:!0})};if(e.readonlySettings||d(),M(()=>e.readonlySettings,l=>{l?d():p?.()}),M(()=>e.cursorGrab,y,{immediate:!0}),await Oe(),!A.isLoaded.value){if(A.settings.value.initializeOn==="onComponentMount")try{await J()}catch(l){console.error("An error occured while initializing Yandex Map with onComponentMount setting"),console.error(l);return}else(A.loadStatus.value==="loading"||A.settings.value.initializeOn==="onPluginInit")&&(A.settings.value.initializeOn==="onPluginInit"&&A.loadStatus.value!=="loading"&&await T(),await J());A.isLoaded.value||P({text:"You have set up <yandex-map> component without initializing Yandex maps. Please check initializeOn setting or call initYmaps manually before registering this component."})}x.value=!0,await T(),m.value&&await new Promise(l=>M(m,()=>{m.value||l()},{immediate:!0})),await g()}),ve(()=>{u&&clearTimeout(u),t.value&&t.value.destroy(),t.value=null,o("input",t.value),o("update:modelValue",t.value)}),()=>{const d={class:["__ymap",{"__ymap--grab":e.cursorGrab}],ref:i,style:{width:e.width,height:e.height,"z-index":e.zIndex.toString()}},l=Y("div",{class:"__ymap_container",ref:r}),I={class:"__ymap_slots",style:{display:"none"}};return x.value?Y(e.tag,d,[l,Y("div",I,n.default?.({}))]):Y(e.tag,d,[l,Y("div",I)])}}}),Te={class:"q-pa-sm"},Le={class:"justify-center row q-mb-md"},Ue={class:"text-h5 justify-between q-mb-sm row"},De={class:"items-center"},Re={class:"items-center"},Ge={key:0,class:"row items-center q-mb-sm text-h6"},Ee={style:{height:"40px"},class:"col-10 content-center"},We={key:1,class:"row items-center q-mb-sm"},Ze={class:"row items-center q-mb-sm"},ut=W({__name:"UserPage",setup(e){const n=ie(),o=re(),t=Ie(),i=he(),b=G(()=>X.isActive),v=be({dark:"dark",light:"light"}),r=_(!1),x=G(()=>b.value?v.dark:v.light),m=_(!1),V=_("dark"),g=_({addres:null,full_name:"",mail:"",phone:""}),S=_(null);Z(()=>{g.value=i.user,O()});function p(c){c.is_default=!0,g.value.addres=c,d(c)}function u(){S.value=null,m.value=!m.value}async function y(c){try{n.loading.show(),await o.deleteAddress(c.id)&&O()}catch(a){console.error(a)}finally{n.loading.hide()}}function C(c){S.value=c,m.value=!m.value}async function d(c){try{n.loading.show(),await o.updateAddress(c)&&O()}catch(a){console.error(a)}finally{n.loading.hide()}}const l=()=>{X.toggle(),window.localStorage.setItem("theme",x.value)};function I(){n.dialog({cancel:!0,message:"Вы уверенны что хотите изменить номер?",persistent:!0,title:"Смена номера телефона"}).onOk(()=>{j()})}async function j(){try{n.loading.show(),await t.updateMyPhone(g.value.phone)}catch(c){console.error(c)}finally{n.loading.hide()}}async function O(){try{n.loading.show();const c=await o.fetchAddresses();if(c){o.addresses=c;const a=c.find(N=>N.is_default===!0);a&&(o.addressId=a.id)}}catch(c){console.error(c)}finally{n.loading.hide()}}return(c,a)=>{const N=we("q-item-action");return z(),L("div",null,[a[9]||(a[9]=w("h6",{class:"text-center q-mb-md"},"Личный кабинет",-1)),w("div",Te,[s(te,{class:"my-card full-height",flat:"",bordered:""},{default:h(()=>[s(ne,null,{default:h(()=>[w("div",Le,[s(de,{class:"radius-100",height:"120px",width:"120px",src:g.value?.main_image_url?g.value.main_image_url:$(ke)("/card-shop.jpg")},null,8,["src"])]),w("div",Ue,[w("div",null,B(g.value.full_name),1),w("div",null,[s(Ve,{modelValue:V.value,"onUpdate:modelValue":a[0]||(a[0]=f=>V.value=f),size:"sm","no-caps":"",unelevated:"",dense:"","toggle-color":"grey-9",color:"white","text-color":"grey-9",options:[{value:"dark",slot:"dark",title:"Dark mode"},{value:"light",slot:"light",title:"Light mode"}],onClick:a[1]||(a[1]=f=>l())},{dark:h(()=>[w("div",De,[s(k,{name:"nightlight"})])]),light:h(()=>[w("div",Re,[s(k,{name:"light_mode"})])]),_:1},8,["modelValue"])])]),!r.value&&g.value?.phone?(z(),L("div",Ge,[w("div",Ee,B(g.value.phone),1),s(k,{name:"edit",size:"30px",color:"green",class:"col-2",onClick:a[2]||(a[2]=f=>r.value=!r.value)})])):(z(),L("div",We,[s(k,{name:"close",size:"30px",color:"red",class:"col-1",onClick:a[3]||(a[3]=f=>r.value=!r.value)}),s(le,{modelValue:g.value.phone,"onUpdate:modelValue":a[4]||(a[4]=f=>g.value.phone=f),class:"col-9",dense:"",outlined:"",label:"Телефон",mask:"+# (###) ###-##-##",type:"tel"},null,8,["modelValue"]),s(k,{name:"save",size:"30px",color:"green",class:"col-2",onClick:a[5]||(a[5]=f=>I())})])),w("div",Ze,[s(oe,{modelValue:$(o).addressId,"onUpdate:modelValue":a[6]||(a[6]=f=>$(o).addressId=f),options:$(o).addresses,class:"col-10",dense:"",outlined:"",label:"Адрес","emit-value":"","map-options":"","option-label":"address_line","option-value":"id"},{option:h(f=>[s(Se,_e(f.itemProps,{class:"justify-between flex"}),{default:h(()=>[s(Ae,{onClick:F=>p(f.opt)},{default:h(()=>[s(je,null,{default:h(()=>[xe(B(f.opt?.address_line),1)]),_:2},1024)]),_:2},1032,["onClick"]),s(N,null,{default:h(()=>[s(k,{class:"q-mr-sm",color:"red",name:"delete",size:"26px",onClick:F=>y(f.opt)},null,8,["onClick"]),s(k,{color:"green",name:"edit",size:"26px",onClick:F=>C(f.opt)},null,8,["onClick"])]),_:2},1024)]),_:2},1040)]),_:1},8,["modelValue","options"]),s(k,{name:"add",size:"34px",color:"green",class:"col-2",onClick:a[7]||(a[7]=f=>u())})])]),_:1})]),_:1}),s($(Ne))]),m.value?(z(),R(Pe,{key:0,modelValue:m.value,"onUpdate:modelValue":a[8]||(a[8]=f=>m.value=f),newAddress:S.value},null,8,["modelValue","newAddress"])):ae("",!0)])}}});export{ut as default};
