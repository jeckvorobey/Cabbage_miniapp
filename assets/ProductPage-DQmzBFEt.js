import{Q as M,a as E}from"./QUploader-FikPbgqG.js";import{d as G,ay as T,aa as H,r as k,o as K,ab as p,ac as r,ai as u,f as i,ad as q,ao as l,ak as c,a4 as w,ah as S,aq as v,as as g,U as D,af as h,az as W,aG as P}from"./index-DiTKrkak.js";import{Q as C}from"./QSelect-DuuIiYG7.js";import{Q as X}from"./QForm-BQVW_lD2.js";import{C as I}from"./ClosePopup-C5CDFmFm.js";import{u as Y}from"./use-quasar-_FxUXvHL.js";import{u as Z}from"./productsStore-7M8FESY1.js";import{P as Q}from"./ProductImgCarusel-BzfIFxYp.js";import{u as ee}from"./usePermissionVisibility.hook-UxsiyQLD.js";import{u as ae}from"./categoriesStore-C61Wq8FX.js";import{u as te}from"./unitsStore-BJZK98Qc.js";import{e as oe}from"./orderStore-BhEteGSL.js";import{f as ie,r as y}from"./useUtils-BZuzCZeZ.js";import{_ as se}from"./_plugin-vue_export-helper-DlAUqK2U.js";import"./format-CJebrXOQ.js";import"./QItem-DvDE2n8f.js";import"./QMenu-CzNB_QvR.js";import"./rtl-DFPa-2ov.js";const le={class:"q-pa-md product"},ne={key:0},re={class:"text-h6 q-mb-md"},ue={class:"text-center upload-title"},de={class:"row justify-end"},me={key:1},pe={class:"q-mb-sm"},ce={key:0,class:"q-my-md"},ve={key:1,class:"text-grey old-price"},fe={key:2,class:"q-pa-md bg-light-gray radius-16"},ge={class:"row justify-end"},ye={key:1,class:"row"},be={class:"bg-green q-pa-xs radius-100"},_e={class:"q-mx-sm self-center"},ke={class:"bg-green q-pa-xs radius-100"},qe=G({__name:"ProductPage",emits:["refresh-data","add-product"],setup(we,{emit:U}){const d=Y(),F=U,V=T(),R=H(),f=Z(),B=ae(),s=oe(),N=te(),b=k(),{isManager:$}=ee(),e=k({id:null,name:"",price:null,category_id:null,unit_id:null,description:"",images:"",origin_country:"",unit:null}),m=k([]),n=new FormData;K(()=>{_()});function x(t,a){if(a)t.quantity+=1,window.localStorage.setItem("basket",JSON.stringify(s.basketData));else{if(t.quantity===1){const o=s.basketData.find(L=>L.id===t.id);s.basketData.splice(o,1),m.value=[],window.localStorage.setItem("basket",JSON.stringify(s.basketData));return}t.quantity-=1,window.localStorage.setItem("basket",JSON.stringify(s.basketData))}}function z(t){try{if(d.loading.show(),t.quantity=1,t.product_id=t.id,d.loading.show(),!s.basketData.length)s.basketData.push(structuredClone(P(t))),m.value=s.basketData.find(a=>a.id===t.id);else{const a=s.basketData.find(o=>o.id===t.id);a?a.quantity+=1:s.basketData.push(structuredClone(P(t)))}window.localStorage.setItem("basket",JSON.stringify(s.basketData))}catch(a){console.error(a)}finally{d.loading.hide()}}async function O(){try{let t=null;e.value?.id?t=f.updateProduct(e.value):(J(),t=await f.createProduct(n)),t&&(e.value.id=t.id,d.notify({message:"Успешно сохранено",color:"primary"}),F("refresh-data"),R.back())}catch(t){console.error(t)}}function J(){e?.value?.id&&n.append("id",e.value.id.toString()),e.value?.name&&n.append("name",e.value.name),e.value?.price&&n.append("price",e.value.price.toString()),e.value?.category_id&&n.append("category_id",e.value.category_id.toString()),e.value?.unit_id&&n.append("unit_id",e.value.unit_id.toString()),e.value?.qty&&n.append("qty",e.value.qty.toString()),e.value?.description&&n.append("description",e.value.description),e.value?.origin_country&&n.append("origin_country",e.value.origin_country)}function j(t){const a=new FileReader;a.readAsDataURL(t[0]),a.onload=()=>{},n.append("images",t[0]),e.value?.id&&A(t[0])}async function A(t){const a=new FormData;a.append("file",t),a.append("is_primary","true");try{await f.uploadFile(e.value.id,a)&&(_(),d.notify({message:"Картинка успешно добавлена",color:"primary"}))}catch(o){console.error(o)}finally{b.value&&b.value.reset()}}async function _(){if(V?.params?.id)try{d.loading.show();const t=await f.fetchProductsById(+V.params.id);t&&(e.value=t,e.value.id&&(m.value=s.basketData.find(a=>a.id===e.value.id)))}catch(t){console.error(t)}finally{d.loading.hide()}}return(t,a)=>(r(),p("div",le,[u($)?(r(),p("div",ne,[i(X,{greedy:"",onSubmit:a[8]||(a[8]=o=>O())},{default:q(()=>[l("div",re,c(e.value.id?"Редактирование товара":"Добавление товара"),1),i(M,{ref_key:"uploaderRef",ref:b,color:"primary",flat:"","max-file-size":"15728640",onAdded:j,onRejected:a[0]||(a[0]=o=>u(ie)(u(d)))},{header:q(()=>[...a[12]||(a[12]=[])]),list:q(()=>[i(E),l("div",ue,[i(w,{class:"q-mr-sm",name:"note_add",size:"24px"}),a[13]||(a[13]=l("span",null,"Загрузить картинку",-1))])]),_:1},512),l("div",null,[e.value?.images?.length?(r(),S(Q,{key:0,onRefreshData:a[1]||(a[1]=o=>_()),images:e.value.images},null,8,["images"])):v("",!0)]),i(g,{rules:[u(y)],modelValue:e.value.name,"onUpdate:modelValue":a[2]||(a[2]=o=>e.value.name=o),class:"q-mb-xs",outlined:"",label:"Наименование товара *"},null,8,["rules","modelValue"]),i(g,{rules:[u(y)],modelValue:e.value.price,"onUpdate:modelValue":a[3]||(a[3]=o=>e.value.price=o),class:"q-mb-xs",outlined:"",label:"Стоимость товара *"},null,8,["rules","modelValue"]),i(g,{modelValue:e.value.origin_country,"onUpdate:modelValue":a[4]||(a[4]=o=>e.value.origin_country=o),class:"q-mb-xs",outlined:"",label:"Страна происхождения"},null,8,["modelValue"]),i(C,{rules:[u(y)],modelValue:e.value.category_id,"onUpdate:modelValue":a[5]||(a[5]=o=>e.value.category_id=o),options:u(B).categories,class:"q-mb-xs",outlined:"",label:"Категория *","emit-value":"","map-options":"","option-label":"name","option-value":"id"},null,8,["rules","modelValue","options"]),i(C,{rules:[u(y)],modelValue:e.value.unit_id,"onUpdate:modelValue":a[6]||(a[6]=o=>e.value.unit_id=o),options:u(N).units,outlined:"",label:"Единица измерения *","emit-value":"","map-options":"","option-label":"name","option-value":"id"},null,8,["rules","modelValue","options"]),i(g,{class:"q-mt-sm q-mb-sm",modelValue:e.value.description,"onUpdate:modelValue":a[7]||(a[7]=o=>e.value.description=o),outlined:"",type:"textarea",rows:"2",label:"Описание"},null,8,["modelValue"]),l("div",de,[D(i(h,{color:"green",label:"Подтвердить",type:"submit"},null,512),[[I]])])]),_:1})])):(r(),p("div",me,[e.value?.images?.length?(r(),S(Q,{key:0,images:e.value.images},null,8,["images"])):v("",!0),l("div",pe,[e.value?.name?(r(),p("h6",ce,c(e.value.name),1)):v("",!0),e.value?.old_price?(r(),p("div",ve,c(e.value.old_price)+" ₽",1)):v("",!0),l("div",{class:W(["text-bold text-18 q-mb-md",e.value?.old_price?"text-red":""])},c(e.value.price)+" ₽/ "+c(e.value.unit_name),3),e.value.description?(r(),p("div",fe,c(e.value.description),1)):v("",!0)]),l("div",ge,[m.value?.id?(r(),p("div",ye,[l("div",be,[i(w,{name:"remove",color:"white",size:"30px",onClick:a[10]||(a[10]=o=>x(m.value,!1))})]),l("span",_e,c(m.value.quantity),1),l("div",ke,[i(w,{name:"add",color:"white",size:"30px",onClick:a[11]||(a[11]=o=>x(m.value,!0))})])])):D((r(),S(h,{key:0,color:"green",label:"Добавить в корзину",onClick:a[9]||(a[9]=o=>z(e.value))},null,512)),[[I]])])]))]))}}),je=se(qe,[["__scopeId","data-v-5f4d1289"]]);export{je as default};
