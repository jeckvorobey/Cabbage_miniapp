import{Q as j,a as M}from"./QUploader-DcC99t30.js";import{d as E,aA as L,ac as T,r as k,o as W,ad as p,ae as r,ak as c,f as i,af as w,aq as l,am as f,a6 as x,aj as S,as as g,au as v,W as I,ah as h,aB as G,aI as H}from"./index-QYs-sq1g.js";import{Q as K}from"./QSelect-CzjX4nQi.js";import{Q as X}from"./QForm-j_TDaI1L.js";import{C as P}from"./ClosePopup-SeouTMeF.js";import{u as Y}from"./use-quasar-DCMYxd1-.js";import{u as Z}from"./productsStore-kG-NF2uo.js";import{P as Q}from"./ProductImgCarusel-P5GOF4vQ.js";import{u as ee}from"./usePermissionVisibility.hook-BUDi5VCG.js";import{u as ae}from"./categoriesStore-tq86jMHr.js";import{e as te}from"./orderStore-DTAQl6qR.js";import{r as b}from"./useUtils-D1qfa-Lo.js";import{_ as oe}from"./_plugin-vue_export-helper-DlAUqK2U.js";import"./format-CJebrXOQ.js";import"./QItem-CPrP6kgQ.js";import"./QMenu-k34tiidw.js";import"./rtl-DFPa-2ov.js";const ie={class:"q-pa-md product"},se={key:0},le={class:"text-h6 q-mb-md"},ne={class:"text-center upload-title"},re={class:"row justify-end"},ue={key:1},de={class:"q-mb-sm"},me={key:0,class:"q-my-md"},pe={key:1,class:"text-grey old-price"},ce={class:"row justify-end"},fe={key:1,class:"row"},ve={class:"bg-green q-pa-xs radius-100"},ye={class:"q-mx-sm self-center"},ge={class:"bg-green q-pa-xs radius-100"},be=E({__name:"ProductPage",emits:["refresh-data","add-product"],setup(_e,{emit:C}){const d=Y(),F=C,V=L(),N=T(),y=Z(),U=ae(),s=te(),_=k(),{isManager:B}=ee(),e=k({id:null,name:"",price:null,category_id:null,unit_id:null,description:"",images:"",origin_country:"",unit:null}),u=k([]),n=new FormData;W(()=>{q()});function D(t,a){const o=typeof t.quantity=="string"?parseInt(t.quantity,10):Number(t.quantity)||1;if(a)t.quantity=o+1,window.localStorage.setItem("basket",JSON.stringify(s.basketData));else{if(o===1){const m=s.basketData.findIndex(J=>J.id===t.id);m!==-1&&s.basketData.splice(m,1),u.value=[],window.localStorage.setItem("basket",JSON.stringify(s.basketData));return}t.quantity=o-1,window.localStorage.setItem("basket",JSON.stringify(s.basketData))}}function R(t){try{d.loading.show();const a={...structuredClone(H(t)),quantity:1,product_id:t.id,price:typeof t.price=="string"?parseFloat(t.price):Number(t.price)||0};if(!s.basketData.length)s.basketData.push(a),u.value=s.basketData.find(o=>o.id===t.id);else{const o=s.basketData.find(m=>m.id===t.id);if(o){const m=typeof o.quantity=="string"?parseInt(o.quantity,10):Number(o.quantity)||0;o.quantity=m+1}else s.basketData.push(a)}window.localStorage.setItem("basket",JSON.stringify(s.basketData))}catch(a){console.error(a)}finally{d.loading.hide()}}async function O(){try{let t=null;e.value?.id?t=y.updateProduct(e.value):(z(),t=await y.createProduct(n)),t&&(e.value.id=t.id,d.notify({message:"Успешно сохранено",color:"primary"}),F("refresh-data"),N.back())}catch(t){console.error(t)}}function z(){e?.value?.id&&n.append("id",e.value.id.toString()),e.value?.name&&n.append("name",e.value.name),e.value?.price&&n.append("price",e.value.price.toString()),e.value?.category_id&&n.append("category_id",e.value.category_id.toString()),e.value?.unit_id&&n.append("unit_id",e.value.unit_id.toString()),e.value?.qty&&n.append("qty",e.value.qty.toString()),e.value?.description&&n.append("description",e.value.description),e.value?.origin_country&&n.append("origin_country",e.value.origin_country)}function $(t){const a=new FileReader;a.readAsDataURL(t[0]),a.onload=()=>{},n.append("images",t[0]),e.value?.id&&A(t[0])}async function A(t){const a=new FormData;a.append("file",t),a.append("is_primary","true");try{await y.uploadFile(e.value.id,a)&&(q(),d.notify({message:"Картинка успешно добавлена",color:"primary"}))}catch(o){console.error(o)}finally{_.value&&_.value.reset()}}async function q(){if(V?.params?.id)try{d.loading.show();const t=await y.fetchProductsById(+V.params.id);t&&(e.value=t,e.value.id&&(u.value=s.basketData.find(a=>a.id===e.value.id)))}catch(t){console.error(t)}finally{d.loading.hide()}}return(t,a)=>(r(),p("div",ie,[c(B)?(r(),p("div",se,[i(X,{greedy:"",onSubmit:a[7]||(a[7]=o=>O())},{default:w(()=>[l("div",le,f(e.value.id?"Редактирование товара":"Добавление товара"),1),i(j,{ref_key:"uploaderRef",ref:_,color:"primary",flat:"","max-file-size":15728640,onAdded:$},{header:w(()=>[...a[11]||(a[11]=[])]),list:w(()=>[i(M),l("div",ne,[i(x,{class:"q-mr-sm",name:"note_add",size:"24px"}),a[12]||(a[12]=l("span",null,"Загрузить картинку",-1))])]),_:1},512),l("div",null,[e.value?.images?.length?(r(),S(Q,{key:0,onRefreshData:a[0]||(a[0]=o=>q()),images:e.value.images},null,8,["images"])):g("",!0)]),i(v,{rules:[c(b)],modelValue:e.value.name,"onUpdate:modelValue":a[1]||(a[1]=o=>e.value.name=o),class:"q-mb-xs",outlined:"",label:"Наименование товара *"},null,8,["rules","modelValue"]),i(v,{rules:[c(b)],modelValue:e.value.price,"onUpdate:modelValue":a[2]||(a[2]=o=>e.value.price=o),class:"q-mb-xs",outlined:"",label:"Стоимость товара *"},null,8,["rules","modelValue"]),i(v,{rules:[c(b)],modelValue:e.value.qty,"onUpdate:modelValue":a[3]||(a[3]=o=>e.value.qty=o),class:"q-mb-xs",outlined:"",label:"Количество*"},null,8,["rules","modelValue"]),i(v,{modelValue:e.value.origin_country,"onUpdate:modelValue":a[4]||(a[4]=o=>e.value.origin_country=o),class:"q-mb-xs",outlined:"",label:"Страна происхождения"},null,8,["modelValue"]),i(K,{rules:[c(b)],modelValue:e.value.category_id,"onUpdate:modelValue":a[5]||(a[5]=o=>e.value.category_id=o),options:c(U).categories,class:"q-mb-xs",outlined:"",label:"Категория *","emit-value":"","map-options":"","option-label":"name","option-value":"id"},null,8,["rules","modelValue","options"]),i(v,{class:"q-mt-sm q-mb-sm",modelValue:e.value.description,"onUpdate:modelValue":a[6]||(a[6]=o=>e.value.description=o),outlined:"",type:"textarea",rows:"2",label:"Описание"},null,8,["modelValue"]),l("div",re,[I(i(h,{color:"green",label:"Подтвердить",type:"submit"},null,512),[[P]])])]),_:1})])):(r(),p("div",ue,[e.value?.images?.length?(r(),S(Q,{key:0,images:e.value.images},null,8,["images"])):g("",!0),l("div",de,[e.value?.name?(r(),p("h6",me,f(e.value.name),1)):g("",!0),e.value?.old_price?(r(),p("div",pe,f(e.value.old_price)+" ₽",1)):g("",!0),l("div",{class:G(["text-bold text-18 q-mb-md",e.value?.old_price?"text-red":""])},f(e.value.price)+" ₽/шт. ",3)]),l("div",ce,[u.value?.id?(r(),p("div",fe,[l("div",ve,[i(x,{name:"remove",color:"white",size:"30px",onClick:a[9]||(a[9]=o=>D(u.value,!1))})]),l("span",ye,f(u.value.quantity),1),l("div",ge,[i(x,{name:"add",color:"white",size:"30px",onClick:a[10]||(a[10]=o=>D(u.value,!0))})])])):I((r(),S(h,{key:0,color:"green",label:"Добавить в корзину",onClick:a[8]||(a[8]=o=>R(e.value))},null,512)),[[P]])])]))]))}}),Oe=oe(be,[["__scopeId","data-v-7a09d0f5"]]);export{Oe as default};
