import{Q as fe}from"./QImg-D7JsG_-T.js";import{V as H,r as V,g as J,X as B,Y as O,ae as pe,Z as h,$ as s,a0 as le,ab as W,aa as se,_,a6 as T,ac as oe,aq as ie,ad as ve,a7 as ge,z as K,ar as z,m as Z,y as I,n as D,J as ye,i as U,h as re,aj as he,as as be,p as N,u as we,at as ee,au as _e,W as xe,a1 as R,a4 as P,Q as A,av as Ve,a5 as Se}from"./index-Cb42uLnq.js";import{u as ue,Q as ke}from"./addressesStore-CdZ-vJhg.js";import{Q as Ae,a as je,b as Ce}from"./QItem-Ztu8n8Rq.js";import{Q as de}from"./QSelect-DOo4qsdh.js";import{u as ce,g as Me}from"./use-quasar-DtEi0dok.js";import{Q as Ie}from"./QForm-BO9dz4wA.js";import{C as Oe}from"./ClosePopup-CoX4KbeS.js";import{u as Qe}from"./usersStore-B-UZBu0x.js";import{V as S,s as ze,i as te,t as $,c as ae}from"./vue-yandex-maps-DuxZSi-J.js";import{u as Pe}from"./usePermissionVisibility.hook-grfTrSDZ.js";import"./QMenu-CFuHpr6B.js";import"./rtl-DFPa-2ov.js";import"./format-CJebrXOQ.js";const $e={class:"row q-pl-sm flex-center justify-between"},Ue={class:"text-grey-6"},Ye=H({__name:"AddAddressModal",props:{newAddress:{}},setup(e){const a=[[55.97,37.12],[56.02,37.33]],o=e,t=ce(),i=ue(),w=V(!0),v=V(),c=V({address_line:"",area_id:null,comment:"",is_default:!1}),b=V([]),x=V(!1),g=V("Начните вводить адрес...");J(async()=>{try{c.value=o.newAddress??{address_line:"",area_id:null,comment:"",is_default:!1},t.loading.show();const p=await i.fetchDeliveryZones();p&&(i.deliveryZones=p)}catch(p){console.error(p)}finally{t.loading.hide()}});async function j(){if(c.value)try{await(c.value?.id?i.updateAddress:i.createAddress)(c.value),v.value?.hide()}catch(p){console.error(p)}}async function m(p,r){if(!p){g.value="Начните вводить адрес...",r(()=>{b.value=[]});return}const y=window.ymaps;if(!y){t.notify({message:"Сервис карт недоступен.",type:"negative"});return}x.value=!0;try{const u=(await y.geocode(p,{boundedBy:a,results:5,strictBounds:!0})).geoObjects.toArray().map(l=>({coords:l.geometry.getCoordinates(),displayName:l.properties.get("text")}));r(()=>{b.value=u,g.value=u.length?"Выберите адрес из списка":"Адрес не найден"})}catch(C){console.error("Ошибка геокодирования:",C)}finally{x.value=!1}}return(p,r)=>(O(),B(pe,{ref_key:"dialogRef",ref:v,modelValue:w.value,"onUpdate:modelValue":r[4]||(r[4]=y=>w.value=y),persistent:""},{default:h(()=>[s(le,{class:""},{default:h(()=>[s(Ie,{greedy:"",onSubmit:r[3]||(r[3]=y=>j())},{default:h(()=>[c.value?(O(),B(se,{key:0},{default:h(()=>[r[5]||(r[5]=_("div",{class:"text-h6"},"Создание нового адреса доставки",-1)),s(de,{modelValue:c.value.address_line,"onUpdate:modelValue":r[0]||(r[0]=y=>c.value.address_line=y),class:"q-mb-sm",clearable:"",outlined:"",behavior:"menu","use-input":"","emit-value":"","map-options":"",options:b.value,"option-label":"displayName","option-value":"displayName",label:"Адрес доставки",onFilter:m},{"no-option":h(()=>[_("div",$e,[_("div",Ue,T(g.value),1)])]),_:1},8,["modelValue","options"]),s(oe,{modelValue:c.value.comment,"onUpdate:modelValue":r[1]||(r[1]=y=>c.value.comment=y),label:"Комментарий",outlined:"",type:"textarea",rows:"3"},null,8,["modelValue"]),s(ie,{modelValue:c.value.is_default,"onUpdate:modelValue":r[2]||(r[2]=y=>c.value.is_default=y),label:"Активный аддрес"},null,8,["modelValue"])]),_:1})):W("",!0),s(ve,{align:"right"},{default:h(()=>[ge(s(K,{color:"red",flat:"",label:"Отмена"},null,512),[[Oe]]),s(K,{color:"primary",flat:"",label:"Сохранить",type:"submit"})]),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue"]))}}),G=e=>e instanceof Date,qe=e=>Object.keys(e).length===0,F=e=>e!=null&&typeof e=="object",ne=(e,...a)=>Object.prototype.hasOwnProperty.call(e,...a),E=e=>F(e)&&qe(e),Ne=()=>Object.create(null),me=(e,a)=>{if(e===a)return{};if(!F(e)||!F(a))return a;const o=Object.keys(e).reduce((t,i)=>(ne(a,i)||(t[i]=void 0),t),Ne());return G(e)||G(a)?e.valueOf()==a.valueOf()?{}:a:Object.keys(a).reduce((t,i)=>{if(!ne(e,i))return t[i]=a[i],t;const w=me(e[i],a[i]);return E(w)&&!G(w)&&(E(e[i])||!E(a[i]))||(t[i]=w),t},o)};function Te(){re()||$({text:"injectMap must be only called on runtime.",isInternal:!0});const e=he("map");return(!e||!be(e))&&$({text:"Was not able to inject valid map in injectMap.",isInternal:!0}),e}async function Be({map:e,timeoutCallback:a,waitDuration:o}={}){!e&&!re()&&$({text:"onMapInit must be only called on runtime.",isInternal:!0}),typeof window>"u"&&$({text:"waitTillMapInit cannot be called on SSR.",isInternal:!0});const t=e||Te();if(!t.value)return new Promise((i,w)=>{let v;o=typeof o<"u"?o:S.settings.value.mapsRenderWaitDuration,o!==!1&&(v=setTimeout(()=>{a?.(v,!0),w(new S.YandexMapException("Was not able to wait for map initialization in waitTillMapInit. You can change this behavior by using mapsRenderWaitDuration."))},typeof o=="number"?o:5e3),a?.(v,!1));let c;c=I(t,()=>{t.value&&(c?.(),v&&(clearTimeout(v),a?.(v,!0)),i())},{immediate:!0})})}const Le=H({name:"YandexMap",props:{modelValue:{type:Object,default:null},value:{type:Object,default:null},tag:{type:String,default:"div"},width:{type:String,default:"100%"},height:{type:String,default:"100%"},zIndex:{type:Number,default:0},settings:{type:Object,required:!0},readonlySettings:{type:Boolean,default:!1},realSettingsLocation:{type:Boolean,default:!1},layers:{type:Array,default:(()=>[])},cursorGrab:{type:Boolean,default:!1}},emits:{input(e){return!e||typeof ymaps3>"u"||e instanceof ymaps3.YMap},"update:modelValue"(e){return!e||typeof ymaps3>"u"||e instanceof ymaps3.YMap}},slots:Object,setup(e,{slots:a,emit:o}){const t=z(null),i=z(null),w=z([]),v=z(null),c=z(null),b=z(!1),x=V(0);N("map",t),N("layers",w),N("projection",v),N("needsToHold",x),o("input",null),o("update:modelValue",null);const g=Z(()=>({...e.settings,projection:void 0})),j=async()=>{e.settings.location||$({text:"You must specify location in YandexMap settings"}),t.value&&t.value.destroy();const u=c.value;if(!u)return;const l=g.value;v.value&&(l.projection=v.value),t.value=new ymaps3.YMap(u,l,[...w.value,...e.layers]),o("input",t.value),o("update:modelValue",t.value)};let m,p,r=null;async function y(){await Be({map:t,timeoutCallback:(u,l)=>{l?r=null:r=u}}).catch(()=>{}),t.value&&(e.cursorGrab?(m=new ymaps3.YMapListener({onActionStart:u=>{u.type==="drag"&&e.cursorGrab&&i.value?.classList.add("__ymap--grabbing")},onActionEnd:u=>{u.type==="drag"&&i.value?.classList.remove("__ymap--grabbing")}}),t.value.addChild(m)):m&&t.value.removeChild(m))}let C=!1;return I(S.loadStatus,async u=>{if(u==="pending"){C=!0,b.value=!1;return}u!=="loaded"&&!C||(b.value=!0,await D(),x.value&&await new Promise(l=>I(x,()=>{x.value||l()},{immediate:!0})),await j())}),J(async()=>{const u=()=>{p?.();let l=ae(g);p=I(g,Q=>{if(!t.value)return;const k=ae(Q);e.realSettingsLocation&&k.location&&("center"in k.location&&"center"in l.location?l.location.center=t.value.center:"bounds"in k.location&&"bounds"in l.location&&(l.location.bounds=t.value.bounds),"zoom"in k.location&&"zoom"in l.location&&(l.location.zoom=t.value.zoom));const Y=Object.keys(me(l,k));if(Y.length===0)return;const M={...k};for(const q in M)Y.includes(q)||delete M[q];l=k,t.value?.update(M)},{deep:!0})};if(e.readonlySettings||u(),I(()=>e.readonlySettings,l=>{l?u():p?.()}),I(()=>e.cursorGrab,y,{immediate:!0}),await ze(),!S.isLoaded.value){if(S.settings.value.initializeOn==="onComponentMount")try{await te()}catch(l){console.error("An error occured while initializing Yandex Map with onComponentMount setting"),console.error(l);return}else(S.loadStatus.value==="loading"||S.settings.value.initializeOn==="onPluginInit")&&(S.settings.value.initializeOn==="onPluginInit"&&S.loadStatus.value!=="loading"&&await D(),await te());S.isLoaded.value||$({text:"You have set up <yandex-map> component without initializing Yandex maps. Please check initializeOn setting or call initYmaps manually before registering this component."})}b.value=!0,await D(),x.value&&await new Promise(l=>I(x,()=>{x.value||l()},{immediate:!0})),await j()}),ye(()=>{r&&clearTimeout(r),t.value&&t.value.destroy(),t.value=null,o("input",t.value),o("update:modelValue",t.value)}),()=>{const u={class:["__ymap",{"__ymap--grab":e.cursorGrab}],ref:i,style:{width:e.width,height:e.height,"z-index":e.zIndex.toString()}},l=U("div",{class:"__ymap_container",ref:c}),Q={class:"__ymap_slots",style:{display:"none"}};return b.value?U(e.tag,u,[l,U("div",Q,a.default?.({}))]):U(e.tag,u,[l,U("div",Q)])}}}),De={class:"q-pa-sm"},Re={class:"justify-center row q-mb-md"},Ge={class:"text-h5 justify-between q-mb-sm row"},Ee={class:"items-center"},We={class:"items-center"},Ze={key:0,class:"row items-center q-mb-sm text-h6"},Fe={style:{height:"40px"},class:"col-10 content-center"},He={key:1,class:"row items-center q-mb-sm"},Je={class:"row items-center q-mb-sm"},mt=H({__name:"UserPage",setup(e){const a=ce(),o=ue(),t=Qe(),i=we(),w=Z(()=>ee.isActive),{isManagerWithoutIsUser:v}=Pe(),c=_e({dark:"dark",light:"light"}),b=V(!1),x=Z(()=>w.value?c.dark:c.light),g=V(!1),j=V("dark"),m=V({addres:null,full_name:"",mail:"",phone:""}),p=V(null);J(()=>{m.value=i.user,M()});function r(f){f.is_default=!0,m.value.addres=f,l(f)}function y(){p.value=null,g.value=!g.value}async function C(f){try{a.loading.show(),await o.deleteAddress(f.id)&&M()}catch(n){console.error(n)}finally{a.loading.hide()}}function u(f){p.value=f,g.value=!g.value}async function l(f){try{a.loading.show(),await o.updateAddress(f)&&M()}catch(n){console.error(n)}finally{a.loading.hide()}}const Q=()=>{ee.toggle(),window.localStorage.setItem("theme",x.value)};function k(){a.dialog({cancel:!0,message:"Вы уверенны что хотите изменить номер?",persistent:!0,title:"Смена номера телефона"}).onOk(()=>{Y()})}async function Y(){try{a.loading.show(),await t.updateMyPhone(m.value.phone)}catch(f){console.error(f)}finally{a.loading.hide()}}async function M(){try{a.loading.show();const f=await o.fetchAddresses();if(f){o.addresses=f;const n=f.find(L=>L.is_default===!0);n&&(o.addressId=n.id)}}catch(f){console.error(f)}finally{a.loading.hide()}}async function q(){try{a.loading.show(),await t.updateUserMode(m.value.id)}catch(f){console.error(f)}finally{a.loading.hide()}}return(f,n)=>{const L=xe("q-item-action");return O(),R("div",null,[n[11]||(n[11]=_("h6",{class:"text-center q-mb-md"},"Личный кабинет",-1)),_("div",De,[s(le,{class:"my-card full-height",flat:"",bordered:""},{default:h(()=>[s(se,null,{default:h(()=>[_("div",Re,[s(fe,{class:"radius-100",height:"120px",width:"120px",src:m.value?.main_image_url?m.value.main_image_url:P(Me)("/card-shop.jpg")},null,8,["src"])]),_("div",Ge,[_("div",null,T(m.value.full_name),1),_("div",null,[s(ke,{modelValue:j.value,"onUpdate:modelValue":n[0]||(n[0]=d=>j.value=d),size:"sm","no-caps":"",unelevated:"",dense:"","toggle-color":"grey-9",color:"white","text-color":"grey-9",options:[{value:"dark",slot:"dark",title:"Dark mode"},{value:"light",slot:"light",title:"Light mode"}],onClick:n[1]||(n[1]=d=>Q())},{dark:h(()=>[_("div",Ee,[s(A,{name:"nightlight"})])]),light:h(()=>[_("div",We,[s(A,{name:"light_mode"})])]),_:1},8,["modelValue"])])]),!b.value&&m.value?.phone?(O(),R("div",Ze,[_("div",Fe,T(m.value.phone),1),s(A,{name:"edit",size:"30px",color:"green",class:"col-2",onClick:n[2]||(n[2]=d=>b.value=!b.value)})])):(O(),R("div",He,[s(A,{name:"close",size:"30px",color:"red",class:"col-1",onClick:n[3]||(n[3]=d=>b.value=!b.value)}),s(oe,{modelValue:m.value.phone,"onUpdate:modelValue":n[4]||(n[4]=d=>m.value.phone=d),class:"col-9",dense:"",outlined:"",label:"Телефон",mask:"+# (###) ###-##-##",type:"tel"},null,8,["modelValue"]),s(A,{name:"save",size:"30px",color:"green",class:"col-2",onClick:n[5]||(n[5]=d=>k())})])),_("div",Je,[s(de,{modelValue:P(o).addressId,"onUpdate:modelValue":n[6]||(n[6]=d=>P(o).addressId=d),options:P(o).addresses,class:"col-10",dense:"",outlined:"",label:"Адрес","emit-value":"","map-options":"","option-label":"address_line","option-value":"id"},{option:h(d=>[s(Ae,Ve(d.itemProps,{class:"justify-between flex"}),{default:h(()=>[s(je,{onClick:X=>r(d.opt)},{default:h(()=>[s(Ce,null,{default:h(()=>[Se(T(d.opt?.address_line),1)]),_:2},1024)]),_:2},1032,["onClick"]),s(L,null,{default:h(()=>[s(A,{class:"q-mr-sm",color:"red",name:"delete",size:"26px",onClick:X=>C(d.opt)},null,8,["onClick"]),s(A,{color:"green",name:"edit",size:"26px",onClick:X=>u(d.opt)},null,8,["onClick"])]),_:2},1024)]),_:2},1040)]),_:1},8,["modelValue","options"]),s(A,{name:"add",size:"34px",color:"green",class:"col-2",onClick:n[7]||(n[7]=d=>y())})])]),_:1})]),_:1}),s(P(Le)),P(v)?(O(),B(ie,{key:0,modelValue:m.value.is_user,"onUpdate:modelValue":n[8]||(n[8]=d=>m.value.is_user=d),color:"green",label:"Администратор/Пользователь",onClick:n[9]||(n[9]=d=>q())},null,8,["modelValue"])):W("",!0)]),g.value?(O(),B(Ye,{key:0,modelValue:g.value,"onUpdate:modelValue":n[10]||(n[10]=d=>g.value=d),newAddress:p.value},null,8,["modelValue","newAddress"])):W("",!0)])}}});export{mt as default};
