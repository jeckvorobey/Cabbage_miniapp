import{Q as pe}from"./QImg-IyJNlfK2.js";import{V as H,r as _,m as X,X as L,Y as Q,ad as ve,Z as b,$ as l,a0 as le,a9 as E,aa as se,_ as w,a6 as B,ab as oe,aq as ie,ac as ge,a7 as ye,Q as K,ar as O,f as F,B as I,q as N,M as be,h as q,n as re,ai as he,as as we,w as T,u as _e,at as ee,au as xe,W as Ve,a1 as D,a4 as P,C as j,av as Se,a5 as ke}from"./index-BemvcPyr.js";import{Q as Ae}from"./QBtnToggle-B4iqaVUb.js";import{Q as Me,a as je,b as Ce}from"./QItem-ZOZ4Z8yr.js";import{Q as ue}from"./QSelect-DgqcOdnV.js";import{u as de,g as Ie}from"./use-quasar-qOqJJ0L1.js";import{Q as Qe}from"./QForm-DUMF2_5I.js";import{C as ze}from"./ClosePopup-D1KKjhzk.js";import{u as ce}from"./addressesStore-Dus7lIGJ.js";import{u as Oe}from"./usersStore-9ti0ilVX.js";import{V as S,s as Pe,i as te,t as $,c as ae}from"./vue-yandex-maps-4RkHRAaX.js";import{u as $e}from"./usePermissionVisibility.hook-adEO_bl9.js";import"./QMenu-DnV_Jb4m.js";import"./rtl-DFPa-2ov.js";import"./format-CJebrXOQ.js";const Ye={class:"row q-pl-sm flex-center justify-between"},qe={class:"text-grey-6"},Ue=H({__name:"AddAddressModal",props:{newAddress:{}},emits:["refresh"],setup(e,{emit:n}){const s=e,t=n,i=de(),g=ce(),y=_(!0),V=_(),r=_({address_line:"",area_id:null,comment:"",is_default:!1}),x=_([]),h=_(!1),M=_("Начните вводить адрес...");X(async()=>{try{r.value=s.newAddress??{address_line:"",area_id:null,comment:"",is_default:!1},i.loading.show();const m=await g.fetchDeliveryZones();m&&(g.deliveryZones=m)}catch(m){console.error(m)}finally{t("refresh"),i.loading.hide()}});async function c(){if(r.value)try{await(r.value?.id?g.updateAddress:g.createAddress)(r.value),V.value?.hide()}catch(m){console.error(m)}}async function k(m,p){try{if(!ymaps3){i.notify({message:"Сервис карт недоступен.",type:"negative"});return}const v=await ymaps3.suggest({bounds:[[37.135,55.945],[37.265,56.025]],text:m,types:["biz"]});p(()=>{x.value=v.map(u=>({subtitle:u.subtitle?.text??"",title:u.title?.text??""})),M.value=v.length&&m?"Адрес не найден":"Выберите адрес из списка"})}catch(v){console.error("Ошибка геокодирования:",v)}finally{h.value=!1}}return(m,p)=>(Q(),L(ve,{ref_key:"dialogRef",ref:V,modelValue:y.value,"onUpdate:modelValue":p[4]||(p[4]=v=>y.value=v),persistent:""},{default:b(()=>[l(le,{class:""},{default:b(()=>[l(Qe,{greedy:"",onSubmit:p[3]||(p[3]=v=>c())},{default:b(()=>[r.value?(Q(),L(se,{key:0},{default:b(()=>[p[5]||(p[5]=w("div",{class:"text-h6"},"Создание нового адреса доставки",-1)),l(ue,{modelValue:r.value.address_line,"onUpdate:modelValue":p[0]||(p[0]=v=>r.value.address_line=v),debounce:"800",class:"q-mb-sm",clearable:"",outlined:"",behavior:"menu","use-input":"","emit-value":"","map-options":"",options:x.value,"option-label":"title","option-value":"title",label:"Адрес доставки",onFilter:k},{"no-option":b(()=>[w("div",Ye,[w("div",qe,B(M.value),1)])]),_:1},8,["modelValue","options"]),l(oe,{modelValue:r.value.comment,"onUpdate:modelValue":p[1]||(p[1]=v=>r.value.comment=v),label:"Комментарий",outlined:"",type:"textarea",rows:"3"},null,8,["modelValue"]),l(ie,{modelValue:r.value.is_default,"onUpdate:modelValue":p[2]||(p[2]=v=>r.value.is_default=v),label:"Активный аддрес"},null,8,["modelValue"])]),_:1})):E("",!0),l(ge,{align:"right"},{default:b(()=>[ye(l(K,{color:"red",flat:"",label:"Отмена"},null,512),[[ze]]),l(K,{color:"primary",flat:"",label:"Сохранить",type:"submit"})]),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue"]))}}),G=e=>e instanceof Date,Te=e=>Object.keys(e).length===0,Z=e=>e!=null&&typeof e=="object",ne=(e,...n)=>Object.prototype.hasOwnProperty.call(e,...n),W=e=>Z(e)&&Te(e),Be=()=>Object.create(null),me=(e,n)=>{if(e===n)return{};if(!Z(e)||!Z(n))return n;const s=Object.keys(e).reduce((t,i)=>(ne(n,i)||(t[i]=void 0),t),Be());return G(e)||G(n)?e.valueOf()==n.valueOf()?{}:n:Object.keys(n).reduce((t,i)=>{if(!ne(e,i))return t[i]=n[i],t;const g=me(e[i],n[i]);return W(g)&&!G(g)&&(W(e[i])||!W(n[i]))||(t[i]=g),t},s)};function Le(){re()||$({text:"injectMap must be only called on runtime.",isInternal:!0});const e=he("map");return(!e||!we(e))&&$({text:"Was not able to inject valid map in injectMap.",isInternal:!0}),e}async function Re({map:e,timeoutCallback:n,waitDuration:s}={}){!e&&!re()&&$({text:"onMapInit must be only called on runtime.",isInternal:!0}),typeof window>"u"&&$({text:"waitTillMapInit cannot be called on SSR.",isInternal:!0});const t=e||Le();if(!t.value)return new Promise((i,g)=>{let y;s=typeof s<"u"?s:S.settings.value.mapsRenderWaitDuration,s!==!1&&(y=setTimeout(()=>{n?.(y,!0),g(new S.YandexMapException("Was not able to wait for map initialization in waitTillMapInit. You can change this behavior by using mapsRenderWaitDuration."))},typeof s=="number"?s:5e3),n?.(y,!1));let V;V=I(t,()=>{t.value&&(V?.(),y&&(clearTimeout(y),n?.(y,!0)),i())},{immediate:!0})})}const Ne=H({name:"YandexMap",props:{modelValue:{type:Object,default:null},value:{type:Object,default:null},tag:{type:String,default:"div"},width:{type:String,default:"100%"},height:{type:String,default:"100%"},zIndex:{type:Number,default:0},settings:{type:Object,required:!0},readonlySettings:{type:Boolean,default:!1},realSettingsLocation:{type:Boolean,default:!1},layers:{type:Array,default:(()=>[])},cursorGrab:{type:Boolean,default:!1}},emits:{input(e){return!e||typeof ymaps3>"u"||e instanceof ymaps3.YMap},"update:modelValue"(e){return!e||typeof ymaps3>"u"||e instanceof ymaps3.YMap}},slots:Object,setup(e,{slots:n,emit:s}){const t=O(null),i=O(null),g=O([]),y=O(null),V=O(null),r=O(!1),x=_(0);T("map",t),T("layers",g),T("projection",y),T("needsToHold",x),s("input",null),s("update:modelValue",null);const h=F(()=>({...e.settings,projection:void 0})),M=async()=>{e.settings.location||$({text:"You must specify location in YandexMap settings"}),t.value&&t.value.destroy();const u=V.value;if(!u)return;const o=h.value;y.value&&(o.projection=y.value),t.value=new ymaps3.YMap(u,o,[...g.value,...e.layers]),s("input",t.value),s("update:modelValue",t.value)};let c,k,m=null;async function p(){await Re({map:t,timeoutCallback:(u,o)=>{o?m=null:m=u}}).catch(()=>{}),t.value&&(e.cursorGrab?(c=new ymaps3.YMapListener({onActionStart:u=>{u.type==="drag"&&e.cursorGrab&&i.value?.classList.add("__ymap--grabbing")},onActionEnd:u=>{u.type==="drag"&&i.value?.classList.remove("__ymap--grabbing")}}),t.value.addChild(c)):c&&t.value.removeChild(c))}let v=!1;return I(S.loadStatus,async u=>{if(u==="pending"){v=!0,r.value=!1;return}u!=="loaded"&&!v||(r.value=!0,await N(),x.value&&await new Promise(o=>I(x,()=>{x.value||o()},{immediate:!0})),await M())}),X(async()=>{const u=()=>{k?.();let o=ae(h);k=I(h,z=>{if(!t.value)return;const A=ae(z);e.realSettingsLocation&&A.location&&("center"in A.location&&"center"in o.location?o.location.center=t.value.center:"bounds"in A.location&&"bounds"in o.location&&(o.location.bounds=t.value.bounds),"zoom"in A.location&&"zoom"in o.location&&(o.location.zoom=t.value.zoom));const U=Object.keys(me(o,A));if(U.length===0)return;const Y={...A};for(const C in Y)U.includes(C)||delete Y[C];o=A,t.value?.update(Y)},{deep:!0})};if(e.readonlySettings||u(),I(()=>e.readonlySettings,o=>{o?u():k?.()}),I(()=>e.cursorGrab,p,{immediate:!0}),await Pe(),!S.isLoaded.value){if(S.settings.value.initializeOn==="onComponentMount")try{await te()}catch(o){console.error("An error occured while initializing Yandex Map with onComponentMount setting"),console.error(o);return}else(S.loadStatus.value==="loading"||S.settings.value.initializeOn==="onPluginInit")&&(S.settings.value.initializeOn==="onPluginInit"&&S.loadStatus.value!=="loading"&&await N(),await te());S.isLoaded.value||$({text:"You have set up <yandex-map> component without initializing Yandex maps. Please check initializeOn setting or call initYmaps manually before registering this component."})}r.value=!0,await N(),x.value&&await new Promise(o=>I(x,()=>{x.value||o()},{immediate:!0})),await M()}),be(()=>{m&&clearTimeout(m),t.value&&t.value.destroy(),t.value=null,s("input",t.value),s("update:modelValue",t.value)}),()=>{const u={class:["__ymap",{"__ymap--grab":e.cursorGrab}],ref:i,style:{width:e.width,height:e.height,"z-index":e.zIndex.toString()}},o=q("div",{class:"__ymap_container",ref:V}),z={class:"__ymap_slots",style:{display:"none"}};return r.value?q(e.tag,u,[o,q("div",z,n.default?.({}))]):q(e.tag,u,[o,q("div",z)])}}}),De={class:"q-pa-sm"},Ge={class:"justify-center row q-mb-md"},We={class:"text-h5 justify-between q-mb-sm row"},Ee={class:"items-center"},Fe={class:"items-center"},Ze={key:0,class:"row items-center q-mb-sm text-h6"},He={style:{height:"40px"},class:"col-10 content-center"},Xe={key:1,class:"row items-center q-mb-sm"},Je={class:"row items-center q-mb-sm"},pt=H({__name:"UserPage",setup(e){const n=de(),s=ce(),t=Oe(),i=_e(),g=F(()=>ee.isActive),{isManagerWithoutIsUser:y}=$e(),V=xe({dark:"dark",light:"light"}),r=_(!1),x=F(()=>g.value?V.dark:V.light),h=_(!1),M=_("dark"),c=_({addres:null,full_name:"",mail:"",phone:""}),k=_(),m=_(null);X(()=>{c.value=i.user,C()});function p(f){f.is_default=!0,c.value.addres=f,z(f)}function v(){m.value=null,h.value=!h.value}async function u(f){try{n.loading.show(),await s.deleteAddress(f.id)&&C()}catch(a){console.error(a)}finally{n.loading.hide()}}function o(f){m.value=f,h.value=!h.value}async function z(f){try{n.loading.show(),await s.updateAddress(f)&&C()}catch(a){console.error(a)}finally{n.loading.hide()}}const A=()=>{ee.toggle(),window.localStorage.setItem("theme",x.value)};function U(){n.dialog({cancel:!0,message:"Вы уверенны что хотите изменить номер?",persistent:!0,title:"Смена номера телефона"}).onOk(()=>{Y()})}async function Y(){c.value.phone=k.value;try{n.loading.show(),await t.updateMyPhone(c.value.phone)}catch(f){console.error(f)}finally{n.loading.hide()}}async function C(){try{n.loading.show();const f=await s.fetchAddresses();if(f){s.addresses=f;const a=f.find(R=>R.is_default===!0);a&&(s.addressId=a.id)}}catch(f){console.error(f)}finally{n.loading.hide()}}async function fe(){try{n.loading.show(),await t.updateUserMode(c.value.id)}catch(f){console.error(f)}finally{n.loading.hide()}}return(f,a)=>{const R=Ve("q-item-action");return Q(),D("div",null,[a[12]||(a[12]=w("h6",{class:"text-center q-mb-md"},"Личный кабинет",-1)),w("div",De,[l(le,{class:"my-card full-height",flat:"",bordered:""},{default:b(()=>[l(se,null,{default:b(()=>[w("div",Ge,[l(pe,{class:"radius-100",height:"120px",width:"120px",src:c.value?.main_image_url?c.value.main_image_url:P(Ie)("/card-shop.jpg")},null,8,["src"])]),w("div",We,[w("div",null,B(c.value.full_name),1),w("div",null,[l(Ae,{modelValue:M.value,"onUpdate:modelValue":a[0]||(a[0]=d=>M.value=d),size:"sm","no-caps":"",unelevated:"",dense:"","toggle-color":"grey-9",color:"white","text-color":"grey-9",options:[{value:"dark",slot:"dark",title:"Dark mode"},{value:"light",slot:"light",title:"Light mode"}],onClick:a[1]||(a[1]=d=>A())},{dark:b(()=>[w("div",Ee,[l(j,{name:"nightlight"})])]),light:b(()=>[w("div",Fe,[l(j,{name:"light_mode"})])]),_:1},8,["modelValue"])])]),!r.value&&c.value?.phone?(Q(),D("div",Ze,[w("div",He,B(c.value.phone),1),l(j,{name:"edit",size:"30px",color:"green",class:"col-2",onClick:a[2]||(a[2]=d=>r.value=!r.value)})])):(Q(),D("div",Xe,[l(j,{name:"close",size:"30px",color:"red",class:"col-1",onClick:a[3]||(a[3]=d=>r.value=!r.value)}),l(oe,{modelValue:k.value,"onUpdate:modelValue":a[4]||(a[4]=d=>k.value=d),class:"col-9",dense:"",outlined:"",label:"Телефон",mask:"+# (###) ###-##-##",type:"tel"},null,8,["modelValue"]),l(j,{name:"save",size:"30px",color:"green",class:"col-2",onClick:a[5]||(a[5]=d=>U())})])),w("div",Je,[l(ue,{modelValue:P(s).addressId,"onUpdate:modelValue":a[6]||(a[6]=d=>P(s).addressId=d),options:P(s).addresses,class:"col-10",dense:"",outlined:"",label:"Адрес","emit-value":"","map-options":"","option-label":"address_line","option-value":"id"},{option:b(d=>[l(Me,Se(d.itemProps,{class:"justify-between flex"}),{default:b(()=>[l(je,{onClick:J=>p(d.opt)},{default:b(()=>[l(Ce,null,{default:b(()=>[ke(B(d.opt?.address_line),1)]),_:2},1024)]),_:2},1032,["onClick"]),l(R,null,{default:b(()=>[l(j,{class:"q-mr-sm",color:"red",name:"delete",size:"26px",onClick:J=>u(d.opt)},null,8,["onClick"]),l(j,{color:"green",name:"edit",size:"26px",onClick:J=>o(d.opt)},null,8,["onClick"])]),_:2},1024)]),_:2},1040)]),_:1},8,["modelValue","options"]),l(j,{name:"add",size:"34px",color:"green",class:"col-2",onClick:a[7]||(a[7]=d=>v())})])]),_:1})]),_:1}),l(P(Ne)),P(y)?(Q(),L(ie,{key:0,modelValue:c.value.is_user,"onUpdate:modelValue":a[8]||(a[8]=d=>c.value.is_user=d),color:"green",label:c.value.is_user?"Пользователь":"Администратор",onClick:a[9]||(a[9]=d=>fe())},null,8,["modelValue","label"])):E("",!0)]),h.value?(Q(),L(Ue,{key:0,modelValue:h.value,"onUpdate:modelValue":a[10]||(a[10]=d=>h.value=d),newAddress:m.value,onRefresh:a[11]||(a[11]=d=>C())},null,8,["modelValue","newAddress"])):E("",!0)])}}});export{pt as default};
