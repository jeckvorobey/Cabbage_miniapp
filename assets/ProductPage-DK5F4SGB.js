import{Q as A,a as M}from"./QUploader-CkujlGcv.js";import{V as L,aj as E,W as T,r as k,h as W,L as d,M as r,Z as v,_ as s,$ as q,N as l,a1 as m,a8 as w,a4 as x,a5 as f,a9 as g,ab as V,S as I,ai as Z,ak as G}from"./index-B18Ac6EF.js";import{Q as H}from"./QSelect-BdPUccZx.js";import{Q as K}from"./QForm-Cx8R7Pi1.js";import{C as P}from"./ClosePopup-C-Nl1Atw.js";import{u as X}from"./use-quasar-D4ucj3x8.js";import{u as Y}from"./productsStore-DEKv8ZyC.js";import{P as Q}from"./ProductImgCarusel-CbvHnBCG.js";import{u as ee}from"./usePermissionVisibility.hook-BmGylBfj.js";import{u as te}from"./categoriesStore-QzI_2tJb.js";import{u as ae}from"./orderStore-5lgSJi3I.js";import{r as S}from"./useUtils-BNyv7Twq.js";import{_ as ie}from"./_plugin-vue_export-helper-DlAUqK2U.js";import"./format-CJebrXOQ.js";import"./QItem-8F67ppZ-.js";import"./QMenu-ci_7j2rq.js";import"./rtl-DFPa-2ov.js";const oe={class:"q-pa-md product"},se={key:0},le={class:"text-h6 q-mb-md"},ne={class:"text-center upload-title"},re={class:"row justify-end"},ue={key:1},de={class:"q-mb-sm"},me={key:0,class:"q-my-md"},ce={key:1,class:"text-grey old-price"},pe={key:2,class:"q-pa-md bg-light-gray radius-16"},ve={class:"row justify-end"},fe={key:1,class:"row"},ye={class:"bg-green q-pa-xs radius-100"},ge={class:"q-mx-sm self-center"},_e={class:"bg-green q-pa-xs radius-100"},be=L({__name:"ProductPage",emits:["refresh-data","add-product"],setup(ke,{emit:C}){const c=X(),N=C,h=E(),F=T(),y=Y(),R=te(),o=ae(),_=k(),{isManager:U}=ee(),e=k({id:null,name:"",price:null,category_id:null,unit_id:null,description:"",images:"",origin_country:"",unit:null}),u=k([]),n=new FormData;W(()=>{b()});function D(a,t){const i=typeof a.quantity=="string"?parseInt(a.quantity,10):Number(a.quantity)||1;if(t)a.quantity=i+1,window.localStorage.setItem("basket",JSON.stringify(o.basketData));else{if(i===1){const p=o.basketData.findIndex(j=>j.id===a.id);p!==-1&&o.basketData.splice(p,1),u.value=[],window.localStorage.setItem("basket",JSON.stringify(o.basketData));return}a.quantity=i-1,window.localStorage.setItem("basket",JSON.stringify(o.basketData))}}function B(a){try{c.loading.show();const t={...structuredClone(G(a)),quantity:1,product_id:a.id,price:typeof a.price=="string"?parseFloat(a.price):Number(a.price)||0};if(!o.basketData.length)o.basketData.push(t),u.value=o.basketData.find(i=>i.id===a.id);else{const i=o.basketData.find(p=>p.id===a.id);if(i){const p=typeof i.quantity=="string"?parseInt(i.quantity,10):Number(i.quantity)||0;i.quantity=p+1}else o.basketData.push(t)}window.localStorage.setItem("basket",JSON.stringify(o.basketData))}catch(t){console.error(t)}finally{c.loading.hide()}}async function O(){try{let a=null;e.value?.id?a=y.updateProduct(e.value):($(),a=await y.createProduct(n)),a&&(e.value.id=a.id,c.notify({message:"Успешно сохранено",color:"primary"}),N("refresh-data"),F.back())}catch(a){console.error(a)}}function $(){e?.value?.id&&n.append("id",e.value.id.toString()),e.value?.name&&n.append("name",e.value.name),e.value?.price&&n.append("price",e.value.price.toString()),e.value?.category_id&&n.append("category_id",e.value.category_id.toString()),e.value?.unit_id&&n.append("unit_id",e.value.unit_id.toString()),e.value?.qty&&n.append("qty",e.value.qty.toString()),e.value?.description&&n.append("description",e.value.description),e.value?.origin_country&&n.append("origin_country",e.value.origin_country)}function z(a){const t=new FileReader;t.readAsDataURL(a[0]),t.onload=()=>{},n.append("images",a[0]),e.value?.id&&J(a[0])}async function J(a){const t=new FormData;t.append("file",a),t.append("is_primary","true");try{await y.uploadFile(e.value.id,t)&&(b(),c.notify({message:"Картинка успешно добавлена",color:"primary"}))}catch(i){console.error(i)}finally{_.value&&_.value.reset()}}async function b(){if(h?.params?.id)try{c.loading.show();const a=await y.fetchProductsById(+h.params.id);a&&(e.value=a,e.value.id&&(u.value=o.basketData.find(t=>t.id===e.value.id)))}catch(a){console.error(a)}finally{c.loading.hide()}}return(a,t)=>(r(),d("div",oe,[v(U)?(r(),d("div",se,[s(K,{greedy:"",onSubmit:t[6]||(t[6]=i=>O())},{default:q(()=>[l("div",le,m(e.value.id?"Редактирование товара":"Добавление товара"),1),s(A,{ref_key:"uploaderRef",ref:_,color:"primary",flat:"","max-file-size":"15728640",onAdded:z},{header:q(()=>[...t[10]||(t[10]=[])]),list:q(()=>[s(M),l("div",ne,[s(w,{class:"q-mr-sm",name:"note_add",size:"24px"}),t[11]||(t[11]=l("span",null,"Загрузить картинку",-1))])]),_:1},512),l("div",null,[e.value?.images?.length?(r(),x(Q,{key:0,onRefreshData:t[0]||(t[0]=i=>b()),images:e.value.images},null,8,["images"])):f("",!0)]),s(g,{rules:[v(S)],modelValue:e.value.name,"onUpdate:modelValue":t[1]||(t[1]=i=>e.value.name=i),class:"q-mb-xs",outlined:"",label:"Наименование товара *"},null,8,["rules","modelValue"]),s(g,{rules:[v(S)],modelValue:e.value.price,"onUpdate:modelValue":t[2]||(t[2]=i=>e.value.price=i),class:"q-mb-xs",outlined:"",label:"Стоимость товара *"},null,8,["rules","modelValue"]),s(g,{modelValue:e.value.origin_country,"onUpdate:modelValue":t[3]||(t[3]=i=>e.value.origin_country=i),class:"q-mb-xs",outlined:"",label:"Страна происхождения"},null,8,["modelValue"]),s(H,{rules:[v(S)],modelValue:e.value.category_id,"onUpdate:modelValue":t[4]||(t[4]=i=>e.value.category_id=i),options:v(R).categories,class:"q-mb-xs",outlined:"",label:"Категория *","emit-value":"","map-options":"","option-label":"name","option-value":"id"},null,8,["rules","modelValue","options"]),s(g,{class:"q-mt-sm q-mb-sm",modelValue:e.value.description,"onUpdate:modelValue":t[5]||(t[5]=i=>e.value.description=i),outlined:"",type:"textarea",rows:"2",label:"Описание"},null,8,["modelValue"]),l("div",re,[V(s(I,{color:"green",label:"Подтвердить",type:"submit"},null,512),[[P]])])]),_:1})])):(r(),d("div",ue,[e.value?.images?.length?(r(),x(Q,{key:0,images:e.value.images},null,8,["images"])):f("",!0),l("div",de,[e.value?.name?(r(),d("h6",me,m(e.value.name),1)):f("",!0),e.value?.old_price?(r(),d("div",ce,m(e.value.old_price)+" ₽",1)):f("",!0),l("div",{class:Z(["text-bold text-18 q-mb-md",e.value?.old_price?"text-red":""])},m(e.value.price)+" ₽/ "+m(e.value.unit_name),3),e.value.description?(r(),d("div",pe,m(e.value.description),1)):f("",!0)]),l("div",ve,[u.value?.id?(r(),d("div",fe,[l("div",ye,[s(w,{name:"remove",color:"white",size:"30px",onClick:t[8]||(t[8]=i=>D(u.value,!1))})]),l("span",ge,m(u.value.quantity),1),l("div",_e,[s(w,{name:"add",color:"white",size:"30px",onClick:t[9]||(t[9]=i=>D(u.value,!0))})])])):V((r(),x(I,{key:0,color:"green",label:"Добавить в корзину",onClick:t[7]||(t[7]=i=>B(e.value))},null,512)),[[P]])])]))]))}}),$e=ie(be,[["__scopeId","data-v-c55ae7e2"]]);export{$e as default};
