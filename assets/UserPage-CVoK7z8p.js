import{Q as pe}from"./QImg-DrGxU8gn.js";import{V as Z,r as w,m as X,X as D,Y as P,ad as ve,Z as g,$ as o,a0 as le,a9 as W,aa as se,_,a6 as B,ab as oe,aq as ie,ac as ge,a7 as ye,Q as K,ar as z,f as F,B as O,q as N,M as be,h as Y,n as re,ai as we,as as he,w as T,u as _e,at as ee,au as xe,W as Ve,a1 as R,a4 as $,C,av as Se,a5 as ke}from"./index-DiXfJIYT.js";import{Q as Ae}from"./QBtnToggle-BZioMwsI.js";import{Q as Me,a as je,b as Ce}from"./QItem-vLP-u-yh.js";import{Q as ue}from"./QSelect-DxcGAxWt.js";import{u as de,g as Ie}from"./use-quasar-BJTL4EOP.js";import{Q as Oe}from"./QForm-CVjH9u2s.js";import{C as Pe}from"./ClosePopup-BeLyKk46.js";import{u as ce}from"./addressesStore-CS9f9IDU.js";import{u as Qe}from"./usersStore-BAQ_NZ5u.js";import{V as k,s as ze,i as te,t as q,c as ae}from"./vue-yandex-maps-kQ6ZWuE8.js";import{u as $e}from"./usePermissionVisibility.hook-C_Hk35IY.js";import"./QMenu-DZF8oO1p.js";import"./rtl-DFPa-2ov.js";import"./format-CJebrXOQ.js";const qe={class:"row q-pl-sm flex-center justify-between"},Ue={class:"text-grey-6"},Ye=Z({__name:"AddAddressModal",props:{newAddress:{}},emits:["refresh"],setup(e,{emit:l}){const i=e,a=l,u=de(),h=ce(),p=w(!0),x=w(),d=w({address_line:"",area_id:null,comment:"",is_default:!1}),y=w([]),b=w(!1),V=w("Начните вводить адрес..."),m=w(!1),A=[[36.95,55.85],[37.55,56.12]];async function S(s=2500){const t=Date.now();for(;Date.now()-t<s;){const r=globalThis.ymaps3,v=r?.suggest;if(typeof v=="function")return v.bind(r);await new Promise(M=>setTimeout(M,50))}return null}X(()=>{try{d.value=i.newAddress??{address_line:"",area_id:null,comment:"",is_default:!1},u.loading.show()}catch(s){console.error(s)}finally{a("refresh"),u.loading.hide()}});async function U(){if(d.value)try{await(d.value?.id?h.updateAddress:h.createAddress)(d.value),x.value?.hide()}catch(s){console.error(s)}}async function Q(s,t){try{const r=(s??"").trim();if(b.value=!0,!r){t(()=>{y.value=[],V.value="Начните вводить адрес..."});return}const v=await S();if(!v){t(()=>{y.value=[],V.value="Загружаем карты..."}),m.value||(m.value=!0,u.notify({message:"Карты загружаются, попробуйте ещё раз.",type:"warning"}));return}const M=await v({bounds:A,strictBounds:!0,text:r,types:["geo"]});t(()=>{y.value=M.map(j=>({subtitle:j.subtitle?.text??"",title:[j.title?.text,j.subtitle?.text].filter(Boolean).join(", ")})),V.value=!M.length&&r?"Адрес не найден":"Выберите адрес из списка"})}catch(r){console.error("Ошибка геокодирования:",r)}finally{b.value=!1}}return(s,t)=>(P(),D(ve,{ref_key:"dialogRef",ref:x,modelValue:p.value,"onUpdate:modelValue":t[4]||(t[4]=r=>p.value=r),persistent:""},{default:g(()=>[o(le,{class:""},{default:g(()=>[o(Oe,{greedy:"",onSubmit:t[3]||(t[3]=r=>U())},{default:g(()=>[d.value?(P(),D(se,{key:0},{default:g(()=>[t[5]||(t[5]=_("div",{class:"text-h6"},"Создание нового адреса доставки",-1)),o(ue,{modelValue:d.value.address_line,"onUpdate:modelValue":t[0]||(t[0]=r=>d.value.address_line=r),debounce:"800",class:"q-mb-sm",clearable:"",outlined:"",behavior:"menu","use-input":"","emit-value":"","map-options":"",options:y.value,"option-label":"title","option-value":"title",label:"Адрес доставки",onFilter:Q},{"no-option":g(()=>[_("div",qe,[_("div",Ue,B(V.value),1)])]),_:1},8,["modelValue","options"]),o(oe,{modelValue:d.value.comment,"onUpdate:modelValue":t[1]||(t[1]=r=>d.value.comment=r),label:"Комментарий",outlined:"",type:"textarea",rows:"3"},null,8,["modelValue"]),o(ie,{modelValue:d.value.is_default,"onUpdate:modelValue":t[2]||(t[2]=r=>d.value.is_default=r),label:"Активный аддрес"},null,8,["modelValue"])]),_:1})):W("",!0),o(ge,{align:"right"},{default:g(()=>[ye(o(K,{color:"red",flat:"",label:"Отмена"},null,512),[[Pe]]),o(K,{color:"primary",flat:"",label:"Сохранить",type:"submit"})]),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue"]))}}),G=e=>e instanceof Date,Te=e=>Object.keys(e).length===0,H=e=>e!=null&&typeof e=="object",ne=(e,...l)=>Object.prototype.hasOwnProperty.call(e,...l),E=e=>H(e)&&Te(e),Be=()=>Object.create(null),me=(e,l)=>{if(e===l)return{};if(!H(e)||!H(l))return l;const i=Object.keys(e).reduce((a,u)=>(ne(l,u)||(a[u]=void 0),a),Be());return G(e)||G(l)?e.valueOf()==l.valueOf()?{}:l:Object.keys(l).reduce((a,u)=>{if(!ne(e,u))return a[u]=l[u],a;const h=me(e[u],l[u]);return E(h)&&!G(h)&&(E(e[u])||!E(l[u]))||(a[u]=h),a},i)};function De(){re()||q({text:"injectMap must be only called on runtime.",isInternal:!0});const e=we("map");return(!e||!he(e))&&q({text:"Was not able to inject valid map in injectMap.",isInternal:!0}),e}async function Le({map:e,timeoutCallback:l,waitDuration:i}={}){!e&&!re()&&q({text:"onMapInit must be only called on runtime.",isInternal:!0}),typeof window>"u"&&q({text:"waitTillMapInit cannot be called on SSR.",isInternal:!0});const a=e||De();if(!a.value)return new Promise((u,h)=>{let p;i=typeof i<"u"?i:k.settings.value.mapsRenderWaitDuration,i!==!1&&(p=setTimeout(()=>{l?.(p,!0),h(new k.YandexMapException("Was not able to wait for map initialization in waitTillMapInit. You can change this behavior by using mapsRenderWaitDuration."))},typeof i=="number"?i:5e3),l?.(p,!1));let x;x=O(a,()=>{a.value&&(x?.(),p&&(clearTimeout(p),l?.(p,!0)),u())},{immediate:!0})})}const Ne=Z({name:"YandexMap",props:{modelValue:{type:Object,default:null},value:{type:Object,default:null},tag:{type:String,default:"div"},width:{type:String,default:"100%"},height:{type:String,default:"100%"},zIndex:{type:Number,default:0},settings:{type:Object,required:!0},readonlySettings:{type:Boolean,default:!1},realSettingsLocation:{type:Boolean,default:!1},layers:{type:Array,default:(()=>[])},cursorGrab:{type:Boolean,default:!1}},emits:{input(e){return!e||typeof ymaps3>"u"||e instanceof ymaps3.YMap},"update:modelValue"(e){return!e||typeof ymaps3>"u"||e instanceof ymaps3.YMap}},slots:Object,setup(e,{slots:l,emit:i}){const a=z(null),u=z(null),h=z([]),p=z(null),x=z(null),d=z(!1),y=w(0);T("map",a),T("layers",h),T("projection",p),T("needsToHold",y),i("input",null),i("update:modelValue",null);const b=F(()=>({...e.settings,projection:void 0})),V=async()=>{e.settings.location||q({text:"You must specify location in YandexMap settings"}),a.value&&a.value.destroy();const s=x.value;if(!s)return;const t=b.value;p.value&&(t.projection=p.value),a.value=new ymaps3.YMap(s,t,[...h.value,...e.layers]),i("input",a.value),i("update:modelValue",a.value)};let m,A,S=null;async function U(){await Le({map:a,timeoutCallback:(s,t)=>{t?S=null:S=s}}).catch(()=>{}),a.value&&(e.cursorGrab?(m=new ymaps3.YMapListener({onActionStart:s=>{s.type==="drag"&&e.cursorGrab&&u.value?.classList.add("__ymap--grabbing")},onActionEnd:s=>{s.type==="drag"&&u.value?.classList.remove("__ymap--grabbing")}}),a.value.addChild(m)):m&&a.value.removeChild(m))}let Q=!1;return O(k.loadStatus,async s=>{if(s==="pending"){Q=!0,d.value=!1;return}s!=="loaded"&&!Q||(d.value=!0,await N(),y.value&&await new Promise(t=>O(y,()=>{y.value||t()},{immediate:!0})),await V())}),X(async()=>{const s=()=>{A?.();let t=ae(b);A=O(b,r=>{if(!a.value)return;const v=ae(r);e.realSettingsLocation&&v.location&&("center"in v.location&&"center"in t.location?t.location.center=a.value.center:"bounds"in v.location&&"bounds"in t.location&&(t.location.bounds=a.value.bounds),"zoom"in v.location&&"zoom"in t.location&&(t.location.zoom=a.value.zoom));const M=Object.keys(me(t,v));if(M.length===0)return;const j={...v};for(const I in j)M.includes(I)||delete j[I];t=v,a.value?.update(j)},{deep:!0})};if(e.readonlySettings||s(),O(()=>e.readonlySettings,t=>{t?s():A?.()}),O(()=>e.cursorGrab,U,{immediate:!0}),await ze(),!k.isLoaded.value){if(k.settings.value.initializeOn==="onComponentMount")try{await te()}catch(t){console.error("An error occured while initializing Yandex Map with onComponentMount setting"),console.error(t);return}else(k.loadStatus.value==="loading"||k.settings.value.initializeOn==="onPluginInit")&&(k.settings.value.initializeOn==="onPluginInit"&&k.loadStatus.value!=="loading"&&await N(),await te());k.isLoaded.value||q({text:"You have set up <yandex-map> component without initializing Yandex maps. Please check initializeOn setting or call initYmaps manually before registering this component."})}d.value=!0,await N(),y.value&&await new Promise(t=>O(y,()=>{y.value||t()},{immediate:!0})),await V()}),be(()=>{S&&clearTimeout(S),a.value&&a.value.destroy(),a.value=null,i("input",a.value),i("update:modelValue",a.value)}),()=>{const s={class:["__ymap",{"__ymap--grab":e.cursorGrab}],ref:u,style:{width:e.width,height:e.height,"z-index":e.zIndex.toString()}},t=Y("div",{class:"__ymap_container",ref:x}),r={class:"__ymap_slots",style:{display:"none"}};return d.value?Y(e.tag,s,[t,Y("div",r,l.default?.({}))]):Y(e.tag,s,[t,Y("div",r)])}}}),Re={class:"q-pa-sm"},Ge={class:"justify-center row q-mb-md"},Ee={class:"text-h5 justify-between q-mb-sm row"},We={class:"items-center"},Fe={class:"items-center"},He={key:0,class:"row items-center q-mb-sm text-h6"},Ze={style:{height:"40px"},class:"col-10 content-center"},Xe={key:1,class:"row items-center q-mb-sm"},Je={class:"row items-center q-mb-sm"},pt=Z({__name:"UserPage",setup(e){const l=de(),i=ce(),a=Qe(),u=_e(),h=F(()=>ee.isActive),{isManagerWithoutIsUser:p}=$e(),x=xe({dark:"dark",light:"light"}),d=w(!1),y=F(()=>h.value?x.dark:x.light),b=w(!1),V=w("dark"),m=w({addres:null,full_name:"",mail:"",phone:""}),A=w(),S=w(null);X(()=>{m.value=u.user,I()});function U(f){f.is_default=!0,m.value.addres=f,r(f)}function Q(){S.value=null,b.value=!b.value}async function s(f){try{l.loading.show(),await i.deleteAddress(f.id)&&I()}catch(n){console.error(n)}finally{l.loading.hide()}}function t(f){S.value=f,b.value=!b.value}async function r(f){try{l.loading.show(),await i.updateAddress(f)&&I()}catch(n){console.error(n)}finally{l.loading.hide()}}const v=()=>{ee.toggle(),window.localStorage.setItem("theme",y.value)};function M(){l.dialog({cancel:!0,message:"Вы уверенны что хотите изменить номер?",persistent:!0,title:"Смена номера телефона"}).onOk(()=>{j()})}async function j(){m.value.phone=A.value;try{l.loading.show(),await a.updateMyPhone(m.value.phone)}catch(f){console.error(f)}finally{l.loading.hide()}}async function I(){try{l.loading.show();const f=await i.fetchAddresses();if(f){i.addresses=f;const n=f.find(L=>L.is_default===!0);n&&(i.addressId=n.id)}}catch(f){console.error(f)}finally{l.loading.hide()}}async function fe(){try{l.loading.show(),await a.updateUserMode(m.value.id)}catch(f){console.error(f)}finally{l.loading.hide()}}return(f,n)=>{const L=Ve("q-item-action");return P(),R("div",null,[n[12]||(n[12]=_("h6",{class:"text-center q-mb-md"},"Личный кабинет",-1)),_("div",Re,[o(le,{class:"my-card full-height",flat:"",bordered:""},{default:g(()=>[o(se,null,{default:g(()=>[_("div",Ge,[o(pe,{class:"radius-100",height:"120px",width:"120px",src:m.value?.main_image_url?m.value.main_image_url:$(Ie)("/card-shop.jpg")},null,8,["src"])]),_("div",Ee,[_("div",null,B(m.value.full_name),1),_("div",null,[o(Ae,{modelValue:V.value,"onUpdate:modelValue":n[0]||(n[0]=c=>V.value=c),size:"sm","no-caps":"",unelevated:"",dense:"","toggle-color":"grey-9",color:"white","text-color":"grey-9",options:[{value:"dark",slot:"dark",title:"Dark mode"},{value:"light",slot:"light",title:"Light mode"}],onClick:n[1]||(n[1]=c=>v())},{dark:g(()=>[_("div",We,[o(C,{name:"nightlight"})])]),light:g(()=>[_("div",Fe,[o(C,{name:"light_mode"})])]),_:1},8,["modelValue"])])]),!d.value&&m.value?.phone?(P(),R("div",He,[_("div",Ze,B(m.value.phone),1),o(C,{name:"edit",size:"30px",color:"green",class:"col-2",onClick:n[2]||(n[2]=c=>d.value=!d.value)})])):(P(),R("div",Xe,[o(C,{name:"close",size:"30px",color:"red",class:"col-1",onClick:n[3]||(n[3]=c=>d.value=!d.value)}),o(oe,{modelValue:A.value,"onUpdate:modelValue":n[4]||(n[4]=c=>A.value=c),class:"col-9",dense:"",outlined:"",label:"Телефон",mask:"+# (###) ###-##-##",type:"tel"},null,8,["modelValue"]),o(C,{name:"save",size:"30px",color:"green",class:"col-2",onClick:n[5]||(n[5]=c=>M())})])),_("div",Je,[o(ue,{modelValue:$(i).addressId,"onUpdate:modelValue":n[6]||(n[6]=c=>$(i).addressId=c),options:$(i).addresses,class:"col-10",dense:"",outlined:"",label:"Адрес","emit-value":"","map-options":"","option-label":"address_line","option-value":"id"},{option:g(c=>[o(Me,Se(c.itemProps,{class:"justify-between flex"}),{default:g(()=>[o(je,{onClick:J=>U(c.opt)},{default:g(()=>[o(Ce,null,{default:g(()=>[ke(B(c.opt?.address_line),1)]),_:2},1024)]),_:2},1032,["onClick"]),o(L,null,{default:g(()=>[o(C,{class:"q-mr-sm",color:"red",name:"delete",size:"26px",onClick:J=>s(c.opt)},null,8,["onClick"]),o(C,{color:"green",name:"edit",size:"26px",onClick:J=>t(c.opt)},null,8,["onClick"])]),_:2},1024)]),_:2},1040)]),_:1},8,["modelValue","options"]),o(C,{name:"add",size:"34px",color:"green",class:"col-2",onClick:n[7]||(n[7]=c=>Q())})])]),_:1})]),_:1}),o($(Ne)),$(p)?(P(),D(ie,{key:0,modelValue:m.value.is_user,"onUpdate:modelValue":n[8]||(n[8]=c=>m.value.is_user=c),color:"green",label:m.value.is_user?"Пользователь":"Администратор",onClick:n[9]||(n[9]=c=>fe())},null,8,["modelValue","label"])):W("",!0)]),b.value?(P(),D(Ye,{key:0,modelValue:b.value,"onUpdate:modelValue":n[10]||(n[10]=c=>b.value=c),newAddress:S.value,onRefresh:n[11]||(n[11]=c=>I())},null,8,["modelValue","newAddress"])):W("",!0)])}}});export{pt as default};
