import{Q as pe}from"./QImg-bKujzAPE.js";import{V as H,r as x,m as X,X as L,Y as Q,ad as ve,Z as g,$ as o,a0 as le,a9 as W,aa as se,_,a6 as B,ab as oe,aq as ie,ac as ge,a7 as ye,Q as K,ar as P,f as Z,B as O,q as R,M as be,h as U,n as re,ai as he,as as we,w as T,u as _e,at as ee,au as xe,W as Ve,a1 as D,a4 as z,C,av as Se,a5 as ke}from"./index-Cg_XczI2.js";import{Q as Ae}from"./QBtnToggle-AVmEruKi.js";import{Q as je,a as Me,b as Ce}from"./QItem-DhEKTULx.js";import{Q as ue}from"./QSelect-Coy6WfRI.js";import{u as de,g as Ie}from"./use-quasar-BCD9tSqh.js";import{Q as Oe}from"./QForm-CK8zxHlU.js";import{C as Qe}from"./ClosePopup-CTdCR1Nl.js";import{u as ce}from"./addressesStore-1zS_faGr.js";import{u as Pe}from"./usersStore-BB0d0RSZ.js";import{V as k,s as ze,i as te,t as $,c as ae}from"./vue-yandex-maps-tqaRE5W8.js";import{u as $e}from"./usePermissionVisibility.hook-DvAa_vpg.js";import"./QMenu-BaSTYR6g.js";import"./rtl-DFPa-2ov.js";import"./format-CJebrXOQ.js";const qe={class:"row q-pl-sm flex-center justify-between"},Ue={class:"text-grey-6"},Ye=H({__name:"AddAddressModal",props:{newAddress:{}},emits:["refresh"],setup(e,{emit:l}){const i=e,t=l,r=de(),p=ce(),v=x(!0),V=x(),u=x({address_line:"",area_id:null,comment:"",is_default:!1}),h=x([]),y=x(!1),A=x("Начните вводить адрес..."),c=[[36.95,55.85],[37.55,56.12]];X(async()=>{try{u.value=i.newAddress??{address_line:"",area_id:null,comment:"",is_default:!1},r.loading.show();const b=await p.fetchDeliveryZones();b&&(p.deliveryZones=b)}catch(b){console.error(b)}finally{t("refresh"),r.loading.hide()}});async function j(){if(u.value)try{await(u.value?.id?p.updateAddress:p.createAddress)(u.value),V.value?.hide()}catch(b){console.error(b)}}async function S(b,m){try{const n=(b??"").trim();if(y.value=!0,!n){m(()=>{h.value=[],A.value="Начните вводить адрес..."});return}const s=globalThis.ymaps3;if(!s||typeof s.suggest!="function"){r.notify({message:"Сервис карт недоступен.",type:"negative"});return}const M=await s.suggest({bounds:c,strictBounds:!0,text:n,types:["geo"]});m(()=>{h.value=M.map(w=>({subtitle:w.subtitle?.text??"",title:[w.title?.text,w.subtitle?.text].filter(Boolean).join(", ")})),A.value=!M.length&&n?"Адрес не найден":"Выберите адрес из списка"})}catch(n){console.error("Ошибка геокодирования:",n)}finally{y.value=!1}}return(b,m)=>(Q(),L(ve,{ref_key:"dialogRef",ref:V,modelValue:v.value,"onUpdate:modelValue":m[4]||(m[4]=n=>v.value=n),persistent:""},{default:g(()=>[o(le,{class:""},{default:g(()=>[o(Oe,{greedy:"",onSubmit:m[3]||(m[3]=n=>j())},{default:g(()=>[u.value?(Q(),L(se,{key:0},{default:g(()=>[m[5]||(m[5]=_("div",{class:"text-h6"},"Создание нового адреса доставки",-1)),o(ue,{modelValue:u.value.address_line,"onUpdate:modelValue":m[0]||(m[0]=n=>u.value.address_line=n),debounce:"800",class:"q-mb-sm",clearable:"",outlined:"",behavior:"menu","use-input":"","emit-value":"","map-options":"",options:h.value,"option-label":"title","option-value":"title",label:"Адрес доставки",onFilter:S},{"no-option":g(()=>[_("div",qe,[_("div",Ue,B(A.value),1)])]),_:1},8,["modelValue","options"]),o(oe,{modelValue:u.value.comment,"onUpdate:modelValue":m[1]||(m[1]=n=>u.value.comment=n),label:"Комментарий",outlined:"",type:"textarea",rows:"3"},null,8,["modelValue"]),o(ie,{modelValue:u.value.is_default,"onUpdate:modelValue":m[2]||(m[2]=n=>u.value.is_default=n),label:"Активный аддрес"},null,8,["modelValue"])]),_:1})):W("",!0),o(ge,{align:"right"},{default:g(()=>[ye(o(K,{color:"red",flat:"",label:"Отмена"},null,512),[[Qe]]),o(K,{color:"primary",flat:"",label:"Сохранить",type:"submit"})]),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue"]))}}),G=e=>e instanceof Date,Te=e=>Object.keys(e).length===0,F=e=>e!=null&&typeof e=="object",ne=(e,...l)=>Object.prototype.hasOwnProperty.call(e,...l),E=e=>F(e)&&Te(e),Be=()=>Object.create(null),me=(e,l)=>{if(e===l)return{};if(!F(e)||!F(l))return l;const i=Object.keys(e).reduce((t,r)=>(ne(l,r)||(t[r]=void 0),t),Be());return G(e)||G(l)?e.valueOf()==l.valueOf()?{}:l:Object.keys(l).reduce((t,r)=>{if(!ne(e,r))return t[r]=l[r],t;const p=me(e[r],l[r]);return E(p)&&!G(p)&&(E(e[r])||!E(l[r]))||(t[r]=p),t},i)};function Le(){re()||$({text:"injectMap must be only called on runtime.",isInternal:!0});const e=he("map");return(!e||!we(e))&&$({text:"Was not able to inject valid map in injectMap.",isInternal:!0}),e}async function Ne({map:e,timeoutCallback:l,waitDuration:i}={}){!e&&!re()&&$({text:"onMapInit must be only called on runtime.",isInternal:!0}),typeof window>"u"&&$({text:"waitTillMapInit cannot be called on SSR.",isInternal:!0});const t=e||Le();if(!t.value)return new Promise((r,p)=>{let v;i=typeof i<"u"?i:k.settings.value.mapsRenderWaitDuration,i!==!1&&(v=setTimeout(()=>{l?.(v,!0),p(new k.YandexMapException("Was not able to wait for map initialization in waitTillMapInit. You can change this behavior by using mapsRenderWaitDuration."))},typeof i=="number"?i:5e3),l?.(v,!1));let V;V=O(t,()=>{t.value&&(V?.(),v&&(clearTimeout(v),l?.(v,!0)),r())},{immediate:!0})})}const Re=H({name:"YandexMap",props:{modelValue:{type:Object,default:null},value:{type:Object,default:null},tag:{type:String,default:"div"},width:{type:String,default:"100%"},height:{type:String,default:"100%"},zIndex:{type:Number,default:0},settings:{type:Object,required:!0},readonlySettings:{type:Boolean,default:!1},realSettingsLocation:{type:Boolean,default:!1},layers:{type:Array,default:(()=>[])},cursorGrab:{type:Boolean,default:!1}},emits:{input(e){return!e||typeof ymaps3>"u"||e instanceof ymaps3.YMap},"update:modelValue"(e){return!e||typeof ymaps3>"u"||e instanceof ymaps3.YMap}},slots:Object,setup(e,{slots:l,emit:i}){const t=P(null),r=P(null),p=P([]),v=P(null),V=P(null),u=P(!1),h=x(0);T("map",t),T("layers",p),T("projection",v),T("needsToHold",h),i("input",null),i("update:modelValue",null);const y=Z(()=>({...e.settings,projection:void 0})),A=async()=>{e.settings.location||$({text:"You must specify location in YandexMap settings"}),t.value&&t.value.destroy();const n=V.value;if(!n)return;const s=y.value;v.value&&(s.projection=v.value),t.value=new ymaps3.YMap(n,s,[...p.value,...e.layers]),i("input",t.value),i("update:modelValue",t.value)};let c,j,S=null;async function b(){await Ne({map:t,timeoutCallback:(n,s)=>{s?S=null:S=n}}).catch(()=>{}),t.value&&(e.cursorGrab?(c=new ymaps3.YMapListener({onActionStart:n=>{n.type==="drag"&&e.cursorGrab&&r.value?.classList.add("__ymap--grabbing")},onActionEnd:n=>{n.type==="drag"&&r.value?.classList.remove("__ymap--grabbing")}}),t.value.addChild(c)):c&&t.value.removeChild(c))}let m=!1;return O(k.loadStatus,async n=>{if(n==="pending"){m=!0,u.value=!1;return}n!=="loaded"&&!m||(u.value=!0,await R(),h.value&&await new Promise(s=>O(h,()=>{h.value||s()},{immediate:!0})),await A())}),X(async()=>{const n=()=>{j?.();let s=ae(y);j=O(y,M=>{if(!t.value)return;const w=ae(M);e.realSettingsLocation&&w.location&&("center"in w.location&&"center"in s.location?s.location.center=t.value.center:"bounds"in w.location&&"bounds"in s.location&&(s.location.bounds=t.value.bounds),"zoom"in w.location&&"zoom"in s.location&&(s.location.zoom=t.value.zoom));const Y=Object.keys(me(s,w));if(Y.length===0)return;const q={...w};for(const I in q)Y.includes(I)||delete q[I];s=w,t.value?.update(q)},{deep:!0})};if(e.readonlySettings||n(),O(()=>e.readonlySettings,s=>{s?n():j?.()}),O(()=>e.cursorGrab,b,{immediate:!0}),await ze(),!k.isLoaded.value){if(k.settings.value.initializeOn==="onComponentMount")try{await te()}catch(s){console.error("An error occured while initializing Yandex Map with onComponentMount setting"),console.error(s);return}else(k.loadStatus.value==="loading"||k.settings.value.initializeOn==="onPluginInit")&&(k.settings.value.initializeOn==="onPluginInit"&&k.loadStatus.value!=="loading"&&await R(),await te());k.isLoaded.value||$({text:"You have set up <yandex-map> component without initializing Yandex maps. Please check initializeOn setting or call initYmaps manually before registering this component."})}u.value=!0,await R(),h.value&&await new Promise(s=>O(h,()=>{h.value||s()},{immediate:!0})),await A()}),be(()=>{S&&clearTimeout(S),t.value&&t.value.destroy(),t.value=null,i("input",t.value),i("update:modelValue",t.value)}),()=>{const n={class:["__ymap",{"__ymap--grab":e.cursorGrab}],ref:r,style:{width:e.width,height:e.height,"z-index":e.zIndex.toString()}},s=U("div",{class:"__ymap_container",ref:V}),M={class:"__ymap_slots",style:{display:"none"}};return u.value?U(e.tag,n,[s,U("div",M,l.default?.({}))]):U(e.tag,n,[s,U("div",M)])}}}),De={class:"q-pa-sm"},Ge={class:"justify-center row q-mb-md"},Ee={class:"text-h5 justify-between q-mb-sm row"},We={class:"items-center"},Ze={class:"items-center"},Fe={key:0,class:"row items-center q-mb-sm text-h6"},He={style:{height:"40px"},class:"col-10 content-center"},Xe={key:1,class:"row items-center q-mb-sm"},Je={class:"row items-center q-mb-sm"},pt=H({__name:"UserPage",setup(e){const l=de(),i=ce(),t=Pe(),r=_e(),p=Z(()=>ee.isActive),{isManagerWithoutIsUser:v}=$e(),V=xe({dark:"dark",light:"light"}),u=x(!1),h=Z(()=>p.value?V.dark:V.light),y=x(!1),A=x("dark"),c=x({addres:null,full_name:"",mail:"",phone:""}),j=x(),S=x(null);X(()=>{c.value=r.user,I()});function b(f){f.is_default=!0,c.value.addres=f,M(f)}function m(){S.value=null,y.value=!y.value}async function n(f){try{l.loading.show(),await i.deleteAddress(f.id)&&I()}catch(a){console.error(a)}finally{l.loading.hide()}}function s(f){S.value=f,y.value=!y.value}async function M(f){try{l.loading.show(),await i.updateAddress(f)&&I()}catch(a){console.error(a)}finally{l.loading.hide()}}const w=()=>{ee.toggle(),window.localStorage.setItem("theme",h.value)};function Y(){l.dialog({cancel:!0,message:"Вы уверенны что хотите изменить номер?",persistent:!0,title:"Смена номера телефона"}).onOk(()=>{q()})}async function q(){c.value.phone=j.value;try{l.loading.show(),await t.updateMyPhone(c.value.phone)}catch(f){console.error(f)}finally{l.loading.hide()}}async function I(){try{l.loading.show();const f=await i.fetchAddresses();if(f){i.addresses=f;const a=f.find(N=>N.is_default===!0);a&&(i.addressId=a.id)}}catch(f){console.error(f)}finally{l.loading.hide()}}async function fe(){try{l.loading.show(),await t.updateUserMode(c.value.id)}catch(f){console.error(f)}finally{l.loading.hide()}}return(f,a)=>{const N=Ve("q-item-action");return Q(),D("div",null,[a[12]||(a[12]=_("h6",{class:"text-center q-mb-md"},"Личный кабинет",-1)),_("div",De,[o(le,{class:"my-card full-height",flat:"",bordered:""},{default:g(()=>[o(se,null,{default:g(()=>[_("div",Ge,[o(pe,{class:"radius-100",height:"120px",width:"120px",src:c.value?.main_image_url?c.value.main_image_url:z(Ie)("/card-shop.jpg")},null,8,["src"])]),_("div",Ee,[_("div",null,B(c.value.full_name),1),_("div",null,[o(Ae,{modelValue:A.value,"onUpdate:modelValue":a[0]||(a[0]=d=>A.value=d),size:"sm","no-caps":"",unelevated:"",dense:"","toggle-color":"grey-9",color:"white","text-color":"grey-9",options:[{value:"dark",slot:"dark",title:"Dark mode"},{value:"light",slot:"light",title:"Light mode"}],onClick:a[1]||(a[1]=d=>w())},{dark:g(()=>[_("div",We,[o(C,{name:"nightlight"})])]),light:g(()=>[_("div",Ze,[o(C,{name:"light_mode"})])]),_:1},8,["modelValue"])])]),!u.value&&c.value?.phone?(Q(),D("div",Fe,[_("div",He,B(c.value.phone),1),o(C,{name:"edit",size:"30px",color:"green",class:"col-2",onClick:a[2]||(a[2]=d=>u.value=!u.value)})])):(Q(),D("div",Xe,[o(C,{name:"close",size:"30px",color:"red",class:"col-1",onClick:a[3]||(a[3]=d=>u.value=!u.value)}),o(oe,{modelValue:j.value,"onUpdate:modelValue":a[4]||(a[4]=d=>j.value=d),class:"col-9",dense:"",outlined:"",label:"Телефон",mask:"+# (###) ###-##-##",type:"tel"},null,8,["modelValue"]),o(C,{name:"save",size:"30px",color:"green",class:"col-2",onClick:a[5]||(a[5]=d=>Y())})])),_("div",Je,[o(ue,{modelValue:z(i).addressId,"onUpdate:modelValue":a[6]||(a[6]=d=>z(i).addressId=d),options:z(i).addresses,class:"col-10",dense:"",outlined:"",label:"Адрес","emit-value":"","map-options":"","option-label":"address_line","option-value":"id"},{option:g(d=>[o(je,Se(d.itemProps,{class:"justify-between flex"}),{default:g(()=>[o(Me,{onClick:J=>b(d.opt)},{default:g(()=>[o(Ce,null,{default:g(()=>[ke(B(d.opt?.address_line),1)]),_:2},1024)]),_:2},1032,["onClick"]),o(N,null,{default:g(()=>[o(C,{class:"q-mr-sm",color:"red",name:"delete",size:"26px",onClick:J=>n(d.opt)},null,8,["onClick"]),o(C,{color:"green",name:"edit",size:"26px",onClick:J=>s(d.opt)},null,8,["onClick"])]),_:2},1024)]),_:2},1040)]),_:1},8,["modelValue","options"]),o(C,{name:"add",size:"34px",color:"green",class:"col-2",onClick:a[7]||(a[7]=d=>m())})])]),_:1})]),_:1}),o(z(Re)),z(v)?(Q(),L(ie,{key:0,modelValue:c.value.is_user,"onUpdate:modelValue":a[8]||(a[8]=d=>c.value.is_user=d),color:"green",label:c.value.is_user?"Пользователь":"Администратор",onClick:a[9]||(a[9]=d=>fe())},null,8,["modelValue","label"])):W("",!0)]),y.value?(Q(),L(Ye,{key:0,modelValue:y.value,"onUpdate:modelValue":a[10]||(a[10]=d=>y.value=d),newAddress:S.value,onRefresh:a[11]||(a[11]=d=>I())},null,8,["modelValue","newAddress"])):W("",!0)])}}});export{pt as default};
